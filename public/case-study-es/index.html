<!DOCTYPE html>
<html lang="es" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Reload vs Upgrade: Un caso de estudio | NetWithAlex</title>
<meta name="keywords" content="">
<meta name="description" content="En este caso de estudio exploramos un comportamiento interesante observado al actualizar dispositivos mediante el SD-WAN Manager, el cual podría causar problemas de tráfico. También veremos cómo mitigar este riesgo usando BFD.">
<meta name="author" content="Alex">
<link rel="canonical" href="http://localhost:1313/case-study-es/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/assets/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/case-study-en/">
<link rel="alternate" hreflang="es" href="http://localhost:1313/case-study-es/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>















    
        <link rel="preconnect" href="https://plausible.io">
    
        <!-- Dev mode : We do not load plausible script to avoid bloating your stats -->

<!-- If you are using Content-Security-Policy, do not forget to add this code to your CSP : 
  script-src 'unsafe-inline' https://plausible.io
  connect-src 'unsafe-inline' https://plausible.io
  or just add the partial 'plausible_csp.html' to those 2 csp directives in your 'index.headers' file
-->



    
    <script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>
    <script>
         
         
         
    </script>

    

<link rel="stylesheet" href="/assets/css/custom.css">
<meta property="og:url" content="http://localhost:1313/case-study-es/">
  <meta property="og:site_name" content="NetWithAlex">
  <meta property="og:title" content="Reload vs Upgrade: Un caso de estudio">
  <meta property="og:description" content="En este caso de estudio exploramos un comportamiento interesante observado al actualizar dispositivos mediante el SD-WAN Manager, el cual podría causar problemas de tráfico. También veremos cómo mitigar este riesgo usando BFD.">
  <meta property="og:locale" content="es">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-08-01T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-08-01T00:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Reload vs Upgrade: Un caso de estudio">
<meta name="twitter:description" content="En este caso de estudio exploramos un comportamiento interesante observado al actualizar dispositivos mediante el SD-WAN Manager, el cual podría causar problemas de tráfico. También veremos cómo mitigar este riesgo usando BFD.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/es/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Reload vs Upgrade: Un caso de estudio",
      "item": "http://localhost:1313/case-study-es/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Reload vs Upgrade: Un caso de estudio",
  "name": "Reload vs Upgrade: Un caso de estudio",
  "description": "En este caso de estudio exploramos un comportamiento interesante observado al actualizar dispositivos mediante el SD-WAN Manager, el cual podría causar problemas de tráfico. También veremos cómo mitigar este riesgo usando BFD.",
  "keywords": [
    
  ],
  "articleBody": "Introducción La idea de escribir esta publicación surgió tras presenciar un comportamiento inesperado en cómo los routers SD-WAN manejan diferentes operaciones que provocan un reinicio del router. De hecho, esto se descubrió “por accidente” al realizar actualizaciones de software en un par de routers SD-WAN y no fue detectado durante pruebas de failover. En la publicación de hoy voy a comparar cómo se trata un reinicio usando el comando reload en comparación con uno provocado por una actualización de software.\nTopología Una configuración SD-WAN tradicional con doble router, corriendo BGP hacia un router externo en el lado del servicio que proporciona conectividad a otros sitios. Algo simple como esto:\nLa configuración de BGP es súper simple y suficiente para ejemplificar este comportamiento. Los routers SD-WAN tienen configuraciones idénticas.\nGateway#show run | s r b router bgp 64002 bgp log-neighbor-changes neighbor 172.16.1.1 remote-as 64001 neighbor 172.16.1.2 remote-as 64001 BR1-1#sh run | s r b router bgp 64001 bgp log-neighbor-changes ! address-family ipv4 vrf 1 network 172.16.2.0 mask 255.255.255.0 neighbor 172.16.1.15 remote-as 64002 neighbor 172.16.1.15 activate neighbor 172.16.1.15 send-community both distance bgp 20 200 20 exit-address-family A nivel de enrutamiento, el router Gateway tiene dos rutas disponibles para llegar al servidor web, ambas iguales y aprendidas por BGP. Con la configuración actual, el Gateway elige BR1-1 como ruta principal y BR1-2 queda como respaldo.\nGateway# sh ip route | b Gateway Gateway of last resort is not set 172.16.0.0/16 is variably subnetted, 3 subnets, 2 masks C 172.16.1.0/24 is directly connected, Ethernet0/0 L 172.16.1.15/32 is directly connected, Ethernet0/0 B 172.16.2.0/24 [20/1000] via 172.16.1.1, 02:48:02 Gateway# sh ip bgp BGP table version is 3, local router ID is 192.168.1.15 Status codes: s suppressed, d damped, h history, * valid, \u003e best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, t secondary path, L long-lived-stale, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path * 172.16.2.0/24 172.16.1.2 1000 0 64001 i *\u003e 172.16.1.1 1000 0 64001 i Comportamiento usando el comando reload Comencemos examinando qué hacen los routers SD-WAN al reiniciar con el comando reload. Reiniciaré BR1-1, ya que es el router primario.\n*18:08:35.380 UTC Wed Jul 30 2025 BR1-1#reload Proceed with reload? [confirm] Inicio un ping desde el router Gateway para verificar si la conectividad se ve afectada:\nGateway#sh clock *18:08:42.345 UTC Wed Jul 30 2025 Gateway#ping 172.16.2.2 rep 10000 Type escape sequence to abort. Sending 10000, 100-byte ICMP Echos to 172.16.2.2, timeout is 2 seconds: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! \u003c...\u003e !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! *Jul 30 18:09:01.490: %BGP-5-NBR_RESET: Neighbor 172.16.1.1 reset (Peer closed the session) *Jul 30 18:09:01.490: %BGP-5-ADJCHANGE: neighbor 172.16.1.1 Down Peer closed the session *Jul 30 18:09:01.490: %BGP_SESSION-5-ADJCHANGE: neighbor 172.16.1.1 IPv4 Unicast topology base removed from session Peer closed the session \u003c...\u003e !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Success rate is 100 percent (10000/10000), round-trip min/avg/max = 1/1/32 ms Gateway#sh ip route | b Gateway Gateway of last resort is not set 172.16.0.0/16 is variably subnetted, 3 subnets, 2 masks C 172.16.1.0/24 is directly connected, Ethernet0/0 L 172.16.1.15/32 is directly connected, Ethernet0/0 B 172.16.2.0/24 [20/1000] via 172.16.1.2, 00:02:42 Gateway#sh ip bgp all sum | b Nei Neighbor V AS MsgRcvd MsgSent TblVer InQ OutQ Up/Down State/PfxRcd 172.16.1.1 4 64001 0 0 1 0 0 00:00:19 Active 172.16.1.2 4 64001 193 197 4 0 0 02:51:15 1 We can see that the BGP session to BR1-1 was closed and the ping continued without issues through BR1-2.Podemos ver que la sesión BGP con BR1-1 se cerró y el ping continuó sin problemas a través de BR1-2.\nA nivel de paquetes, BR1-1 cerró la sesión BGP antes de reiniciar, evitando interrupciones.\nEste es el comportamiento esperado y cómo se hacen típicamente las pruebas de failover.\nComportamiento durante una actualización Ahora BR1-2 es la ruta primaria:\nBGP#sh ip route | b Gateway Gateway of last resort is not set 172.16.0.0/16 is variably subnetted, 3 subnets, 2 masks C 172.16.1.0/24 is directly connected, Ethernet0/0 L 172.16.1.15/32 is directly connected, Ethernet0/0 B 172.16.2.0/24 [20/1000] via 172.16.1.2, 00:28:48 Esta vez usaré el Manager para actualizar BR1-2.\nEl ping desde el router Gateway falla cuando BR1-2 se reinicia:\nGateway# ping 172.16.2.2 rep 1000000 Type escape sequence to abort. Sending 1000000, 100-byte ICMP Echos to 172.16.2.2, timeout is 2 seconds: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! !!!!!!!!!!!!!!!!!!!!!!!!!!............................................ Curiosamente, el vecino BGP sigue activo, y la ruta sigue apuntando a BR1-2 aunque ya no está disponible:\nGateway# sh ip route | b Gate Gateway of last resort is not set 172.16.0.0/16 is variably subnetted, 3 subnets, 2 masks C 172.16.1.0/24 is directly connected, Ethernet0/0 L 172.16.1.15/32 is directly connected, Ethernet0/0 B 172.16.2.0/24 [20/1000] via 172.16.1.2, 00:35:09 El tráfico queda en un blackhole durante el tiempo de espera de BGP:\nGateway# ping 172.16.2.2 rep 5 Type escape sequence to abort. Sending 10, 100-byte ICMP Echos to 172.16.2.2, timeout is 2 seconds: ..... *Jul 30 15:17:10.575: %BGP-3-NOTIFICATION: sent to neighbor 172.16.1.2 4/0 (hold time expired) 0 bytes!!!!! Success rate is 50 percent (5/10), round-trip min/avg/max = 1/1/2 ms *Jul 30 15:17:10.575: %BGP-5-NBR_RESET: Neighbor 172.16.1.2 reset (BGP Notification sent) *Jul 30 15:17:10.575: %BGP-5-ADJCHANGE: neighbor 172.16.1.2 Down BGP Notification sent *Jul 30 15:17:10.575: %BGP_SESSION-5-ADJCHANGE: neighbor 172.16.1.2 IPv4 Unicast topology base removed from session BGP Notification sent Gateway#ping 172.16.2.2 rep 5 Type escape sequence to abort. Sending 5, 100-byte ICMP Echos to 172.16.2.2, timeout is 2 seconds: !!!!! Success rate is 100 percent (5/5), round-trip min/avg/max = 1/2/3 ms Conceptos erróneos comunes Un error común en operaciones de red es asumir que todos los tipos de reinicio se comportan igual. Es fácil pensar que si el reinicio se da por CLI, por algun power cycle o una actualización de software, el resultado será consistente: BGP se cae, se quitan rutas y se hace el failover. Este estudio demuestra lo contrario.\nEn Cisco SD-WAN, un reinicio por actualización desde el Manager no cierra las sesiones de control como BGP. A diferencia del comando reload, no se envía un FIN de TCP que cierra la sesión de manera correcta. El reinicio por actualización de software se salta este paso, manteniendo la sesión “viva” aunque el router vecino este abajo.\nEste comportamiento sutil rara vez está documentado, y se prueba aún con menos frecuencia. Muchos ingenieros confían únicamente en pruebas de reinicio o flapeo de interfaces para validar el comportamiento ante fallos. Como resultado, pueden creer que su configuración es resiliente, cuando en realidad es vulnerable a ciertos workflows de actualización.\nSer consciente de esta diferencia es clave para diseñar una red más robusta y predecible.\nAnálisis Al inspeccionar los logs del Manager vemos que se envía el siguiente comand de netconf hacia BR1-2.\n30-Jul-2025 19:34:51,103 UTC INFO [6a486f9b-e3d8-42f7-982b-89701bfeab58] [Manager01] [ChangePartitionActionProcessor] (device-action-change_partition-1) || Change partition request XML change_partition-fc8b8de6-5f34-470d-b8a0-40e0f6513686%C8K-D4CE7174-5261-7E6F-91EA-4926BCF4C2DD%1800000 17.15.03a.0.176 El comando equivalente en SD-WAN es:\nrequest platform software sdwan activate Por lo tanto, no es una comparación directa, pero naturalmente se esperaría un cierre limpio de la sesión BGP como cuando se usa el comando reload.\nSolución Para evitar este comportamiento, debemos usar BFD enlazado con BGP:\nPara configurarlo en los equipo de SD-WAN se hace por CLI Add-on\nLa configuración en el Gateway:\nbfd-template single-hop t1 interval min-tx 250 min-rx 250 multiplier 3 interface eth0/0 bfd template t1 router bgp 64002 bgp log-neighbor-changes neighbor 172.16.1.1 remote-as 64001 neighbor 172.16.1.1 fall-over bfd neighbor 172.16.1.2 remote-as 64001 neighbor 172.16.1.2 fall-over bfd Con esto, BGP detectará el fallo en menos de un segundo, previniendo ese blackhole del tráfico.\nAl probarlo, solo se pierde un ping:\nGateway#ping 172.16.2.2 rep 10000000 Type escape sequence to abort. Sending 10000000, 100-byte ICMP Echos to 172.16.2.2, timeout is 2 seconds: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! *Aug 1 09:50:08.876: %BFDFSM-6-BFD_SESS_DOWN: BFD-SYSLOG: BFD session ld:1 handle:1,is going Down Reason: DETECT TIMER EXPIRED *Aug 1 09:50:08.876: %BGP-5-NBR_RESET: Neighbor 172.16.1.2 reset (BFD adjacency down) *Aug 1 09:50:08.876: %BGP-5-ADJCHANGE: neighbor 172.16.1.2 Down BFD adjacency down *Aug 1 09:50:08.876: %BGP_SESSION-5-ADJCHANGE: neighbor 172.16.1.2 IPv4 Unicast topology base removed from session BFD adjacency down.!!!! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! *Aug 1 09:50:08.876: %BFD-6-BFD_SESS_DESTROYED: BFD-SYSLOG: bfd_session_destroyed, ld:1 neigh proc:BGP, idb:Ethernet0/0 handle:1 active!!!!!!!!!!!!!!!!!!!!!!!!! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! \u003c...\u003e Success rate is 99 percent (22877/22878), round-trip min/avg/max = 1/1/70 ms Resumen: CLI vs Manager Here’s a quick comparison of what happens when a router reloads via CLI vs when it’s upgraded through the SD-WAN Manager:\nComportamiento Reinicio por CLI(reload) Actualización via Manager Manejo sesión de BGP Sesión cerrada con TCP FIN Sesión permanece activa hasta llegar al hold time Retiro de rutas Inmediato Retrasado (hasta llegar al BGP hold timer) Impacto en el tráfico Mínimo Alto (blackhole) Cubierto en pruebas típicas Sí No siempre ¿Puede mitigarse con BFD? Opcional Altamente recomendado Convergencia sin BFD) sub-segundo Minutos Convergencia con BFD) sub-segundo Sub-segundo Esta tabla resalta por qué BFD no es solo “algo bueno de tener”, sino una parte crítica en las implementaciones de SD-WAN.\nConclusion Este caso de estudio revela un aspecto importante y frecuentemente pasado por alto del comportamiento ante fallos en Cisco SD-WAN: no todos los reinicios son tratados por igual. Mientras que un reinicio manual termina limpiamente las sesiones BGP, provocando un redireccionamiento inmediato, una actualización iniciada desde el SD-WAN Manager no siempre envía señales a los protocolos de control antes de apagarse. Esta diferencia sutil puede causar pérdida de tráfico (blackhole) durante toda la duración del hold timer de BGP.\nAquí es donde BFD se vuelve un aliado clave. Al reducir los tiempos de detección de fallos de minutos a sub-segundos, BFD asegura que los protocolos de enrutamiento puedan adaptarse rápidamente, incluso en casos donde el router no cierra adecuadamente las sesiones. Asociar BFD a las sesiones BGP es una forma simple y efectiva de reforzar tu topología frente a estos comportamientos.\nAdemás, este comportamiento no se limita solo a actualizaciones de software. También puedes encontrar problemas similares en otros escenarios de “fallo silencioso”, por ejemplo:\nUn corte de fibra entre pares que no genera una caída directa de la interfaz. Fallos indirectos dentro del transporte o la infraestructura de switching. Un cambio de route processor (RP). Entonces, ¿cuál es la lección principal? No asumas que el comportamiento por CLI refleja todos los escenarios. Siempre prueba el failover usando los métodos reales que se usan en producción—ya sea una actualización de software o una tarea iniciada desde el Manager. Y como recomendación final: despliega siempre BFD. Es una inversión pequeña con un gran retorno.\n¡Nos vemos en el próximo!\n",
  "wordCount" : "1735",
  "inLanguage": "es",
  "datePublished": "2025-08-01T00:00:00Z",
  "dateModified": "2025-08-01T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Alex"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/case-study-es/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "NetWithAlex",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/assets/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/es/" accesskey="h" title="NetWithAlex (Alt + H)">NetWithAlex</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="http://localhost:1313/" title="English"
                            aria-label="English">En</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/es/" title="Inicio">
                    <span>Inicio</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/es/archives/" title="Archivo">
                    <span>Archivo</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/es/category/" title="Categorías">
                    <span>Categorías</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/es/sobre-mi/" title="Sobre mí">
                    <span>Sobre mí</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/es/search/" title="🔍">
                    <span>🔍</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/es/">Inicio</a>&nbsp;»&nbsp;<a href="http://localhost:1313/es/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Reload vs Upgrade: Un caso de estudio
    </h1>
    <div class="post-description">
      En este caso de estudio exploramos un comportamiento interesante observado al actualizar dispositivos mediante el SD-WAN Manager, el cual podría causar problemas de tráfico. También veremos cómo mitigar este riesgo usando BFD.
    </div>
    <div class="post-meta"><span title='2025-08-01 00:00:00 +0000 +0000'>agosto 1, 2025</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;Alex&nbsp;|&nbsp;Traducciones:
<ul class="i18n_list">
    <li>
        <a href="http://localhost:1313/case-study-en/">En</a>
    </li>
</ul>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Tabla de Contenidos</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#introducci%c3%b3n" aria-label="Introducción">Introducción</a></li>
                <li>
                    <a href="#topolog%c3%ada" aria-label="Topología">Topología</a></li>
                <li>
                    <a href="#comportamiento-usando-el-comando-reload" aria-label="Comportamiento usando el comando reload">Comportamiento usando el comando reload</a></li>
                <li>
                    <a href="#comportamiento-durante-una-actualizaci%c3%b3n" aria-label="Comportamiento durante una actualización">Comportamiento durante una actualización</a></li>
                <li>
                    <a href="#conceptos-err%c3%b3neos-comunes" aria-label="Conceptos erróneos comunes">Conceptos erróneos comunes</a></li>
                <li>
                    <a href="#an%c3%a1lisis" aria-label="Análisis">Análisis</a></li>
                <li>
                    <a href="#soluci%c3%b3n" aria-label="Solución">Solución</a></li>
                <li>
                    <a href="#resumen-cli-vs-manager" aria-label="Resumen: CLI vs Manager">Resumen: CLI vs Manager</a></li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="introducción">Introducción<a hidden class="anchor" aria-hidden="true" href="#introducción">#</a></h2>
<p>La idea de escribir esta publicación surgió tras presenciar un comportamiento inesperado en cómo los routers SD-WAN manejan diferentes operaciones que provocan un reinicio del router. De hecho, esto se descubrió &ldquo;por accidente&rdquo; al realizar actualizaciones de software en un par de routers SD-WAN y <strong>no fue detectado durante pruebas de failover</strong>. En la publicación de hoy voy a comparar cómo se trata un reinicio usando el comando <code>reload</code> en comparación con uno provocado por una actualización de software.</p>
<h2 id="topología">Topología<a hidden class="anchor" aria-hidden="true" href="#topología">#</a></h2>
<p>Una configuración SD-WAN tradicional con doble router, corriendo BGP hacia un router externo en el lado del servicio que proporciona conectividad a otros sitios. Algo simple como esto:</p>
<p><img loading="lazy" src="/wp-content/uploads/2025/07/cs-1.png"></p>
<p>La configuración de BGP es súper simple y suficiente para ejemplificar este comportamiento. Los routers SD-WAN tienen configuraciones idénticas.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Gateway#show run | s r b
</span></span><span style="display:flex;"><span>router bgp 64002
</span></span><span style="display:flex;"><span> bgp log-neighbor-changes
</span></span><span style="display:flex;"><span> neighbor 172.16.1.1 remote-as 64001
</span></span><span style="display:flex;"><span> neighbor 172.16.1.2 remote-as 64001
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BR1-1#sh run | s r b
</span></span><span style="display:flex;"><span>router bgp 64001
</span></span><span style="display:flex;"><span> bgp log-neighbor-changes
</span></span><span style="display:flex;"><span> !
</span></span><span style="display:flex;"><span> address-family ipv4 vrf 1
</span></span><span style="display:flex;"><span>  network 172.16.2.0 mask 255.255.255.0
</span></span><span style="display:flex;"><span>  neighbor 172.16.1.15 remote-as 64002
</span></span><span style="display:flex;"><span>  neighbor 172.16.1.15 activate
</span></span><span style="display:flex;"><span>  neighbor 172.16.1.15 send-community both
</span></span><span style="display:flex;"><span>  distance bgp 20 200 20
</span></span><span style="display:flex;"><span> exit-address-family
</span></span></code></pre></div><p>A nivel de enrutamiento, el router Gateway tiene dos rutas disponibles para llegar al servidor web, ambas iguales y aprendidas por BGP. Con la configuración actual, el Gateway elige BR1-1 como ruta principal y BR1-2 queda como respaldo.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>Gateway<span style="color:#75715e"># sh ip route | b Gateway</span>
</span></span><span style="display:flex;"><span>Gateway of last resort is <span style="color:#f92672">not</span> set
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">16</span> is variably subnetted, <span style="color:#ae81ff">3</span> subnets, <span style="color:#ae81ff">2</span> masks
</span></span><span style="display:flex;"><span>C        <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">24</span> is directly connected, Ethernet0<span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>L        <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.15</span><span style="color:#f92672">/</span><span style="color:#ae81ff">32</span> is directly connected, Ethernet0<span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>B        <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">2.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">24</span> [<span style="color:#ae81ff">20</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1000</span>] via <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.1</span>, <span style="color:#ae81ff">02</span>:<span style="color:#ae81ff">48</span>:<span style="color:#ae81ff">02</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Gateway<span style="color:#75715e"># sh ip bgp                 </span>
</span></span><span style="display:flex;"><span>BGP table version is <span style="color:#ae81ff">3</span>, local router ID is <span style="color:#ae81ff">192.168</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.15</span>
</span></span><span style="display:flex;"><span>Status codes: s suppressed, d damped, h history, <span style="color:#f92672">*</span> valid, <span style="color:#f92672">&gt;</span> best, i <span style="color:#f92672">-</span> internal, 
</span></span><span style="display:flex;"><span>              r RIB<span style="color:#f92672">-</span>failure, S Stale, m multipath, b backup<span style="color:#f92672">-</span>path, f RT<span style="color:#f92672">-</span>Filter, 
</span></span><span style="display:flex;"><span>              x best<span style="color:#f92672">-</span>external, a additional<span style="color:#f92672">-</span>path, c RIB<span style="color:#f92672">-</span>compressed, 
</span></span><span style="display:flex;"><span>              t secondary path, L long<span style="color:#f92672">-</span>lived<span style="color:#f92672">-</span>stale,
</span></span><span style="display:flex;"><span>Origin codes: i <span style="color:#f92672">-</span> IGP, e <span style="color:#f92672">-</span> EGP, <span style="color:#960050;background-color:#1e0010">?</span> <span style="color:#f92672">-</span> incomplete
</span></span><span style="display:flex;"><span>RPKI validation codes: V valid, I invalid, N Not found
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     Network          Next Hop            Metric LocPrf Weight <span style="color:#a6e22e">Path</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">*</span>    <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">2.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">24</span>    <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.2</span>            <span style="color:#ae81ff">1000</span>             <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">64001</span> i
</span></span><span style="display:flex;"><span> <span style="color:#f92672">*&gt;</span>                    <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.1</span>            <span style="color:#ae81ff">1000</span>             <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">64001</span> i
</span></span></code></pre></div><h2 id="comportamiento-usando-el-comando-reload">Comportamiento usando el comando <code>reload</code><a hidden class="anchor" aria-hidden="true" href="#comportamiento-usando-el-comando-reload">#</a></h2>
<p>Comencemos examinando qué hacen los routers SD-WAN al reiniciar con el comando <code>reload</code>. Reiniciaré BR1-1, ya que es el router primario.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#f92672">*</span><span style="color:#ae81ff">18</span>:<span style="color:#ae81ff">08</span>:<span style="color:#ae81ff">35.380</span> UTC Wed Jul <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">2025</span>
</span></span><span style="display:flex;"><span>BR1<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#75715e">#reload  </span>
</span></span><span style="display:flex;"><span>Proceed with reload<span style="color:#960050;background-color:#1e0010">?</span> [confirm]
</span></span></code></pre></div><p>Inicio un ping desde el router Gateway para verificar si la conectividad se ve afectada:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>Gateway<span style="color:#75715e">#sh clock                  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span><span style="color:#ae81ff">18</span>:<span style="color:#ae81ff">08</span>:<span style="color:#ae81ff">42.345</span> UTC Wed Jul <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">2025</span>
</span></span><span style="display:flex;"><span>Gateway<span style="color:#75715e">#ping 172.16.2.2 rep 10000 </span>
</span></span><span style="display:flex;"><span>Type escape sequence to abort<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>Sending <span style="color:#ae81ff">10000</span>, <span style="color:#ae81ff">100</span><span style="color:#f92672">-</span>byte ICMP Echos to <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">2.2</span>, timeout is <span style="color:#ae81ff">2</span> seconds:
</span></span><span style="display:flex;"><span><span style="color:#f92672">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;...&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>Jul <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">18</span>:<span style="color:#ae81ff">09</span>:<span style="color:#ae81ff">01.490</span>: <span style="color:#f92672">%</span>BGP<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span><span style="color:#f92672">-</span>NBR_RESET: Neighbor <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.1</span> reset (Peer closed the session)
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>Jul <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">18</span>:<span style="color:#ae81ff">09</span>:<span style="color:#ae81ff">01.490</span>: <span style="color:#f92672">%</span>BGP<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span><span style="color:#f92672">-</span>ADJCHANGE: neighbor <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.1</span> Down Peer closed the session
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>Jul <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">18</span>:<span style="color:#ae81ff">09</span>:<span style="color:#ae81ff">01.490</span>: <span style="color:#f92672">%</span>BGP_SESSION<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span><span style="color:#f92672">-</span>ADJCHANGE: neighbor <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.1</span> IPv4 Unicast topology base removed from session  Peer closed the session
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;...&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
</span></span><span style="display:flex;"><span>Success rate is <span style="color:#ae81ff">100</span> percent (<span style="color:#ae81ff">10000</span><span style="color:#f92672">/</span><span style="color:#ae81ff">10000</span>), round<span style="color:#f92672">-</span>trip min<span style="color:#f92672">/</span>avg<span style="color:#f92672">/</span>max <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">32</span> ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Gateway<span style="color:#75715e">#sh ip route | b Gateway</span>
</span></span><span style="display:flex;"><span>Gateway of last resort is <span style="color:#f92672">not</span> set
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">16</span> is variably subnetted, <span style="color:#ae81ff">3</span> subnets, <span style="color:#ae81ff">2</span> masks
</span></span><span style="display:flex;"><span>C        <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">24</span> is directly connected, Ethernet0<span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>L        <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.15</span><span style="color:#f92672">/</span><span style="color:#ae81ff">32</span> is directly connected, Ethernet0<span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>B        <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">2.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">24</span> [<span style="color:#ae81ff">20</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1000</span>] via <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.2</span>, <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">02</span>:<span style="color:#ae81ff">42</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Gateway<span style="color:#75715e">#sh ip bgp all sum | b Nei</span>
</span></span><span style="display:flex;"><span>Neighbor        V           AS MsgRcvd MsgSent   TblVer  InQ OutQ Up<span style="color:#f92672">/</span>Down  State<span style="color:#f92672">/</span>PfxRcd
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.1</span>      <span style="color:#ae81ff">4</span>        <span style="color:#ae81ff">64001</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>        <span style="color:#ae81ff">1</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">19</span> Active
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.2</span>      <span style="color:#ae81ff">4</span>        <span style="color:#ae81ff">64001</span>     <span style="color:#ae81ff">193</span>     <span style="color:#ae81ff">197</span>        <span style="color:#ae81ff">4</span>    <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">02</span>:<span style="color:#ae81ff">51</span>:<span style="color:#ae81ff">15</span>        <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>We can see that the BGP session to BR1-1 was closed and the ping continued without issues through BR1-2.Podemos ver que la sesión BGP con BR1-1 se cerró y el ping continuó sin problemas a través de BR1-2.</p>
<p>A nivel de paquetes, BR1-1 cerró la sesión BGP antes de reiniciar, evitando interrupciones.</p>
<p><img loading="lazy" src="/wp-content/uploads/2025/07/cs-2.png"></p>
<p>Este es el comportamiento esperado y cómo se hacen típicamente las pruebas de failover.</p>
<h2 id="comportamiento-durante-una-actualización">Comportamiento durante una actualización<a hidden class="anchor" aria-hidden="true" href="#comportamiento-durante-una-actualización">#</a></h2>
<p>Ahora BR1-2 es la ruta primaria:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>BGP<span style="color:#75715e">#sh ip route | b Gateway</span>
</span></span><span style="display:flex;"><span>Gateway of last resort is <span style="color:#f92672">not</span> set
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">16</span> is variably subnetted, <span style="color:#ae81ff">3</span> subnets, <span style="color:#ae81ff">2</span> masks
</span></span><span style="display:flex;"><span>C        <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">24</span> is directly connected, Ethernet0<span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>L        <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.15</span><span style="color:#f92672">/</span><span style="color:#ae81ff">32</span> is directly connected, Ethernet0<span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>B        <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">2.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">24</span> [<span style="color:#ae81ff">20</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1000</span>] via <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.2</span>, <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">28</span>:<span style="color:#ae81ff">48</span>
</span></span></code></pre></div><p>Esta vez usaré el Manager para actualizar BR1-2.</p>
<p><img loading="lazy" src="/wp-content/uploads/2025/07/cs-3.png"></p>
<p>El ping desde el router Gateway falla cuando BR1-2 se reinicia:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Gateway# ping 172.16.2.2 rep 1000000
</span></span><span style="display:flex;"><span>Type escape sequence to abort.
</span></span><span style="display:flex;"><span>Sending 1000000, 100-byte ICMP Echos to 172.16.2.2, timeout is 2 seconds:
</span></span><span style="display:flex;"><span>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span><span style="display:flex;"><span>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span><span style="display:flex;"><span>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span><span style="display:flex;"><span>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span><span style="display:flex;"><span>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span><span style="display:flex;"><span>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span><span style="display:flex;"><span>!!!!!!!!!!!!!!!!!!!!!!!!!!............................................
</span></span></code></pre></div><p>Curiosamente, el vecino BGP sigue activo, y la ruta sigue apuntando a BR1-2 aunque ya no está disponible:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>Gateway<span style="color:#75715e"># sh ip route | b Gate</span>
</span></span><span style="display:flex;"><span>Gateway of last resort is <span style="color:#f92672">not</span> set
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">16</span> is variably subnetted, <span style="color:#ae81ff">3</span> subnets, <span style="color:#ae81ff">2</span> masks
</span></span><span style="display:flex;"><span>C        <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">24</span> is directly connected, Ethernet0<span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>L        <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.15</span><span style="color:#f92672">/</span><span style="color:#ae81ff">32</span> is directly connected, Ethernet0<span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>B        <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">2.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">24</span> [<span style="color:#ae81ff">20</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1000</span>] via <span style="color:#ae81ff">172.16</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.2</span>, <span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">35</span>:<span style="color:#ae81ff">09</span>
</span></span></code></pre></div><p>El tráfico queda en un blackhole durante el tiempo de espera de BGP:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Gateway# ping 172.16.2.2 rep 5
</span></span><span style="display:flex;"><span>Type escape sequence to abort.
</span></span><span style="display:flex;"><span>Sending 10, 100-byte ICMP Echos to 172.16.2.2, timeout is 2 seconds:
</span></span><span style="display:flex;"><span>.....
</span></span><span style="display:flex;"><span>*Jul 30 15:17:10.575: %BGP-3-NOTIFICATION: sent to neighbor 172.16.1.2 4/0 (hold time expired) 0 bytes!!!!!
</span></span><span style="display:flex;"><span>Success rate is 50 percent (5/10), round-trip min/avg/max = 1/1/2 ms
</span></span><span style="display:flex;"><span>*Jul 30 15:17:10.575: %BGP-5-NBR_RESET: Neighbor 172.16.1.2 reset (BGP Notification sent)
</span></span><span style="display:flex;"><span>*Jul 30 15:17:10.575: %BGP-5-ADJCHANGE: neighbor 172.16.1.2 Down BGP Notification sent
</span></span><span style="display:flex;"><span>*Jul 30 15:17:10.575: %BGP_SESSION-5-ADJCHANGE: neighbor 172.16.1.2 IPv4 Unicast topology base removed from session  BGP Notification sent
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Gateway#ping 172.16.2.2 rep 5
</span></span><span style="display:flex;"><span>Type escape sequence to abort.
</span></span><span style="display:flex;"><span>Sending 5, 100-byte ICMP Echos to 172.16.2.2, timeout is 2 seconds:
</span></span><span style="display:flex;"><span>!!!!!
</span></span><span style="display:flex;"><span>Success rate is 100 percent (5/5), round-trip min/avg/max = 1/2/3 ms
</span></span></code></pre></div><h2 id="conceptos-erróneos-comunes">Conceptos erróneos comunes<a hidden class="anchor" aria-hidden="true" href="#conceptos-erróneos-comunes">#</a></h2>
<p>Un error común en operaciones de red es asumir que todos los tipos de reinicio se comportan igual. Es fácil pensar que si el reinicio se da por CLI, por algun power cycle o una actualización de software, el resultado será consistente: BGP se cae, se quitan rutas y se hace el failover. Este estudio demuestra lo contrario.</p>
<p>En Cisco SD-WAN, un reinicio por actualización desde el Manager no cierra las sesiones de control como BGP. A diferencia del comando <code>reload</code>, no se envía un FIN de TCP que cierra la sesión de manera correcta. El reinicio por actualización de software se salta este paso, manteniendo la sesión &ldquo;viva&rdquo; aunque el router vecino este abajo.</p>
<p>Este comportamiento sutil rara vez está documentado, y se prueba aún con menos frecuencia. Muchos ingenieros confían únicamente en pruebas de reinicio o flapeo de interfaces para validar el comportamiento ante fallos. Como resultado, pueden creer que su configuración es resiliente, cuando en realidad es vulnerable a ciertos workflows de actualización.</p>
<p>Ser consciente de esta diferencia es clave para diseñar una red más robusta y predecible.</p>
<h2 id="análisis">Análisis<a hidden class="anchor" aria-hidden="true" href="#análisis">#</a></h2>
<p>Al inspeccionar los logs del Manager vemos que se envía el siguiente comand de netconf hacia BR1-2.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>30-Jul-2025 19:34:51,103 UTC INFO  [6a486f9b-e3d8-42f7-982b-89701bfeab58] [Manager01] [ChangePartitionActionProcessor] (device-action-change_partition-1) || Change partition request XML &lt;activate xmlns=&#34;http://cisco.com/ns/yang/Cisco-IOS-XE-install-rpc&#34;&gt;
</span></span><span style="display:flex;"><span>  &lt;uuid xmlns=&#34;http://cisco.com/ns/yang/Cisco-IOS-XE-install-rpc&#34;&gt;change_partition-fc8b8de6-5f34-470d-b8a0-40e0f6513686%C8K-D4CE7174-5261-7E6F-91EA-4926BCF4C2DD%1800000&lt;/uuid&gt;
</span></span><span style="display:flex;"><span>  &lt;version xmlns=&#34;http://cisco.com/ns/yang/Cisco-IOS-XE-install-rpc&#34;&gt;17.15.03a.0.176&lt;/version&gt;
</span></span><span style="display:flex;"><span>&lt;/activate&gt;
</span></span></code></pre></div><p>El comando equivalente en SD-WAN es:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>request platform software sdwan activate &lt;version&gt;
</span></span></code></pre></div><p>Por lo tanto, no es una comparación directa, pero naturalmente se esperaría un cierre limpio de la sesión BGP como cuando se usa el comando <code>reload</code>.</p>
<h2 id="solución">Solución<a hidden class="anchor" aria-hidden="true" href="#solución">#</a></h2>
<p>Para evitar este comportamiento, debemos usar BFD enlazado con BGP:</p>
<p>Para configurarlo en los equipo de SD-WAN se hace por CLI Add-on</p>
<p><img loading="lazy" src="/wp-content/uploads/2025/07/cs-4.png"></p>
<p>La configuración en el Gateway:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>bfd-template single-hop t1
</span></span><span style="display:flex;"><span> interval min-tx 250 min-rx 250 multiplier 3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>interface eth0/0
</span></span><span style="display:flex;"><span> bfd template t1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>router bgp 64002
</span></span><span style="display:flex;"><span> bgp log-neighbor-changes
</span></span><span style="display:flex;"><span> neighbor 172.16.1.1 remote-as 64001
</span></span><span style="display:flex;"><span> neighbor 172.16.1.1 fall-over bfd
</span></span><span style="display:flex;"><span> neighbor 172.16.1.2 remote-as 64001
</span></span><span style="display:flex;"><span> neighbor 172.16.1.2 fall-over bfd
</span></span></code></pre></div><p>Con esto, BGP detectará el fallo en menos de un segundo, previniendo ese blackhole del tráfico.</p>
<p>Al probarlo, solo se pierde un ping:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Gateway#ping 172.16.2.2 rep 10000000
</span></span><span style="display:flex;"><span>Type escape sequence to abort.
</span></span><span style="display:flex;"><span>Sending 10000000, 100-byte ICMP Echos to 172.16.2.2, timeout is 2 seconds:
</span></span><span style="display:flex;"><span>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span><span style="display:flex;"><span>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span><span style="display:flex;"><span>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span><span style="display:flex;"><span>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span><span style="display:flex;"><span>*Aug  1 09:50:08.876: %BFDFSM-6-BFD_SESS_DOWN: BFD-SYSLOG: BFD session ld:1 handle:1,is going Down Reason: DETECT TIMER EXPIRED
</span></span><span style="display:flex;"><span>*Aug  1 09:50:08.876: %BGP-5-NBR_RESET: Neighbor 172.16.1.2 reset (BFD adjacency down)
</span></span><span style="display:flex;"><span>*Aug  1 09:50:08.876: %BGP-5-ADJCHANGE: neighbor 172.16.1.2 Down BFD adjacency down
</span></span><span style="display:flex;"><span>*Aug  1 09:50:08.876: %BGP_SESSION-5-ADJCHANGE: neighbor 172.16.1.2 IPv4 Unicast topology base removed from session  BFD adjacency down.!!!!
</span></span><span style="display:flex;"><span>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span><span style="display:flex;"><span>*Aug  1 09:50:08.876: %BFD-6-BFD_SESS_DESTROYED: BFD-SYSLOG: bfd_session_destroyed,  ld:1 neigh proc:BGP, idb:Ethernet0/0 handle:1 active!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span><span style="display:flex;"><span>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</span></span><span style="display:flex;"><span>&lt;...&gt;
</span></span><span style="display:flex;"><span>Success rate is 99 percent (22877/22878), round-trip min/avg/max = 1/1/70 ms
</span></span></code></pre></div><h2 id="resumen-cli-vs-manager">Resumen: CLI vs Manager<a hidden class="anchor" aria-hidden="true" href="#resumen-cli-vs-manager">#</a></h2>
<p>Here’s a quick comparison of what happens when a router reloads via CLI vs when it’s upgraded through the SD-WAN Manager:</p>
<table>
  <thead>
      <tr>
          <th>Comportamiento</th>
          <th>Reinicio por CLI(<code>reload</code>)</th>
          <th>Actualización via Manager</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Manejo sesión de BGP</td>
          <td>Sesión cerrada con TCP FIN</td>
          <td>Sesión permanece activa hasta llegar al hold time</td>
      </tr>
      <tr>
          <td>Retiro de rutas</td>
          <td>Inmediato</td>
          <td>Retrasado (hasta llegar al BGP hold timer)</td>
      </tr>
      <tr>
          <td>Impacto en el tráfico</td>
          <td>Mínimo</td>
          <td>Alto (blackhole)</td>
      </tr>
      <tr>
          <td>Cubierto en pruebas típicas</td>
          <td>Sí</td>
          <td>No siempre</td>
      </tr>
      <tr>
          <td>¿Puede mitigarse con BFD?</td>
          <td>Opcional</td>
          <td>Altamente recomendado</td>
      </tr>
      <tr>
          <td>Convergencia sin BFD)</td>
          <td>sub-segundo</td>
          <td>Minutos</td>
      </tr>
      <tr>
          <td>Convergencia con BFD)</td>
          <td>sub-segundo</td>
          <td>Sub-segundo</td>
      </tr>
  </tbody>
</table>
<p>Esta tabla resalta por qué BFD no es solo <em>“algo bueno de tener”</em>, sino una parte crítica en las implementaciones de SD-WAN.</p>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>Este caso de estudio revela un aspecto importante y frecuentemente pasado por alto del comportamiento ante fallos en Cisco SD-WAN: <strong>no todos los reinicios son tratados por igual.</strong> Mientras que un reinicio manual termina limpiamente las sesiones BGP, provocando un redireccionamiento inmediato, una actualización iniciada desde el SD-WAN Manager no siempre envía señales a los protocolos de control antes de apagarse. Esta diferencia sutil puede causar pérdida de tráfico (blackhole) durante toda la duración del hold timer de BGP.</p>
<p>Aquí es donde BFD se vuelve un aliado clave. Al reducir los tiempos de detección de fallos de minutos a sub-segundos, BFD asegura que los protocolos de enrutamiento puedan adaptarse rápidamente, incluso en casos donde el router no cierra adecuadamente las sesiones. Asociar BFD a las sesiones BGP es una forma simple y efectiva de reforzar tu topología frente a estos comportamientos.</p>
<p>Además, este comportamiento no se limita solo a actualizaciones de software. También puedes encontrar problemas similares en otros escenarios de “fallo silencioso”, por ejemplo:</p>
<ul>
<li>Un corte de fibra entre pares que no genera una caída directa de la interfaz.</li>
<li>Fallos indirectos dentro del transporte o la infraestructura de switching.</li>
<li>Un cambio de route processor (RP).</li>
</ul>
<p>Entonces, ¿cuál es la lección principal? <strong>No asumas que el comportamiento por CLI refleja todos los escenarios.</strong> Siempre prueba el failover usando los métodos <em>reales</em> que se usan en producción—ya sea una actualización de software o una tarea iniciada desde el Manager. Y como recomendación final: despliega siempre BFD. Es una inversión pequeña con un gran retorno.</p>
<p>¡Nos vemos en el próximo!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer><script src="https://utteranc.es/client.js"
        repo="aruiz-p/netwithalex"
        issue-term="title"
        label="comments"
        theme="preferred-color-scheme"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/es/">NetWithAlex</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copiar';

        function copyingDone() {
            copybutton.innerHTML = '¡copiado!';
            setTimeout(() => {
                copybutton.innerHTML = 'copiar';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
