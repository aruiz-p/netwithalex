<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Cisco SD-WAN On-Prem ZTP: Automating Router Onboarding | NetWithAlex</title>
<meta name="keywords" content="">
<meta name="description" content="Plug and Play (PnP) lets you onboard SD-WAN devices automatically via Cisco Cloud. This post explains how to achieve zero-touch provisioning (ZTP) in an airgapped, on-premises environment.">
<meta name="author" content="Alex">
<link rel="canonical" href="http://localhost:1313/ztp-on-prem-en/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/assets/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/ztp-on-prem-en/">
<link rel="alternate" hreflang="es" href="http://localhost:1313/ztp-on-prem-es/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>















    
        <link rel="preconnect" href="https://plausible.io">
    
        <!-- Dev mode : We do not load plausible script to avoid bloating your stats -->

<!-- If you are using Content-Security-Policy, do not forget to add this code to your CSP : 
  script-src 'unsafe-inline' https://plausible.io
  connect-src 'unsafe-inline' https://plausible.io
  or just add the partial 'plausible_csp.html' to those 2 csp directives in your 'index.headers' file
-->



    
    <script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>
    <script>
         
         
         
    </script>

    
<meta property="og:url" content="http://localhost:1313/ztp-on-prem-en/">
  <meta property="og:site_name" content="NetWithAlex">
  <meta property="og:title" content="Cisco SD-WAN On-Prem ZTP: Automating Router Onboarding">
  <meta property="og:description" content="Plug and Play (PnP) lets you onboard SD-WAN devices automatically via Cisco Cloud. This post explains how to achieve zero-touch provisioning (ZTP) in an airgapped, on-premises environment.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-05-05T14:20:31+00:00">
    <meta property="article:modified_time" content="2025-05-05T14:20:31+00:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Cisco SD-WAN On-Prem ZTP: Automating Router Onboarding">
<meta name="twitter:description" content="Plug and Play (PnP) lets you onboard SD-WAN devices automatically via Cisco Cloud. This post explains how to achieve zero-touch provisioning (ZTP) in an airgapped, on-premises environment.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Cisco SD-WAN On-Prem ZTP: Automating Router Onboarding",
      "item": "http://localhost:1313/ztp-on-prem-en/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Cisco SD-WAN On-Prem ZTP: Automating Router Onboarding",
  "name": "Cisco SD-WAN On-Prem ZTP: Automating Router Onboarding",
  "description": "Plug and Play (PnP) lets you onboard SD-WAN devices automatically via Cisco Cloud. This post explains how to achieve zero-touch provisioning (ZTP) in an airgapped, on-premises environment.",
  "keywords": [
    
  ],
  "articleBody": "Introduction When deploying a new remote site you want the process to be as easy as possible. You don‚Äôt want to ship the device to an intermediate location just to preload a configuration, only to ship it again to the final destination. You also don‚Äôt want to travel onsite yourself, connect a console cable, and manually configure each device. Now multiply that effort by dozens or hundreds of sites ü§Ø\nTo solve this challenge, Cisco created an automated onboarding process called Plug and Play (PnP) or Zero Touch provisioning (ZTP). The idea is simple: a router powers on, obtains an IP address, locates its SD-WAN overlay, connects to the controllers, and downloads its configuration‚Äîall without human intervention beyond plugging it in.\nA key step in this process is helping the router discover the SD-WAN overlay. This can be achieved via the Cisco Cloud or, in air-gapped environments, by hosting your own On-Prem ZTP Server. Today we are going to explore the second option.\nPnP/ZTP operation The following happens when the router boots up with no configuration:\nNote this process is available for hardware devices only.\nThe ZTP domain is defined on the DHCP server, for example, if the domain name is cisco.com, the router will try to resolve ztp.cisco.com. For more information you can check Cisco‚Äôs documentation\nConfiguration We need to complete the following tasks to make this work.\nAdd and configure ZTP server Upload device list to ZTP server Prepare device configuration on vManage Configure DHCP and DNS servers Trigger PnP process Add and configure ZTP Server The ZTP server uses the same image as a regular Validator. Follow the usual process to bring up a new VM with connectivity to the Manager.\nThe following is the minimum configuration needed:\nvbond# show run system system host-name ztp-server system-ip 10.10.10.194 site-id 5 sp-organization-name SDWAN-LAB123 organization-name SDWAN-LAB123 vbond 192.168.200.2 local ztp-server vpn 0 interface eth0 ip dhcp-client ipv6 dhcp-client no shutdown ! interface ge0/0 ip address 192.168.200.3/24 no shutdown ! ip route 0.0.0.0/0 192.168.200.253 ! Notice the ztp-server suffix, this will indicate the device to act as a ZTP server\nFrom the Manager, add the ZTP server to the Controller list:\nDepending on the Controller Authentication method, generate and sign the CSR.\nIf you are using Enterprise Certificates, you will need to install the root certificate and the signed certificate.\nFor example:\nztp-server# request root-cert-chain install home/admin/root-ca.crt ztp-server# request certificate install home/admin/ztp.crt Note The ZTP server doesn‚Äôt have any control connections to the Manager or any other controller.\nUpload device list to ZTP server Now that the ZTP server is installed, we need to provide the device list that will connect with the ZTP server.\nThe easiest way is to get the serialFile.viptela from the PnP portal and copy it locally.\nztp-server:~$ ls -l | grep serial -rw-r--r-- 1 admin admin 2364 Apr 24 21:41 serialFile.viptela then execute\nztp-server# request device-upload chassis-file home/admin/serialFile.viptela Uploading chassis numbers via VPN 0 Copying ... /home/admin/serialFile.viptela via VPN 0 file: /tmp/tmp.CbUWf8GnSN/viptela_serial_file PnP Verifying public key received from PnP against production root cert is_public_key_ok against production root ca: OK Signature verified for viptela_serial_file final file: /tmp/tmp.CbUWf8GnSN/viptela_serial_file Signature verification Suceeded. Success: Serial file is /tmp/tmp.CbUWf8GnSN/viptela_serial_file INFO: Input File specified was '/usr/share/viptela/chassis_numbers.tmp' INFO: # of complete chassis entries written: 12 Json to CSV conversion succeeded! Successfully loaded the chassis numbers file to the database. To verify the list:\nztp-server# show ztp entries ROOT VBOND ORGANIZATION CERT INDEX CHASSIS NUMBER SERIAL NUMBER VALIDITY VBOND IP PORT NAME PATH ----------------------------------------------------------------------------------------------------------------------------------------------------------- ... 23 ASR1001-HX-XXXXXXXXXXX XXXXXXXX valid 192.168.200.1 12346 SDWAN-LAB123 default Prepare device configuration on vManage To get this done I will use a configuration group, but it can be done with templates too.\nI create the device configuration and push it. The task is scheduled as device is offline.\nConfigure DHCP and DNS servers To make it simple I use an intermediate switch as my DHCP and DNS Server with the following configuration:\nip dhcp pool ASR vrf MPLS network 192.168.11.4 255.255.255.252 default-router 192.168.11.6 dns-server 192.168.11.6 domain-name cisco.com ip host vrf MPLS ztp.cisco.com 192.168.200.3 ip host vrf MPLS devicehelper.cisco.com 192.168.200.3 Ok, we are all set to see it in action\nTrigger PnP process To trigger the PnP process the device has to have blank configuration. I will use the following command to reset the config and trigger the process.\nRouter#request platform software sdwan config reset %WARNING: Bootstrap file doesn't exist and absence of it can cause loss of connectivity to the controller. For saving bootstrap config, use: request platform software sdwan bootstrap-config save Proceed to reset anyway? [confirm] Backup of running config is saved under /bootflash/sdwan/backup.cfg Config reset requested from a console session. Waiting for up to 60 seconds for IOS to initiate reload or report failure. IOS return status: \"cfgreset_proceed\" Config reset is raised successfully, device will reload shortly. You need console access to see the following logs:\nDevice boots and PnP discovery start.\n*May 4 04:18:42.659: %PNP-6-PNP_DISCOVERY_STARTED: PnP Discovery started The router gets an ip address, default router, domain name and dns server.\nAutoinstall trying DHCPv4 on GigabitEthernet0/0/0,GigabitEthernet0/0/1,GigabitEthernet0/0/2,GigabitEthernet0 ... *May 4 04:19:44.999: %PKI-2-NON_AUTHORITATIVE_CLOCK: PKI functions can not be initialized until an authoritative time source, like NTP, can be obtained. Acquired IPv4 address 192.168.11.5 on Interface GigabitEthernet0/0/1 Received following DHCPv4 options: domain-name : cisco.com dns-server-ip : 192.168.11.6 Device tries to resolve domains and gets redirected to ztp.cisco.com\n*May 4 04:20:08.694: %PNP-3-PNP_CCO_SERVER_IP_UNRESOLVED: CCO server (devicehelper.cisco.com.) can't be resolved (1/5) by (pid=619, pname=PnP Agent Discovery, time=04:20:08 UTC Sun May 4 2025) ... *May 4 04:20:20.696: %IOSXE_SDWAN_CONFIG-5-PNP_REDIRECT: PnP Redirect Msg: Org name \"\" Host \"ztp.cisco.com.\" port 0 intf GigabitEthernet0/0/1 *May 4 04:20:42.010: %PNP-6-PNP_REDIRECTION_DONE: PnP Redirection done (1) by (pid=619, pname=PnP Agent Discovery) *May 4 04:20:42.010: %PNP-6-PNP_SDWAN_STARTED: PnP SDWAN started (1) via (pnp-sdwan-vbond-ztp-discovery) by (pid=619, pname=PnP Agent Discovery) *May 4 04:20:42.811: %PNP-6-PNP_DISCOVERY_DONE: PnP Discovery done successfully (PnP-VBOND-ONPREM-ZTP-IPV4) profile (pnp-zero-touch) We can confirm ztp.cisco.com was resolved\nASR1K-2#show pnp trace | i ztp [05/04/25 04:20:10.695 UTC B7 619] 1: VBOND_ONPRIME_ZTP hostname ztp.cisco.com. resolved to 192.168.11.6 on interface GigabitEthernet0/0/1 [05/04/25 04:20:10.695 UTC B8 619] host_name is ztp.cisco.com. vbond_ipv4_address is 192.168.11.6, interface is GigabitEthernet0/0/1 Next, the router connects to the ZTP-Server and gets redirected the Validator\n*May 4 04:21:17.991: %Cisco-SDWAN-Router-vdaemon-6-INFO-1400002: Notification: 5/4/2025 4:21:17 control-connection-state-change severity-level:major host-name:\"Router\" system-ip::: personality:vedge peer-type:vbond peer-system-ip::: peer-vmanage-system-ip:0.0.0.0 public-ip:192.168.200.3 public-port:12346 src-color:default remote-color:default uptime:\"0:00:00:00\" new-state:up ... *May 4 04:21:19.242: %Cisco-SDWAN-Router-vdaemon-6-INFO-1400002: Notification: 5/4/2025 4:21:19 org-name-change severity-level:minor host-name:\"Router\" system-ip::: old-organization-name:\"\" new-organization-name:\"SDWAN-LAB123\" *May 4 04:21:21.597: %Cisco-SDWAN-Router-vdaemon-6-INFO-1400002: Notification: 5/4/2025 4:21:21 control-connection-state-change severity-level:major host-name:\"Router\" system-ip::: personality:vedge peer-type:vbond peer-system-ip::: peer-vmanage-system-ip:0.0.0.0 public-ip:192.168.200.1 public-port:12346 src-color:default remote-color:default uptime:\"0:00:00:00\" new-state:up Eventually, the device connected to the Manager and Controller and pulls the configuration\n*May 4 04:21:23.924: %Cisco-SDWAN-Router-vdaemon-6-INFO-1400002: Notification: 5/4/2025 4:21:23 control-connection-state-change severity-level:major host-name:\"Router\" system-ip::: personality:vedge peer-type:vmanage peer-system-ip:10.10.10.2 peer-vmanage-system-ip:0.0.0.0 public-ip:192.168.100.1 public-port:12746 src-color:default remote-color:biz-internet uptime:\"0:00:00:00\" new-state:up *May 4 04:21:24.299: %Cisco-SDWAN-CSS-SDWAN-POD1-ASR1K-2-OMPD-5-NTCE-400003: Operational state changed to UP *May 4 04:21:43.981: %DMI-5-AUTH_PASSED: R0/0: dmiauthd: User 'vmanage-admin' authenticated successfully from 10.10.10.2:42962 for netconf over ssh. ASR1K-2#show sdwan control connections | i up vsmart dtls 10.10.10.3 5 1 192.168.100.2 12346 192.168.100.2 12346 SDWAN-LAB123 mpls No up 0:02:02:51 0 vbond dtls 0.0.0.0 0 0 192.168.200.1 12346 192.168.200.1 12346 SDWAN-LAB123 mpls - up 0:02:02:54 0 vmanage dtls 10.10.10.2 5 0 192.168.100.1 12946 192.168.100.1 12946 SDWAN-LAB123 mpls No up 0:02:02:49 0 Conclusion On-Prem ZTP server extends the ability to onboard hardware devices to those network where internet access is restricted.\nAutomating router onboarding with On-Prem ZTP provides a great alternative for organizations that need full control over their provisioning process or operate in air-gapped environments. By replicating the Plug and Play process locally, you eliminate the need for manual configuration at remote sites while keeping sensitive environments isolated.\nWith the right setup, onboarding new sites becomes an easy and repetable process that will save precious time, reduce human error and scales SD-WAN deployments.\nüëâ Interested in setting up On-Prem ZTP for your network? Leave a comment or reach out, I‚Äôd love to help or answer your questions!\n",
  "wordCount" : "1301",
  "inLanguage": "en",
  "datePublished": "2025-05-05T14:20:31Z",
  "dateModified": "2025-05-05T14:20:31Z",
  "author":{
    "@type": "Person",
    "name": "Alex"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/ztp-on-prem-en/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "NetWithAlex",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/assets/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="NetWithAlex (Alt + H)">NetWithAlex</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="http://localhost:1313/es/" title="Espa√±ol"
                            aria-label="Espa√±ol">Es</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/category/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="About me.">
                    <span>About me.</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="üîç">
                    <span>üîç</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;¬ª&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Cisco SD-WAN On-Prem ZTP: Automating Router Onboarding
    </h1>
    <div class="post-description">
      Plug and Play (PnP) lets you onboard SD-WAN devices automatically via Cisco Cloud. This post explains how to achieve zero-touch provisioning (ZTP) in an airgapped, on-premises environment.
    </div>
    <div class="post-meta"><span title='2025-05-05 14:20:31 +0000 +0000'>May 5, 2025</span>&nbsp;¬∑&nbsp;7 min&nbsp;¬∑&nbsp;Alex&nbsp;|&nbsp;Translations:
<ul class="i18n_list">
    <li>
        <a href="http://localhost:1313/ztp-on-prem-es/">Es</a>
    </li>
</ul>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#introduction" aria-label="Introduction">Introduction</a></li>
                <li>
                    <a href="#pnpztp-operation" aria-label="PnP/ZTP operation">PnP/ZTP operation</a></li>
                <li>
                    <a href="#configuration" aria-label="Configuration">Configuration</a><ul>
                        
                <li>
                    <a href="#add-and-configure-ztp-server" aria-label="Add and configure ZTP Server">Add and configure ZTP Server</a></li>
                <li>
                    <a href="#upload-device-list-to-ztp-server" aria-label="Upload device list to ZTP server">Upload device list to ZTP server</a></li>
                <li>
                    <a href="#prepare-device-configuration-on-vmanage" aria-label="Prepare device configuration on vManage">Prepare device configuration on vManage</a></li>
                <li>
                    <a href="#configure-dhcp-and-dns-servers" aria-label="Configure DHCP and DNS servers">Configure DHCP and DNS servers</a></li>
                <li>
                    <a href="#trigger-pnp-process" aria-label="Trigger PnP process">Trigger PnP process</a></li></ul>
                </li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h2>
<p>When deploying a new remote site you want the process to be as easy as possible. You don‚Äôt want to ship the device to an intermediate location just to preload a configuration, only to ship it again to the final destination. You also don‚Äôt want to travel onsite yourself, connect a console cable, and manually configure each device. Now multiply that effort by dozens or hundreds of sites ü§Ø</p>
<p>To solve this challenge, Cisco created an automated onboarding process called Plug and Play (<strong>PnP</strong>) or Zero Touch provisioning (<strong>ZTP</strong>). The idea is simple: a router powers on, obtains an IP address, locates its SD-WAN overlay, connects to the controllers, and downloads its configuration‚Äîall without human intervention beyond plugging it in.</p>
<p>A key step in this process is helping the router discover the SD-WAN overlay. This can be achieved via the Cisco Cloud or, in air-gapped environments, by hosting your <strong>own On-Prem ZTP Server</strong>. Today we are going to explore the second option.</p>
<h2 id="pnpztp-operation">PnP/ZTP operation<a hidden class="anchor" aria-hidden="true" href="#pnpztp-operation">#</a></h2>
<p>The following happens when the router boots up with no configuration:</p>
<p><img loading="lazy" src="/wp-content/uploads/2025/05/ztp5.png"></p>
<p><strong>Note</strong> this process is available for <strong>hardware devices</strong> only.</p>
<p>The ZTP domain is defined on the DHCP server, for example, if the domain name is <strong><em>cisco.com</em></strong>, the router will try to resolve ztp.<strong><em>cisco.com</em></strong>. For more information you can check <a href="https://www.cisco.com/c/en/us/td/docs/routers/sdwan/configuration/sdwan-xe-gs-book/cisco-sd-wan-overlay-network-bringup.html#c_Start_the_Enterprise_ZTP_Server_7841.xml" target="_blank" rel="nofollow noopener noreferrer">Cisco&rsquo;s documentation</a></p>
<h2 id="configuration">Configuration<a hidden class="anchor" aria-hidden="true" href="#configuration">#</a></h2>
<p>We need to complete the following tasks to make this work.</p>
<ol>
<li>Add and configure ZTP server</li>
<li>Upload device list to ZTP server</li>
<li>Prepare device configuration on vManage</li>
<li>Configure DHCP and DNS servers</li>
<li>Trigger PnP process</li>
</ol>
<h3 id="add-and-configure-ztp-server">Add and configure ZTP Server<a hidden class="anchor" aria-hidden="true" href="#add-and-configure-ztp-server">#</a></h3>
<p>The ZTP server uses the same image as a regular Validator. Follow the usual process to bring up a new VM with connectivity to the Manager.</p>
<p>The following is the minimum configuration needed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>vbond# show run system
</span></span><span style="display:flex;"><span>system
</span></span><span style="display:flex;"><span> host-name               ztp-server
</span></span><span style="display:flex;"><span> system-ip               10.10.10.194
</span></span><span style="display:flex;"><span> site-id                 5
</span></span><span style="display:flex;"><span> sp-organization-name    SDWAN-LAB123
</span></span><span style="display:flex;"><span> organization-name       SDWAN-LAB123
</span></span><span style="display:flex;"><span> vbond 192.168.200.2 local ztp-server 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vpn 0
</span></span><span style="display:flex;"><span> interface eth0
</span></span><span style="display:flex;"><span>  ip dhcp-client
</span></span><span style="display:flex;"><span>  ipv6 dhcp-client
</span></span><span style="display:flex;"><span>  no shutdown
</span></span><span style="display:flex;"><span> !
</span></span><span style="display:flex;"><span> interface ge0/0
</span></span><span style="display:flex;"><span>  ip address 192.168.200.3/24
</span></span><span style="display:flex;"><span>  no shutdown
</span></span><span style="display:flex;"><span> !
</span></span><span style="display:flex;"><span> ip route 0.0.0.0/0 192.168.200.253
</span></span><span style="display:flex;"><span>!
</span></span></code></pre></div><p>Notice the <strong><em>ztp-server</em></strong> suffix, this will indicate the device to act as a ZTP server</p>
<p>From the Manager, add the ZTP server to the Controller list:</p>
<p><img loading="lazy" src="/wp-content/uploads/2025/05/ztp1.png"></p>
<p>Depending on the Controller Authentication method, generate and sign the CSR.</p>
<p>If you are using Enterprise Certificates, you will need to install the root certificate and the signed certificate.</p>
<p>For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ztp-server# request root-cert-chain install home/admin/root-ca.crt
</span></span><span style="display:flex;"><span>ztp-server# request certificate install home/admin/ztp.crt
</span></span></code></pre></div><p><strong>Note</strong> The ZTP server doesn&rsquo;t have any control connections to the Manager or any other controller.</p>
<h3 id="upload-device-list-to-ztp-server">Upload device list to ZTP server<a hidden class="anchor" aria-hidden="true" href="#upload-device-list-to-ztp-server">#</a></h3>
<p>Now that the ZTP server is installed, we need to provide the device list that will connect with the ZTP server.</p>
<p>The easiest way is to get the <em>serialFile.viptela</em> from the PnP portal and copy it locally.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ztp-server:~$ ls -l | grep serial
</span></span><span style="display:flex;"><span>-rw-r--r-- 1 admin admin  2364 Apr 24 21:41 serialFile.viptela
</span></span></code></pre></div><p>then execute</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>ztp<span style="color:#f92672">-</span>server<span style="color:#75715e"># request device-upload chassis-file home/admin/serialFile.viptela </span>
</span></span><span style="display:flex;"><span>Uploading chassis numbers via VPN <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Copying <span style="color:#f92672">...</span> <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>admin<span style="color:#f92672">/</span>serialFile<span style="color:#f92672">.</span>viptela via VPN <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>file:  <span style="color:#f92672">/</span>tmp<span style="color:#f92672">/</span>tmp<span style="color:#f92672">.</span>CbUWf8GnSN<span style="color:#f92672">/</span>viptela_serial_file
</span></span><span style="display:flex;"><span>PnP
</span></span><span style="display:flex;"><span>Verifying public key received from PnP against production root cert
</span></span><span style="display:flex;"><span>is_public_key_ok against production root ca:  OK
</span></span><span style="display:flex;"><span>Signature verified <span style="color:#66d9ef">for</span> viptela_serial_file
</span></span><span style="display:flex;"><span>final file:  <span style="color:#f92672">/</span>tmp<span style="color:#f92672">/</span>tmp<span style="color:#f92672">.</span>CbUWf8GnSN<span style="color:#f92672">/</span>viptela_serial_file
</span></span><span style="display:flex;"><span>Signature verification Suceeded<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>Success: Serial file is <span style="color:#f92672">/</span>tmp<span style="color:#f92672">/</span>tmp<span style="color:#f92672">.</span>CbUWf8GnSN<span style="color:#f92672">/</span>viptela_serial_file
</span></span><span style="display:flex;"><span>INFO: <span style="color:#a6e22e">Input</span> <span style="color:#a6e22e">File</span> specified was <span style="color:#e6db74">&#39;/usr/share/viptela/chassis_numbers.tmp&#39;</span>
</span></span><span style="display:flex;"><span>INFO: <span style="color:#75715e"># of complete chassis entries written: 12</span>
</span></span><span style="display:flex;"><span>Json to CSV conversion succeeded<span style="color:#f92672">!</span>
</span></span><span style="display:flex;"><span>Successfully loaded the chassis numbers file to the database<span style="color:#f92672">.</span>
</span></span></code></pre></div><p>To verify the list:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ztp-server# show ztp entries 
</span></span><span style="display:flex;"><span>                                                                                                                                                  ROOT     
</span></span><span style="display:flex;"><span>                                                                                                                           VBOND  ORGANIZATION    CERT     
</span></span><span style="display:flex;"><span>INDEX  CHASSIS NUMBER                                   SERIAL NUMBER                             VALIDITY  VBOND IP       PORT   NAME            PATH     
</span></span><span style="display:flex;"><span>-----------------------------------------------------------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>23     ASR1001-HX-XXXXXXXXXXX                           XXXXXXXX                                  valid     192.168.200.1  12346  SDWAN-LAB123  default   
</span></span></code></pre></div><h3 id="prepare-device-configuration-on-vmanage">Prepare device configuration on vManage<a hidden class="anchor" aria-hidden="true" href="#prepare-device-configuration-on-vmanage">#</a></h3>
<p>To get this done I will use a configuration group, but it can be done with templates too.</p>
<p><img loading="lazy" src="/wp-content/uploads/2025/05/ztp2.png"></p>
<p>I create the device configuration and push it. The task is scheduled as device is offline.</p>
<p><img loading="lazy" src="/wp-content/uploads/2025/05/ztp3.png"></p>
<h3 id="configure-dhcp-and-dns-servers">Configure DHCP and DNS servers<a hidden class="anchor" aria-hidden="true" href="#configure-dhcp-and-dns-servers">#</a></h3>
<p>To make it simple I use an intermediate switch as my DHCP and DNS Server with the following configuration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ip dhcp pool ASR
</span></span><span style="display:flex;"><span> vrf MPLS
</span></span><span style="display:flex;"><span> network 192.168.11.4 255.255.255.252
</span></span><span style="display:flex;"><span> default-router 192.168.11.6 
</span></span><span style="display:flex;"><span> dns-server 192.168.11.6 
</span></span><span style="display:flex;"><span> domain-name cisco.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ip host vrf MPLS ztp.cisco.com 192.168.200.3
</span></span><span style="display:flex;"><span>ip host vrf MPLS devicehelper.cisco.com 192.168.200.3
</span></span></code></pre></div><p>Ok, we are all set to see it in action</p>
<h3 id="trigger-pnp-process">Trigger PnP process<a hidden class="anchor" aria-hidden="true" href="#trigger-pnp-process">#</a></h3>
<p>To trigger the PnP process the device has to have blank configuration. I will use the following command to reset the config and trigger the process.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>Router<span style="color:#75715e">#request platform software sdwan config reset </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span>WARNING: Bootstrap file doesn<span style="color:#e6db74">&#39;t exist and absence </span>
</span></span><span style="display:flex;"><span>of it can cause loss of connectivity to the controller<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>For saving bootstrap config, use:
</span></span><span style="display:flex;"><span>request platform software sdwan bootstrap<span style="color:#f92672">-</span>config save
</span></span><span style="display:flex;"><span>Proceed to reset anyway<span style="color:#960050;background-color:#1e0010">?</span> [confirm]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Backup of running config is saved under <span style="color:#f92672">/</span>bootflash<span style="color:#f92672">/</span>sdwan<span style="color:#f92672">/</span>backup<span style="color:#f92672">.</span>cfg
</span></span><span style="display:flex;"><span>Config reset requested from a console session<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>Waiting <span style="color:#66d9ef">for</span> up to <span style="color:#ae81ff">60</span> seconds <span style="color:#66d9ef">for</span> IOS to initiate reload <span style="color:#f92672">or</span> report failure<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>IOS <span style="color:#66d9ef">return</span> status: <span style="color:#e6db74">&#34;cfgreset_proceed&#34;</span>
</span></span><span style="display:flex;"><span>Config reset is raised successfully, device will reload shortly<span style="color:#f92672">.</span>
</span></span></code></pre></div><p>You need console access to see the following logs:</p>
<p>Device boots and PnP discovery start.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>*May  4 04:18:42.659: %PNP-6-PNP_DISCOVERY_STARTED: PnP Discovery started
</span></span></code></pre></div><p>The router gets an ip address, default router, domain name and dns server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Autoinstall trying DHCPv4 on GigabitEthernet0/0/0,GigabitEthernet0/0/1,GigabitEthernet0/0/2,GigabitEthernet0
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>*May  4 04:19:44.999: %PKI-2-NON_AUTHORITATIVE_CLOCK: PKI functions can not be initialized until an authoritative time source, like NTP, can be obtained.
</span></span><span style="display:flex;"><span>Acquired IPv4 address 192.168.11.5 on Interface GigabitEthernet0/0/1
</span></span><span style="display:flex;"><span>Received following DHCPv4 options:
</span></span><span style="display:flex;"><span>        domain-name     : cisco.com
</span></span><span style="display:flex;"><span>        dns-server-ip   : 192.168.11.6
</span></span></code></pre></div><p>Device tries to resolve domains and gets redirected to <em>ztp.cisco.com</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>*May  4 04:20:08.694: %PNP-3-PNP_CCO_SERVER_IP_UNRESOLVED: CCO server (devicehelper.cisco.com.) can&#39;t be resolved (1/5) by (pid=619, pname=PnP Agent Discovery, time=04:20:08 UTC Sun May 4 2025)
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>*May  4 04:20:20.696: %IOSXE_SDWAN_CONFIG-5-PNP_REDIRECT: PnP Redirect Msg: Org name &#34;&#34; Host &#34;ztp.cisco.com.&#34; port 0 intf GigabitEthernet0/0/1
</span></span><span style="display:flex;"><span>*May  4 04:20:42.010: %PNP-6-PNP_REDIRECTION_DONE: PnP Redirection done (1) by (pid=619, pname=PnP Agent Discovery)
</span></span><span style="display:flex;"><span>*May  4 04:20:42.010: %PNP-6-PNP_SDWAN_STARTED: PnP SDWAN started (1) via (pnp-sdwan-vbond-ztp-discovery) by (pid=619, pname=PnP Agent Discovery)
</span></span><span style="display:flex;"><span>*May  4 04:20:42.811: %PNP-6-PNP_DISCOVERY_DONE: PnP Discovery done successfully (PnP-VBOND-ONPREM-ZTP-IPV4) profile (pnp-zero-touch) 
</span></span></code></pre></div><p>We can confirm <em>ztp.cisco.com</em> was resolved</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ASR1K-2#show pnp trace | i  ztp
</span></span><span style="display:flex;"><span>[05/04/25 04:20:10.695 UTC B7 619] 1: VBOND_ONPRIME_ZTP hostname ztp.cisco.com. resolved to 192.168.11.6 on interface GigabitEthernet0/0/1
</span></span><span style="display:flex;"><span>[05/04/25 04:20:10.695 UTC B8 619] host_name is ztp.cisco.com. vbond_ipv4_address is 192.168.11.6, interface is GigabitEthernet0/0/1
</span></span></code></pre></div><p>Next, the router connects to the ZTP-Server and gets redirected the Validator</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>*May  4 04:21:17.991: %Cisco-SDWAN-Router-vdaemon-6-INFO-1400002: Notification: 5/4/2025 4:21:17 control-connection-state-change severity-level:major host-name:&#34;Router&#34; system-ip::: personality:vedge peer-type:vbond peer-system-ip::: peer-vmanage-system-ip:0.0.0.0 public-ip:192.168.200.3 public-port:12346 src-color:default remote-color:default uptime:&#34;0:00:00:00&#34; new-state:up
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>*May  4 04:21:19.242: %Cisco-SDWAN-Router-vdaemon-6-INFO-1400002: Notification: 5/4/2025 4:21:19 org-name-change severity-level:minor host-name:&#34;Router&#34; system-ip::: old-organization-name:&#34;&#34; new-organization-name:&#34;SDWAN-LAB123&#34;
</span></span><span style="display:flex;"><span>*May  4 04:21:21.597: %Cisco-SDWAN-Router-vdaemon-6-INFO-1400002: Notification: 5/4/2025 4:21:21 control-connection-state-change severity-level:major host-name:&#34;Router&#34; system-ip::: personality:vedge peer-type:vbond peer-system-ip::: peer-vmanage-system-ip:0.0.0.0 public-ip:192.168.200.1 public-port:12346 src-color:default remote-color:default uptime:&#34;0:00:00:00&#34; new-state:up
</span></span></code></pre></div><p>Eventually, the device connected to the Manager and Controller and pulls the configuration</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>*May  4 04:21:23.924: %Cisco-SDWAN-Router-vdaemon-6-INFO-1400002: Notification: 5/4/2025 4:21:23 control-connection-state-change severity-level:major host-name:&#34;Router&#34; system-ip::: personality:vedge peer-type:vmanage peer-system-ip:10.10.10.2 peer-vmanage-system-ip:0.0.0.0 public-ip:192.168.100.1 public-port:12746 src-color:default remote-color:biz-internet uptime:&#34;0:00:00:00&#34; new-state:up
</span></span><span style="display:flex;"><span>*May  4 04:21:24.299: %Cisco-SDWAN-CSS-SDWAN-POD1-ASR1K-2-OMPD-5-NTCE-400003: Operational state changed to UP
</span></span><span style="display:flex;"><span>*May  4 04:21:43.981: %DMI-5-AUTH_PASSED: R0/0: dmiauthd: User &#39;vmanage-admin&#39; authenticated successfully from 10.10.10.2:42962  for netconf over ssh.
</span></span></code></pre></div><p><img loading="lazy" src="/wp-content/uploads/2025/05/ztp4.png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ASR1K-2#show sdwan control connections | i up
</span></span><span style="display:flex;"><span>vsmart  dtls 10.10.10.3      5          1      192.168.100.2                           12346 192.168.100.2                           12346 SDWAN-LAB123          mpls            No    up     0:02:02:51 0           
</span></span><span style="display:flex;"><span>vbond   dtls 0.0.0.0         0          0      192.168.200.1                           12346 192.168.200.1                           12346 SDWAN-LAB123          mpls            -     up     0:02:02:54 0           
</span></span><span style="display:flex;"><span>vmanage dtls 10.10.10.2      5          0      192.168.100.1                           12946 192.168.100.1                           12946 SDWAN-LAB123          mpls            No    up     0:02:02:49 0           
</span></span></code></pre></div><h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>On-Prem ZTP server extends the ability to onboard hardware devices to those network where internet access is restricted.</p>
<p>Automating router onboarding with On-Prem ZTP provides a great alternative for organizations that need full control over their provisioning process or operate in air-gapped environments. By replicating the Plug and Play process locally, you eliminate the need for manual configuration at remote sites while keeping sensitive environments isolated.</p>
<p>With the right setup, onboarding new sites becomes an easy and repetable process that will save precious time, reduce human error and scales SD-WAN deployments.</p>
<p>üëâ Interested in setting up On-Prem ZTP for your network? Leave a comment or reach out, I‚Äôd love to help or answer your questions!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer><script src="https://utteranc.es/client.js"
        repo="aruiz-p/netwithalex"
        issue-term="title"
        label="comments"
        theme="preferred-color-scheme"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">NetWithAlex</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
