<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Simplifying AAR: 2/3 Understanding different scenarios | NetWithAlex</title>
<meta name="keywords" content="">
<meta name="description" content="Learn how AAR can help improve the application user experience with Cisco SD-WAN">
<meta name="author" content="alex">
<link rel="canonical" href="https://netwithalex.blog/demystifying-aar-understanding-different-scenarios/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://netwithalex.blog/assets/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://netwithalex.blog/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://netwithalex.blog/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://netwithalex.blog/apple-touch-icon.png">
<link rel="mask-icon" href="https://netwithalex.blog/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://netwithalex.blog/demystifying-aar-understanding-different-scenarios/">
<link rel="alternate" hreflang="es" href="https://netwithalex.blog/simplificando-aar-analizando-diferentes-escenarios/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>















    
        <link rel="preconnect" href="https://plausible.io">
    
        
            
            <script defer  data-domain="netwithalex.blog" src="https://plausible.io/js/script.js" ></script>

<!-- If you are using Content-Security-Policy, do not forget to add this code to your CSP : 
  script-src 'unsafe-inline' https://plausible.io
  connect-src 'unsafe-inline' https://plausible.io
  or just add the partial 'plausible_csp.html' to those 2 csp directives in your 'index.headers' file
-->



    
    <script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>
    <script>
         
         
         
    </script>

    
<meta property="og:url" content="https://netwithalex.blog/demystifying-aar-understanding-different-scenarios/">
  <meta property="og:site_name" content="NetWithAlex">
  <meta property="og:title" content="Simplifying AAR: 2/3 Understanding different scenarios">
  <meta property="og:description" content="Learn how AAR can help improve the application user experience with Cisco SD-WAN">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-07T20:27:37+00:00">
    <meta property="article:modified_time" content="2024-02-07T20:27:37+00:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Simplifying AAR: 2/3 Understanding different scenarios">
<meta name="twitter:description" content="Learn how AAR can help improve the application user experience with Cisco SD-WAN">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://netwithalex.blog/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Simplifying AAR: 2/3 Understanding different scenarios",
      "item": "https://netwithalex.blog/demystifying-aar-understanding-different-scenarios/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Simplifying AAR: 2/3 Understanding different scenarios",
  "name": "Simplifying AAR: 2\/3 Understanding different scenarios",
  "description": "Learn how AAR can help improve the application user experience with Cisco SD-WAN",
  "keywords": [
    
  ],
  "articleBody": "Introduction Welcome back to the second installment of my series on Application Aware Routing (AAR). In my previous post, we discussed the essential concepts of Bidirectional Forwarding Detection (BFD) and Service Level Agreements (SLAs), laying the foundation for understanding how AAR optimizes network performance based on application requirements. We also briefly touched on tha AAR configuration with a simple example.\nNow, we continue by digging deeper on different AAR configurations, more specifically we will concentrate on Strict/Drop and Backup SLA Preferred Color behaviors.\nInitial Topology and Configuration Let’s start with a simple topology\nI am not limiting the tunnels between colors so we have a total of 4 tunnels on each wan edge.\nmpls - mpls mpls - biz-inet biz-inet- mpls biz-inet - biz-inet This is the BFD hello interval and app-route configuration for all the devices - this is the most relevant to AAR. If you are not familiar with it, I recommend you check my last post before continuing.\nhello-interval 1000 bfd app-route multiplier 3 bfd app-route poll-interval 120000 Scenario 1: SLA not Met - Strict/Drop Our AAR policy is testing against Business-Critical SLA. I will be playing with packet loss to demonstrate how traffic shifts.\nBR10#show sdwan policy from-vsmart from-vsmart sla-class Business-Critical loss 1 latency 250 jitter 100 from-vsmart app-route-policy _VPN10_AAR vpn-list VPN10 sequence 1 match source-ip 172.16.10.0/24 destination-ip 172.16.20.0/24 action sla-class Business-Critical sla-class strict sla-class preferred-color mpls sequence 11 match source-ip 172.16.20.0/24 destination-ip 172.16.10.0/24 action sla-class Business-Critical sla-class strict sla-class preferred-color mpls from-vsmart lists vpn-list VPN10 vpn 10 Let’s read what the documentation says about our config:\nsla-class preferred-color mpls\nsla-class sla-class-name preferred-color color — To set a specific tunnel to use when data traffic matches an SLA class, include the preferred-color option, specifying the color of the preferred tunnel. If more than one tunnel matches the SLA, traffic is sent to the preferred tunnel. If a tunnel of the preferred color is not available, traffic is sent through any tunnel that matches the SLA class. If no tunnel matches the SLA, data traffic is sent through any available tunnel\nhttps://www.cisco.com/c/en/us/td/docs/routers/sdwan/configuration/policies/ios-xe-17/policies-book-xe/application-aware-routing.html\nHere’s a diagram to better visualize it:\nNote than even if both biz-internet and MPLS match the SLA, only MPLS will be used.\nYes, Biz-internet will be used even if it’s not specified as a preferred color if the preferred color is not compliant - from my experience, this is a frequent source of confusion as the expectation is that if mpls is not matching SLA, the SLA not met action will be executed without considering the rest of the colors.\nsla-class strict\nClick Strict/Drop to perform strict matching of the SLA class. If no data plane tunnel is available that satisfies the SLA criteria, traffic is dropped.\nhttps://www.cisco.com/c/en/us/td/docs/routers/sdwan/configuration/policies/ios-xe-17/policies-book-xe/application-aware-routing.html\nNow the diagram looks like this:\nTest 1 - MPLS/Biz-internet compliant I will initiate traffic from Branch10 -\u003e Branch 20 and capture it with NWPI. Both MPLS and Biz-Internet are having perfect KPI metrics (0 loss, 0 latency, 0 jitter)\nBR10-PC1#ssh -l admin 172.16.20.2 Password: We can see the Actual Color is mpls and Tunnel Match Reason is Matched sla and pref encap color. Everything working according to our policy definition.\nTest 2 - Biz-Internet compliant, MPLS non-compliant Let’s introduce 3% of packet loss on the mpls link and check the results.\nNow, our mpls tunnel is above the 1% loss threshold, so it’s no longer eligible. We confirm the Biz-Internet tunnel is used because it matches the SLA - Tunnel match reason is matched sla and color any\nTest 3 - MPLS/Biz-Internet non-compliant Our last test for this scenario will be to mess the SLAs for both transports. Again, will introduce 3% packet loss on both mpls and biz-internet.\nAs expected, now the traffic is getting dropped on BR10 as there are no transports matching the SLA class. Note the DROP_REPORT indicates SdwanDataPolicyDrop\nScenario 2: Backup SLA Preferred Color Let’s explore a new scenario, we will add one transport for this one.\nOur policy configuration will have slight changes. One thing to remark is that when using Backup SLA preferred color option, the only available action when SLA is not met will be Load Balance.\nBR10#show sdwan policy from-vsmart from-vsmart sla-class Business-Critical loss 1 latency 250 jitter 100 from-vsmart app-route-policy _VPN10_AAR vpn-list VPN10 sequence 1 match source-ip 172.16.10.0/24 destination-ip 172.16.20.0/24 action backup-sla-preferred-color private1 sla-class Business-Critical no sla-class strict sla-class preferred-color mpls sequence 11 match source-ip 172.16.20.0/24 destination-ip 172.16.10.0/24 action backup-sla-preferred-color private1 sla-class Business-Critical no sla-class strict sla-class preferred-color mpls from-vsmart lists vpn-list VPN10 vpn 10 Again, let’s see what the documentation says:\nbackup-sla-preferred-color private1\nWhen no tunnel matches the SLA, you can choose how to handle the data traffic:\nbackup-sla-preferred-color colors— Direct the data traffic to a specific tunnel. Data traffic is sent out the configured tunnel if that tunnel interface is available; if that tunnel is unavailable, traffic is sent out another available tunnel. You can specify one or more colors.\nhttps://www.cisco.com/c/en/us/td/docs/routers/sdwan/configuration/policies/ios-xe-17/policies-book-xe/application-aware-routing.html\nTo put it visually\nTest 1 - MPLS/Private1 compliant, Biz-Internet non-compliant We will start with the assumption that biz-internet is not compliant with the SLA, so we have two transports available: MPLS and Private1. Let’s initiate our traffic.\nBR10-PC1#ssh -l admin 172.16.20.2 Password: Notice SLA strict is set to No and mpls is compliant and in use.\nTest 2 - Private1 compliant, MPLS/Biz-Internet non-compliant For the second test we are introducing loss on the mpls transport. With this, now the only compliant transport is Private1, which also happens to be the Backup SLA preferred color. Let’s see how it looks.\nFrom the Tunnel Match Reason we can clearly see that the SLA is met through a color that is not the preferred one (private1). What do you think will happen if private1 becomes non-compliant?\nTest 3 - MPLS/Private1/Biz-Internet non-compliant Private1 is the only transport complying with the SLA, I will take care of that by introducing packet loss.\nAgain (!) private1 is used, BUT now traffic is matching the Default SLA, in other words, there are no tunnels matching the SLA so the tunnel marked as backup preferred, will be used.\nBonus Private1 unavailable\nThe result after shutting down private1 interface, still without any tunnel matching the SLA. We can see a loose match is done on the tunnels (any available tunnel could be picked)\nBiz-internet compliant, MPLS/Private1 non-compliant\nThe result after biz-internet is brought back to zero loss values with private1 not matching the SLA. Even if it’s not the preferred color, it still matches the SLA so it is selected.\nAs a final note, keep in mind AAR will always try to use tunnels that match the specified SLA, don’t get confused because the color names are not explicitly mentioned on the configuration.\nIn the next post, we will explore the remaining option Fallback to best path. Meet you there!\n",
  "wordCount" : "1130",
  "inLanguage": "en",
  "datePublished": "2024-02-07T20:27:37Z",
  "dateModified": "2024-02-07T20:27:37Z",
  "author":{
    "@type": "Person",
    "name": "alex"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://netwithalex.blog/demystifying-aar-understanding-different-scenarios/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "NetWithAlex",
    "logo": {
      "@type": "ImageObject",
      "url": "https://netwithalex.blog/assets/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://netwithalex.blog/" accesskey="h" title="NetWithAlex (Alt + H)">NetWithAlex</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://netwithalex.blog/es/" title="Español"
                            aria-label="Español">Es</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://netwithalex.blog/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://netwithalex.blog/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://netwithalex.blog/category/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://netwithalex.blog/about/" title="About me.">
                    <span>About me.</span>
                </a>
            </li>
            <li>
                <a href="https://netwithalex.blog/search/" title="🔍">
                    <span>🔍</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://netwithalex.blog/">Home</a>&nbsp;»&nbsp;<a href="https://netwithalex.blog/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Simplifying AAR: 2/3 Understanding different scenarios
    </h1>
    <div class="post-description">
      Learn how AAR can help improve the application user experience with Cisco SD-WAN
    </div>
    <div class="post-meta"><span title='2024-02-07 20:27:37 +0000 WET'>February 7, 2024</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;alex&nbsp;|&nbsp;Translations:
<ul class="i18n_list">
    <li>
        <a href="https://netwithalex.blog/simplificando-aar-analizando-diferentes-escenarios/">Es</a>
    </li>
</ul>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#introduction" aria-label="Introduction">Introduction</a></li>
                <li>
                    <a href="#initial-topology-and-configuration" aria-label="Initial Topology and Configuration">Initial Topology and Configuration</a></li>
                <li>
                    <a href="#scenario-1-sla-not-met---strictdrop" aria-label="Scenario 1: SLA not Met - Strict/Drop">Scenario 1: SLA not Met - Strict/Drop</a><ul>
                        
                <li>
                    <a href="#test-1---mplsbiz-internet-compliant" aria-label="Test 1 - MPLS/Biz-internet compliant">Test 1 - MPLS/Biz-internet compliant</a></li>
                <li>
                    <a href="#test-2---biz-internet-compliant-mpls-non-compliant" aria-label="Test 2 - Biz-Internet compliant, MPLS non-compliant">Test 2 - Biz-Internet compliant, MPLS non-compliant</a></li>
                <li>
                    <a href="#test-3---mplsbiz-internet-non-compliant" aria-label="Test 3 - MPLS/Biz-Internet non-compliant">Test 3 - MPLS/Biz-Internet non-compliant</a></li></ul>
                </li>
                <li>
                    <a href="#scenario-2-backup-sla-preferred-color" aria-label="Scenario 2: Backup SLA Preferred Color">Scenario 2: Backup SLA Preferred Color</a><ul>
                        
                <li>
                    <a href="#test-1---mplsprivate1-compliant-biz-internet-non-compliant" aria-label="Test 1 - MPLS/Private1 compliant, Biz-Internet non-compliant">Test 1 - MPLS/Private1 compliant, Biz-Internet non-compliant</a></li>
                <li>
                    <a href="#test-2---private1-compliant-mplsbiz-internet-non-compliant" aria-label="Test 2 - Private1 compliant, MPLS/Biz-Internet non-compliant">Test 2 - Private1 compliant, MPLS/Biz-Internet non-compliant</a></li>
                <li>
                    <a href="#test-3---mplsprivate1biz-internet-non-compliant" aria-label="Test 3 - MPLS/Private1/Biz-Internet non-compliant">Test 3 - MPLS/Private1/Biz-Internet non-compliant</a></li>
                <li>
                    <a href="#bonus" aria-label="Bonus">Bonus</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h3 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h3>
<p>Welcome back to the second installment of my series on Application Aware Routing (AAR). In my <a href="/demystifying-aar-1-3-the-foundations/">previous post</a>, we discussed the essential concepts of Bidirectional Forwarding Detection (BFD) and Service Level Agreements (SLAs), laying the foundation for understanding how AAR optimizes network performance based on application requirements. We also briefly touched on tha AAR configuration with a simple example.</p>
<p>Now, we continue by digging deeper on different AAR configurations, more specifically we will concentrate on <em>Strict/Drop</em> and <em>Backup SLA Preferred Color</em> behaviors.</p>
<h3 id="initial-topology-and-configuration">Initial Topology and Configuration<a hidden class="anchor" aria-hidden="true" href="#initial-topology-and-configuration">#</a></h3>
<p>Let&rsquo;s start with a simple topology</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/01/AAR-topology.png"></p>
<p>I am not limiting the tunnels between colors so we have a total of 4 tunnels on each wan edge.</p>
<ul>
<li>mpls - mpls</li>
<li>mpls - biz-inet</li>
<li>biz-inet- mpls</li>
<li>biz-inet - biz-inet</li>
</ul>
<p>This is the BFD hello interval and app-route configuration for all the devices - this is the most relevant to AAR. If you are not familiar with it, I recommend you check <a href="/demystifying-aar-1-3-the-foundations/">my last post</a> before continuing.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>hello-interval 1000
</span></span><span style="display:flex;"><span>bfd app-route multiplier 3
</span></span><span style="display:flex;"><span>bfd app-route poll-interval 120000
</span></span></code></pre></div><h3 id="scenario-1-sla-not-met---strictdrop">Scenario 1: SLA not Met - Strict/Drop<a hidden class="anchor" aria-hidden="true" href="#scenario-1-sla-not-met---strictdrop">#</a></h3>
<p>Our AAR policy is testing against Business-Critical SLA. I will be playing with <strong>packet loss</strong> to demonstrate how traffic shifts.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10#show sdwan policy from-vsmart
</span></span><span style="display:flex;"><span>from-vsmart sla-class Business-Critical
</span></span><span style="display:flex;"><span> loss    1
</span></span><span style="display:flex;"><span> latency 250
</span></span><span style="display:flex;"><span> jitter  100
</span></span><span style="display:flex;"><span>from-vsmart app-route-policy _VPN10_AAR
</span></span><span style="display:flex;"><span> vpn-list VPN10
</span></span><span style="display:flex;"><span>  sequence 1
</span></span><span style="display:flex;"><span>   match
</span></span><span style="display:flex;"><span>    source-ip      172.16.10.0/24
</span></span><span style="display:flex;"><span>    destination-ip 172.16.20.0/24
</span></span><span style="display:flex;"><span>   action
</span></span><span style="display:flex;"><span>    sla-class       Business-Critical
</span></span><span style="display:flex;"><span>    sla-class strict
</span></span><span style="display:flex;"><span>    sla-class preferred-color mpls
</span></span><span style="display:flex;"><span>  sequence 11
</span></span><span style="display:flex;"><span>   match
</span></span><span style="display:flex;"><span>    source-ip      172.16.20.0/24
</span></span><span style="display:flex;"><span>    destination-ip 172.16.10.0/24
</span></span><span style="display:flex;"><span>   action
</span></span><span style="display:flex;"><span>    sla-class       Business-Critical
</span></span><span style="display:flex;"><span>    sla-class strict
</span></span><span style="display:flex;"><span>    sla-class preferred-color mpls
</span></span><span style="display:flex;"><span>from-vsmart lists vpn-list VPN10
</span></span><span style="display:flex;"><span> vpn 10
</span></span></code></pre></div><p>Let&rsquo;s read what the documentation says about our config:</p>
<p><code>sla-class preferred-color mpls</code></p>
<blockquote>
<p>sla-class <em>sla-class-name</em> preferred-color <em>color</em> — To set a specific tunnel to use when data traffic matches an SLA class, include the preferred-color option, specifying the color of the preferred tunnel. If more than one tunnel matches the SLA, traffic is sent to the preferred tunnel. If a tunnel of the preferred color is not available, traffic is sent through any tunnel that matches the SLA class. If no tunnel matches the SLA, data traffic is sent through any available tunnel</p>
<p><a href="https://www.cisco.com/c/en/us/td/docs/routers/sdwan/configuration/policies/ios-xe-17/policies-book-xe/application-aware-routing.html" target="_blank" rel="nofollow noopener noreferrer">https://www.cisco.com/c/en/us/td/docs/routers/sdwan/configuration/policies/ios-xe-17/policies-book-xe/application-aware-routing.html</a></p>
</blockquote>
<p>Here&rsquo;s a diagram to better visualize it:</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/01/ARR100.png"></p>
<p>Note than even if both biz-internet <strong>and</strong> MPLS match the SLA, only MPLS will be used.</p>
<p>Yes, Biz-internet will be used even if it&rsquo;s not specified as a preferred color <strong>if</strong> the preferred color is not compliant - from my experience, this is a frequent source of confusion as the expectation is that if mpls is not matching SLA, the <em>SLA not met</em> action will be executed without considering the rest of the colors.</p>
<p><code>sla-class strict</code></p>
<blockquote>
<p>Click <strong>Strict/Drop</strong> to perform strict matching of the SLA class. If no data plane tunnel is available that satisfies the SLA criteria, traffic is dropped.</p>
<p><a href="https://www.cisco.com/c/en/us/td/docs/routers/sdwan/configuration/policies/ios-xe-17/policies-book-xe/application-aware-routing.html" target="_blank" rel="nofollow noopener noreferrer">https://www.cisco.com/c/en/us/td/docs/routers/sdwan/configuration/policies/ios-xe-17/policies-book-xe/application-aware-routing.html</a></p>
</blockquote>
<p>Now the diagram looks like this:</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/01/AAR101.png"></p>
<h4 id="test-1---mplsbiz-internet-compliant">Test 1 - MPLS/Biz-internet compliant<a hidden class="anchor" aria-hidden="true" href="#test-1---mplsbiz-internet-compliant">#</a></h4>
<p>I will initiate traffic from Branch10 -&gt; Branch 20 and capture it with NWPI. Both MPLS and Biz-Internet are having perfect KPI metrics (0 loss, 0 latency, 0 jitter)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10-PC1#ssh -l admin 172.16.20.2
</span></span><span style="display:flex;"><span>Password:
</span></span></code></pre></div><p><img loading="lazy" src="/wp-content/uploads/2024/02/aar-1.png"></p>
<p>We can see the <em>Actual Color</em> is <code>mpls</code> and <em>Tunnel Match Reason</em> is <code>Matched sla and pref encap color</code>. Everything working according to our policy definition.</p>
<h4 id="test-2---biz-internet-compliant-mpls-non-compliant">Test 2 - Biz-Internet compliant, MPLS non-compliant<a hidden class="anchor" aria-hidden="true" href="#test-2---biz-internet-compliant-mpls-non-compliant">#</a></h4>
<p>Let&rsquo;s introduce 3% of packet loss on the mpls link and check the results.</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/02/aar-2.png"><img loading="lazy" src="/wp-content/uploads/2024/02/AAR-4-e1706772628492.png"></p>
<p>Now, our mpls tunnel is above the 1% loss threshold, so it&rsquo;s no longer eligible. We confirm the Biz-Internet tunnel is used because it matches the SLA - <em>Tunnel match reason</em> is <code> matched sla and color any</code></p>
<h4 id="test-3---mplsbiz-internet-non-compliant">Test 3 - MPLS/Biz-Internet non-compliant<a hidden class="anchor" aria-hidden="true" href="#test-3---mplsbiz-internet-non-compliant">#</a></h4>
<p>Our last test for this scenario will be to mess the SLAs for both transports. Again, will introduce 3% packet loss on <strong>both</strong> mpls and biz-internet.</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/02/aar3-e1706772589421.png"></p>
<p>As expected, now the traffic is getting dropped on BR10 as there are no transports matching the SLA class. Note the <em>DROP_REPORT</em> indicates <code>SdwanDataPolicyDrop</code></p>
<h3 id="scenario-2-backup-sla-preferred-color">Scenario 2: Backup SLA Preferred Color<a hidden class="anchor" aria-hidden="true" href="#scenario-2-backup-sla-preferred-color">#</a></h3>
<p>Let&rsquo;s explore a new scenario, we will add one transport for this one.</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/02/AAR-Topo2.png"></p>
<p>Our policy configuration will have slight changes. One thing to remark is that when using <em>Backup SLA preferred color</em> option, the only available action when SLA is not met will be <em>Load Balance</em>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10#show sdwan policy from-vsmart
</span></span><span style="display:flex;"><span>from-vsmart sla-class Business-Critical
</span></span><span style="display:flex;"><span> loss    1
</span></span><span style="display:flex;"><span> latency 250
</span></span><span style="display:flex;"><span> jitter  100
</span></span><span style="display:flex;"><span>from-vsmart app-route-policy _VPN10_AAR
</span></span><span style="display:flex;"><span> vpn-list VPN10
</span></span><span style="display:flex;"><span>  sequence 1
</span></span><span style="display:flex;"><span>   match
</span></span><span style="display:flex;"><span>    source-ip      172.16.10.0/24
</span></span><span style="display:flex;"><span>    destination-ip 172.16.20.0/24
</span></span><span style="display:flex;"><span>   action
</span></span><span style="display:flex;"><span>    backup-sla-preferred-color private1
</span></span><span style="display:flex;"><span>    sla-class       Business-Critical
</span></span><span style="display:flex;"><span>    no sla-class strict
</span></span><span style="display:flex;"><span>    sla-class preferred-color mpls
</span></span><span style="display:flex;"><span>  sequence 11
</span></span><span style="display:flex;"><span>   match
</span></span><span style="display:flex;"><span>    source-ip      172.16.20.0/24
</span></span><span style="display:flex;"><span>    destination-ip 172.16.10.0/24
</span></span><span style="display:flex;"><span>   action
</span></span><span style="display:flex;"><span>    backup-sla-preferred-color private1
</span></span><span style="display:flex;"><span>    sla-class       Business-Critical
</span></span><span style="display:flex;"><span>    no sla-class strict
</span></span><span style="display:flex;"><span>    sla-class preferred-color mpls
</span></span><span style="display:flex;"><span>from-vsmart lists vpn-list VPN10
</span></span><span style="display:flex;"><span> vpn 10
</span></span></code></pre></div><p>Again, let&rsquo;s see what the documentation says:</p>
<p><code>backup-sla-preferred-color private1</code></p>
<blockquote>
<p><strong>When no tunnel matches the SLA</strong>, you can choose how to handle the data traffic:</p>
<p>backup-sla-preferred-color <em>colors</em>— Direct the data traffic to a specific tunnel. Data traffic is sent out the configured tunnel if that tunnel interface is available; if that tunnel is unavailable, traffic is sent out another available tunnel. You can specify one or more colors.</p>
<p><a href="https://www.cisco.com/c/en/us/td/docs/routers/sdwan/configuration/policies/ios-xe-17/policies-book-xe/application-aware-routing.html" target="_blank" rel="nofollow noopener noreferrer">https://www.cisco.com/c/en/us/td/docs/routers/sdwan/configuration/policies/ios-xe-17/policies-book-xe/application-aware-routing.html</a></p>
</blockquote>
<p>To put it visually</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/02/AAR200.png"></p>
<h4 id="test-1---mplsprivate1-compliant-biz-internet-non-compliant">Test 1 - MPLS/Private1 compliant, Biz-Internet non-compliant<a hidden class="anchor" aria-hidden="true" href="#test-1---mplsprivate1-compliant-biz-internet-non-compliant">#</a></h4>
<p>We will start with the assumption that biz-internet is not compliant with the SLA, so we have two transports available: MPLS and Private1. Let&rsquo;s initiate our traffic.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10-PC1#ssh -l admin 172.16.20.2
</span></span><span style="display:flex;"><span>Password:
</span></span></code></pre></div><p><img loading="lazy" src="/wp-content/uploads/2024/02/S2-AAR1-e1706776034732.png"></p>
<p>Notice <em>SLA strict</em> is set to <code>No</code> and mpls is compliant and in use.</p>
<h4 id="test-2---private1-compliant-mplsbiz-internet-non-compliant">Test 2 - Private1 compliant, MPLS/Biz-Internet non-compliant<a hidden class="anchor" aria-hidden="true" href="#test-2---private1-compliant-mplsbiz-internet-non-compliant">#</a></h4>
<p>For the second test we are introducing loss on the mpls transport. With this, now the only compliant transport is Private1, which also happens to be the Backup SLA preferred color. Let&rsquo;s see how it looks.</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/02/S2-AAR101.png"></p>
<p>From the <em>Tunnel Match Reason</em> we can clearly see that the SLA is met through a color that is not the preferred one (private1). What do you think will happen if private1 becomes non-compliant?</p>
<h4 id="test-3---mplsprivate1biz-internet-non-compliant">Test 3 - MPLS/Private1/Biz-Internet non-compliant<a hidden class="anchor" aria-hidden="true" href="#test-3---mplsprivate1biz-internet-non-compliant">#</a></h4>
<p>Private1 is the only transport complying with the SLA, I will take care of that by introducing packet loss.</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/02/S2-102.png"></p>
<p>Again (!) private1 is used, BUT now traffic is matching the Default SLA, in other words, there are no tunnels matching the SLA so the tunnel marked as backup preferred, will be used.</p>
<h4 id="bonus">Bonus<a hidden class="anchor" aria-hidden="true" href="#bonus">#</a></h4>
<p><strong>Private1 unavailable</strong><br>
The result after shutting down private1 interface, still without any tunnel matching the SLA. We can see a loose match is done on the tunnels (any available tunnel could be picked)</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/02/S2-103.png"></p>
<p><strong>Biz-internet compliant, MPLS/Private1 non-compliant</strong><br>
The result after biz-internet is brought back to zero loss values with private1 not matching the SLA. Even if it&rsquo;s not the preferred color, it still matches the SLA so it is selected.</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/02/S2-104.png"></p>
<p>As a final note, keep in mind AAR will always try to use tunnels that match the specified SLA, <strong>don&rsquo;t get confused because the color names are not explicitly mentioned on the configuration</strong>.</p>
<p>In the <a href="/simplifying-aar-3-3-fallback-to-best-path">next post</a>, we will explore the remaining option <em>Fallback to best path</em>. Meet you there!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer><script src="https://utteranc.es/client.js"
        repo="aruiz-p/netwithalex"
        issue-term="title"
        label="comments"
        theme="preferred-color-scheme"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://netwithalex.blog/">NetWithAlex</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
