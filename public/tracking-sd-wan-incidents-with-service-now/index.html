<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=46243&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Tracking SD-WAN incidents with Service Now | NetWithAlex</title>
<meta name="keywords" content="">
<meta name="description" content="Learn how to integrate Cisco SD-WAN with ServiceNow and automate your incident management">
<meta name="author" content="alex">
<link rel="canonical" href="http://localhost:46243/tracking-sd-wan-incidents-with-service-now/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:46243/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:46243/assets/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:46243/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:46243/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:46243/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:46243/tracking-sd-wan-incidents-with-service-now/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="http://localhost:46243/tracking-sd-wan-incidents-with-service-now/">
  <meta property="og:site_name" content="NetWithAlex">
  <meta property="og:title" content="Tracking SD-WAN incidents with Service Now">
  <meta property="og:description" content="Learn how to integrate Cisco SD-WAN with ServiceNow and automate your incident management">
  <meta property="og:locale" content="en-US">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-15T18:06:34+00:00">
    <meta property="article:modified_time" content="2024-03-15T18:06:34+00:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tracking SD-WAN incidents with Service Now">
<meta name="twitter:description" content="Learn how to integrate Cisco SD-WAN with ServiceNow and automate your incident management">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:46243/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Tracking SD-WAN incidents with Service Now",
      "item": "http://localhost:46243/tracking-sd-wan-incidents-with-service-now/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Tracking SD-WAN incidents with Service Now",
  "name": "Tracking SD-WAN incidents with Service Now",
  "description": "Learn how to integrate Cisco SD-WAN with ServiceNow and automate your incident management",
  "keywords": [
    
  ],
  "articleBody": "Introduction As networks evolve to provide better user experience and new technologies to manage the network are introduced, maintaining everything running smoothly has become increasingly difficult. One of the critical responsibilities of the operations team is tracking problems happening all over the network. Identifying them is just the beginning, then they need to be logged and driven to resolution. Multiply the amount of actions per incident and you have enough to keep your IT team busy all day long!\nIn this post I will show you what you need to know to integrate the SD-WAN Manager with ServiceNow for incident management. We will see some of the most common problems in SD-WAN.\nLab setup I am using SD-WAN Manager version 20.12.1 and I have a ServiceNow developer instance. My Webhook Server runs in Ubuntu 20.04 LTS and I built the webhook receiver in Go language.\nTo simplify things, I have direct communication between all the elements of my lab.\nWebhooks Webhooks are a way for web applications to communicate with each other in real-time. They allow one application to send automated notifications to another application when a specific event occurs, it is referred to as push model. This facilitates integration between different systems and can be used to trigger subsequent automated activities. Webhooks typically use HTTP callbacks to share notifications/information.\nIn our scenario, the SD-WAN Manager will monitor events on BR10 and will send HTTP POST requests to our Webhook Server when specific events occur. This will allow us to manage incidents in ServiceNow.\nAnatomy of a Webhook Notification Let‚Äôs understand the structure and information that the SD-WAN Manager will be sharing with our Webhook Server.\nThis is an example of the information sent when some interface goes down\n{ \"suppressed\": false, \"devices\": [ { \"system-ip\": \"1.1.10.1\" } ], \"eventname\": \"interface-state-change\", \"type\": \"interface-state-change\", \"rulename\": \"interface-state-change\", \"component\": \"VPN\", \"entry_time\": 1709277345253, \"statcycletime\": 1709277345253, \"message\": \"The interface oper-state changed to down\", \"severity\": \"Critical\", \"severity_number\": 1, \"uuid\": \"9e2f7630-d504-4cdf-b808-fc8e29a6dd47\", \"values\": [ { \"host-name\": \"BR10\", \"system-ip\": \"1.1.10.1\", \"if-name\": \"GigabitEthernet2\", \"new-state\": \"down\", \"vpn-id\": \"0\" } ], \"rule_name_display\": \"Interface_State_Change\", \"receive_time\": 1708843127894, \"values_short_display\": [ { \"host-name\": \"BR10\", \"system-ip\": \"1.1.10.1\", \"if-name\": \"GigabitEthernet2\", \"new-state\": \"down\" } ], \"system_ip\": \"1.1.10.1\", \"host_name\": \"BR10\", \"acknowledged\": false, \"active\": true } Let‚Äôs extract the most important information for us:\n\"active\": true - Do we have a problem? Yes, issue is active or present \"message\": \"The interface oper...\" - What is happening? \"severity_number\": 1 - How serious it is? (we chose the number instead of the string on purpose) \"uuid\": \"9e2f7630-d504...d47\" - Event identifier used by SD-WAN Manager \"system_ip\": \"1.1.10.1\" - What device originated the event? \"host_name\": \"BR10\" - More meaningful device identifier for humans Let‚Äôs see the notification when the interface comes up\n{ \"suppressed\": false, \"devices\": [ { \"system-ip\": \"1.1.10.1\" } ], \"eventname\": \"interface-state-change\", \"type\": \"interface-state-change\", \"rulename\": \"interface-state-change\", \"component\": \"VPN\", \"entry_time\": 1709277482508, \"statcycletime\": 1709277482508, \"message\": \"The interface oper-state changed to up\", \"severity\": \"Medium\", \"severity_number\": 3, \"uuid\": \"5486325c-d189-4467-9b5a-16acb1f28ec9\", \"values\": [ { \"host-name\": \"BR10\", \"system-ip\": \"1.1.10.1\", \"if-name\": \"GigabitEthernet2\", \"new-state\": \"up\", \"vpn-id\": \"0\" } ], \"rule_name_display\": \"Interface_State_Change\", \"receive_time\": 1708843265147, \"values_short_display\": [ { \"host-name\": \"BR10\", \"system-ip\": \"1.1.10.1\", \"if-name\": \"GigabitEthernet2\", \"new-state\": \"up\" } ], \"system_ip\": \"1.1.10.1\", \"host_name\": \"BR10\", \"acknowledged\": false, \"cleared_events\": [ \"9e2f7630-d504-4cdf-b808-fc8e29a6dd47\" ], \"active\": false } The two most important things are:\n\"active\": false - Issue is no longer active or present \"cleared_events\": [\"9e2f7630-d504...d47]\" - Event ID that is resolved One thing to know is that not all the events will behave in the same way. Some of them will not have a ‚Äúcleared_events‚Äù entry so we would need to handle them differently if we want to automatically close them. Others might lack certain information depending on what we are monitoring.\nBefore coding any type of application, it‚Äôs important to know what you want to monitor and what you will be getting from the SD-WAN Manager so you can properly handle it.\nConfigure Webhooks on SD-WAN Manager On 20.12, it‚Äôs very simple to configure them, first enable the notification settings from Administration \u003e Settings \u003e Alarm Notifications Let‚Äôs define the rules to trigger our Webhooks. From Monitor \u003e Logs \u003e Alarm notification \u003e Add Alarm Notification\nThings to know:\nYou can chose to monitor site or devices. Severity is crucial. To open incidents, you typically want to monitor critical and high severity incidents, to close them you need to monitor lower severities. The alarms you want to generate webhooks for, in our case BFD node down/up Omp node down/up Control node down/up Interface down/up Notice that I am only using HTTP in my webhook URL, it is recommended to use HTTPS for higher security. The 8080:/webhook comes from the app we build. Threshold will limit the amount of notifications sent per minute to this URL. 15 is enough for me, but probably not for a production environment Lastly, user and password in case your webhook app requires it. These values would be encoded and sent on the headers. Use dummy values if not required. Build the Webhook Server I have posted the code I used on the following GitHub Repo, here I will explain it in a simpler way.\nStep 1: Listen requests coming on port 8080 and destined to /webhook endpoint.\n// Listen upcoming requests http.HandleFunc(\"/webhook\", handleWebhook) fmt.Println(\"Server listening on port 8080...\") if err := http.ListenAndServe(\"0.0.0.0:8080\", nil); err != nil { fmt.Printf(\"Failed to start server: %v\", err) } Step 2. Check if the incoming request has an active status. If yes, create an incident on Service Now.\n//Verify if issue is active and create incident if data[\"active\"] == true { fmt.Println(\"Opening Service Now incident...\") err := createIncident(data) Step 2.1 To open an incident with Service Now, we need to reformat the information that will be sent there.\nfunc createIncident(data map[string]interface{}) error { // Retrieve information to open incident issueId := data[\"uuid\"].(string) ruleName := data[\"rule_name_display\"].(string) title := data[\"message\"].(string) severity := data[\"severity_number\"].(float64) severityStr := strconv.FormatFloat(severity, 'f', -1, 64) device := \". Device \" + data[\"host_name\"].(string) + \", System-ip \" + data[\"system_ip\"].(string) // Construct JSON payload for creating incident in SNOW incidentData := map[string]interface{}{ \"category\": \"network\", \"caller_id\": \"vManage\", \"short_description\": issueId, \"description\": ruleName + \" - \" + title + device, \"urgency\": severityStr, \"impact\": severityStr, } ... Notice that we have stored the uuid coming from vmanage and used it as short_description for Service Now.\nStep 3.a If the status is not active, we check if there are any cleared_events included, this will give us high precision when closing incidents.\nif _, ok := data[\"cleared_events\"]; ok { ... clearedEvents, ok := data[\"cleared_events\"].([]interface{}) eventId := clearedEvents[0].(string) incidentExists, incident_id, err := getIncidentWithId(eventId) ... if incidentExists { err := closeIncident(incident_id) To close a case, we need to have the Service Now identifier called sys_id. To get it, we use the getIncidentWithId function.\nfunc getIncidentWithId(issueId string) (bool, string, error) { ... // Store Service Now \"short_description\" shortDescription, ok := incidentMap[\"short_description\"].(string) // Compare the short_description with the issueId if strings.Contains(shortDescription, issueId) { // If the short_description matches the issueId, return the incident id sys_id, ok := incidentMap[\"sys_id\"].(string) if !ok { continue } return true, sys_id, nil Step 3.b If the status is not active and there are no cleared events included, we are going to try and find the incident that was opened. There are three things we check:\nRule Name - The rule names for the events we are monitoring will have the following structure _node_. For example, BFD_Node_Down. If we are looking at BFD_Node_Up, we will change Up for Down and look for BFD_Node_Down on the incidents returned from Service Now. System Ip - Store the System-ip contained on the notification and match it on the description of each incident returned. Time - We store the opened_at time and check if it less than 12 hours. This is a totally subjective measure, but my idea is that that issues that take longer than 12 hours to resolve, would have to be verified by some human. func getIncidentWoutId(ruleName, sysIp string, openTime float64) (bool, string, error) { ... // IncidentMap holds the incidents from Service Now description := incidentMap[\"description\"].(string) snowTime := incidentMap[\"opened_at\"].(string) newRuleName := strings.Replace(ruleName, \"Up\", \"Down\", -1) // Compare Rule Name, system ip and time if strings.Contains(description, newRuleName) \u0026\u0026 strings.Contains(description, sysIp) \u0026\u0026 diffHours \u003c 12 { sys_id, ok := incidentMap[\"sys_id\"].(string) sys_id, ok := incidentMap[\"sys_id\"].(string) if !ok { continue } return true, sys_id, nil Step 4. Close the case with the sys_id obtained through getIncidentWoutId function.\nif incidentExists { err := closeIncident(incident_id) if err != nil { fmt.Printf(\"Error closing incident: %v\\n\", err) // Handle the error accordingly (e.g., log it, return, etc.) return } } else { fmt.Printf(\"Incident doesn't exist or is older than 12 hours\") } Demo We‚Äôll start by running the Go app. Notice I am not using VS Code to run it(Cntrl + F5), but the terminal so we can allow incoming connections.\nInterface Notification Let‚Äôs shut down one of the service side interfaces on the router:\nBR10-1#config-transaction BR10-1(config)# interface GigabitEthernet 2 BR10-1(config-if)# shutdown BR10-1(config-if)# commit Commit complete. The server receives the notification and opens the incident. The incident number is the identifier in Service Now (sys_id)\nWe unshut the interface and the incident is closed\nNotice this notification has the ‚Äúcleared_events‚Äù information, so its very easy to find that incident in Service Now. Also, the severity is medium, that‚Äôs why it‚Äôs important to set the right value on the Alarm Notification configuration.\nNotice that State is Resolved and Resolution Notes indicate the incident was automatically closed through Webhooks.\nControl Connections and BFD Notifications Let‚Äôs bring down CCs and BFD sessions by shutting down the transport interface\nBR10-1(config)# interface GigabitEthernet 1 BR10-1(config-if)# sh BR10-1(config-if)# commit Commit complete. Notifications were received and Incidents were created\nWhen we un-shut the interface we receive the notifications and also, we log the interface state status for interface Gig 1 and Tunnel1. This is all reflected in Service Now. These interface notifications were not delivered before because connectivity with SD-WAN Manager was lost.\nLessons Learned It‚Äôs very important to monitor the right severity level, otherwise we might miss notifications to properly close the incidents. SD-WAN Manager could be a bit chatty when generating alerts, the webhook threshold becomes very important and you should test to come with a number that works for your environment. Service Now will come up with a priority based on the Urgency and Impact used to create the ticket. Service Now could have some policies that will prevent you to close incidents if certain information is not present on the UI. Be a little bit familiar with UI policies and Data Policies. Although you can manually set the sys_id\" on Service Now through APIs, I suggest to leave it alone as putting manual values could cause problems in the future and this field is supposed to be unique across your instance. Just use the auto-generated value. You can use public sites like this one, to easily see the content of the notifications while planning your use cases. Conclusion Webhooks are a great way to monitor our environment. Being notified exactly when an issue happens rather than relying in continuous polls, increase our ability to promptly log and react to whatever is going on. You can combine webhooks with other type of alerts, like emails or even chat (webex, slack, etc) in case you need to alert different teams. I hope this post has given you some ideas or trigger your curiosity.\nThanks for reading it!\n",
  "wordCount" : "1880",
  "inLanguage": "en",
  "datePublished": "2024-03-15T18:06:34Z",
  "dateModified": "2024-03-15T18:06:34Z",
  "author":{
    "@type": "Person",
    "name": "alex"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:46243/tracking-sd-wan-incidents-with-service-now/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "NetWithAlex",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:46243/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:46243/" accesskey="h" title="NetWithAlex (Alt + H)">NetWithAlex</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://netwithalex.blog" title="Home">
                    <span>Home</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="http://localhost:46243/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:46243/category/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:46243/about/" title="About me.">
                    <span>About me.</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:46243/search/" title="üîç">
                    <span>üîç</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:46243/">Home</a>&nbsp;¬ª&nbsp;<a href="http://localhost:46243/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Tracking SD-WAN incidents with Service Now
    </h1>
    <div class="post-description">
      Learn how to integrate Cisco SD-WAN with ServiceNow and automate your incident management
    </div>
    <div class="post-meta"><span title='2024-03-15 18:06:34 +0000 WET'>March 15, 2024</span>&nbsp;¬∑&nbsp;9 min&nbsp;¬∑&nbsp;alex

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#introduction" aria-label="Introduction">Introduction</a></li>
                <li>
                    <a href="#lab-setup" aria-label="Lab setup">Lab setup</a></li>
                <li>
                    <a href="#webhooks" aria-label="Webhooks">Webhooks</a><ul>
                        
                <li>
                    <a href="#anatomy-of-a-webhook-notification" aria-label="Anatomy of a Webhook Notification">Anatomy of a Webhook Notification</a></li></ul>
                </li>
                <li>
                    <a href="#configure-webhooks-on-sd-wan-manager" aria-label="Configure Webhooks on SD-WAN Manager">Configure Webhooks on SD-WAN Manager</a></li>
                <li>
                    <a href="#build-the-webhook-server" aria-label="Build the Webhook Server">Build the Webhook Server</a></li>
                <li>
                    <a href="#demo" aria-label="Demo">Demo</a><ul>
                        
                <li>
                    <a href="#interface-notification" aria-label="Interface Notification">Interface Notification</a></li>
                <li>
                    <a href="#control-connections-and-bfd-notifications" aria-label="Control Connections and BFD Notifications">Control Connections and BFD Notifications</a></li></ul>
                </li>
                <li>
                    <a href="#lessons-learned" aria-label="Lessons Learned">Lessons Learned</a></li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h3 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h3>
<p>As networks evolve to provide better user experience and new technologies to manage the network are introduced, maintaining everything running smoothly has become increasingly difficult. One of the critical responsibilities of the operations team is tracking problems happening all over the network. Identifying them is just the beginning, then they need to be logged and driven to resolution. Multiply the amount of actions per incident and you have enough to keep your IT team busy all day long!</p>
<p>In this post I will show you what you need to know to integrate the SD-WAN Manager with ServiceNow for incident management. We will see some of the most common problems in SD-WAN.</p>
<h3 id="lab-setup">Lab setup<a hidden class="anchor" aria-hidden="true" href="#lab-setup">#</a></h3>
<p>I am using SD-WAN Manager version 20.12.1 and I have a ServiceNow developer instance. My Webhook Server runs in Ubuntu 20.04 LTS and I built the webhook receiver in Go language.</p>
<p>To simplify things, I have direct communication between all the elements of my lab.</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/03/SNOW-1.png"></p>
<h3 id="webhooks">Webhooks<a hidden class="anchor" aria-hidden="true" href="#webhooks">#</a></h3>
<p><em>Webhooks</em> are a way for web applications to communicate with each other in real-time. They allow one application to send automated notifications to another application when a specific event occurs, it is referred to as <code>push model.</code> This facilitates integration between different systems and can be used to trigger subsequent automated activities. Webhooks typically use HTTP callbacks to share notifications/information.</p>
<p>In our scenario, the SD-WAN Manager will monitor events on BR10 and will send HTTP POST requests to our Webhook Server when specific events occur. This will allow us to manage incidents in ServiceNow.</p>
<h4 id="anatomy-of-a-webhook-notification">Anatomy of a Webhook Notification<a hidden class="anchor" aria-hidden="true" href="#anatomy-of-a-webhook-notification">#</a></h4>
<p>Let&rsquo;s understand the structure and information that the SD-WAN Manager will be sharing with our Webhook Server.</p>
<p>This is an example of the information sent when some interface goes <strong>down</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;suppressed&#34;: false,
</span></span><span style="display:flex;"><span>  &#34;devices&#34;: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      &#34;system-ip&#34;: &#34;1.1.10.1&#34;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  &#34;eventname&#34;: &#34;interface-state-change&#34;,
</span></span><span style="display:flex;"><span>  &#34;type&#34;: &#34;interface-state-change&#34;,
</span></span><span style="display:flex;"><span>  &#34;rulename&#34;: &#34;interface-state-change&#34;,
</span></span><span style="display:flex;"><span>  &#34;component&#34;: &#34;VPN&#34;,
</span></span><span style="display:flex;"><span>  &#34;entry_time&#34;: 1709277345253,
</span></span><span style="display:flex;"><span>  &#34;statcycletime&#34;: 1709277345253,
</span></span><span style="display:flex;"><span>  &#34;message&#34;: &#34;The interface oper-state changed to down&#34;,
</span></span><span style="display:flex;"><span>  &#34;severity&#34;: &#34;Critical&#34;,
</span></span><span style="display:flex;"><span>  &#34;severity_number&#34;: 1,
</span></span><span style="display:flex;"><span>  &#34;uuid&#34;: &#34;9e2f7630-d504-4cdf-b808-fc8e29a6dd47&#34;,
</span></span><span style="display:flex;"><span>  &#34;values&#34;: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      &#34;host-name&#34;: &#34;BR10&#34;,
</span></span><span style="display:flex;"><span>      &#34;system-ip&#34;: &#34;1.1.10.1&#34;,
</span></span><span style="display:flex;"><span>      &#34;if-name&#34;: &#34;GigabitEthernet2&#34;,
</span></span><span style="display:flex;"><span>      &#34;new-state&#34;: &#34;down&#34;,
</span></span><span style="display:flex;"><span>      &#34;vpn-id&#34;: &#34;0&#34;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  &#34;rule_name_display&#34;: &#34;Interface_State_Change&#34;,
</span></span><span style="display:flex;"><span>  &#34;receive_time&#34;: 1708843127894,
</span></span><span style="display:flex;"><span>  &#34;values_short_display&#34;: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      &#34;host-name&#34;: &#34;BR10&#34;,
</span></span><span style="display:flex;"><span>      &#34;system-ip&#34;: &#34;1.1.10.1&#34;,
</span></span><span style="display:flex;"><span>      &#34;if-name&#34;: &#34;GigabitEthernet2&#34;,
</span></span><span style="display:flex;"><span>      &#34;new-state&#34;: &#34;down&#34;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  &#34;system_ip&#34;: &#34;1.1.10.1&#34;,
</span></span><span style="display:flex;"><span>  &#34;host_name&#34;: &#34;BR10&#34;,
</span></span><span style="display:flex;"><span>  &#34;acknowledged&#34;: false,
</span></span><span style="display:flex;"><span>  &#34;active&#34;: true
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s extract the most important information for us:</p>
<ul>
<li><code>&quot;active&quot;: true</code> <code>-</code> Do we have a problem? Yes, issue is active or present</li>
<li><code>&quot;message&quot;: &quot;The interface oper...&quot;</code> <strong><code>- </code></strong> What is happening?</li>
<li><code>&quot;severity_number&quot;: 1 </code> <strong><code>- </code></strong> How serious it is? (we chose the number instead of the string on purpose)</li>
<li><code>&quot;uuid&quot;: &quot;9e2f7630-d504...d47&quot;</code> <code>-</code> Event identifier used by SD-WAN Manager</li>
<li><code>&quot;system_ip&quot;: &quot;1.1.10.1&quot;</code> <code>-</code> What device originated the event?</li>
<li><code>&quot;host_name&quot;: &quot;BR10&quot;</code> <code>-</code> More meaningful device identifier for humans</li>
</ul>
<p>Let&rsquo;s see the notification when the interface comes <strong>up</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;suppressed&#34;: false,
</span></span><span style="display:flex;"><span>  &#34;devices&#34;: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      &#34;system-ip&#34;: &#34;1.1.10.1&#34;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  &#34;eventname&#34;: &#34;interface-state-change&#34;,
</span></span><span style="display:flex;"><span>  &#34;type&#34;: &#34;interface-state-change&#34;,
</span></span><span style="display:flex;"><span>  &#34;rulename&#34;: &#34;interface-state-change&#34;,
</span></span><span style="display:flex;"><span>  &#34;component&#34;: &#34;VPN&#34;,
</span></span><span style="display:flex;"><span>  &#34;entry_time&#34;: 1709277482508,
</span></span><span style="display:flex;"><span>  &#34;statcycletime&#34;: 1709277482508,
</span></span><span style="display:flex;"><span>  &#34;message&#34;: &#34;The interface oper-state changed to up&#34;,
</span></span><span style="display:flex;"><span>  &#34;severity&#34;: &#34;Medium&#34;,
</span></span><span style="display:flex;"><span>  &#34;severity_number&#34;: 3,
</span></span><span style="display:flex;"><span>  &#34;uuid&#34;: &#34;5486325c-d189-4467-9b5a-16acb1f28ec9&#34;,
</span></span><span style="display:flex;"><span>  &#34;values&#34;: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      &#34;host-name&#34;: &#34;BR10&#34;,
</span></span><span style="display:flex;"><span>      &#34;system-ip&#34;: &#34;1.1.10.1&#34;,
</span></span><span style="display:flex;"><span>      &#34;if-name&#34;: &#34;GigabitEthernet2&#34;,
</span></span><span style="display:flex;"><span>      &#34;new-state&#34;: &#34;up&#34;,
</span></span><span style="display:flex;"><span>      &#34;vpn-id&#34;: &#34;0&#34;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  &#34;rule_name_display&#34;: &#34;Interface_State_Change&#34;,
</span></span><span style="display:flex;"><span>  &#34;receive_time&#34;: 1708843265147,
</span></span><span style="display:flex;"><span>  &#34;values_short_display&#34;: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      &#34;host-name&#34;: &#34;BR10&#34;,
</span></span><span style="display:flex;"><span>      &#34;system-ip&#34;: &#34;1.1.10.1&#34;,
</span></span><span style="display:flex;"><span>      &#34;if-name&#34;: &#34;GigabitEthernet2&#34;,
</span></span><span style="display:flex;"><span>      &#34;new-state&#34;: &#34;up&#34;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  &#34;system_ip&#34;: &#34;1.1.10.1&#34;,
</span></span><span style="display:flex;"><span>  &#34;host_name&#34;: &#34;BR10&#34;,
</span></span><span style="display:flex;"><span>  &#34;acknowledged&#34;: false,
</span></span><span style="display:flex;"><span>  &#34;cleared_events&#34;: [
</span></span><span style="display:flex;"><span>    &#34;9e2f7630-d504-4cdf-b808-fc8e29a6dd47&#34;
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  &#34;active&#34;: false
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The two most important things are:</p>
<ul>
<li><code>&quot;active&quot;: false</code> <code>-</code> Issue is no longer active or present</li>
<li><code>&quot;cleared_events&quot;: [&quot;9e2f7630-d504...d47]&quot;</code> <strong><code>- </code></strong> Event ID that is resolved</li>
</ul>
<p>One thing to know is that not all the events will behave in the same way. Some of them will not have a &ldquo;cleared_events&rdquo; entry so we would need to handle them differently if we want to automatically close them. Others might lack certain information depending on what we are monitoring.</p>
<p>Before coding any type of application, it&rsquo;s important to know what you want to monitor and what you will be getting from the SD-WAN Manager so you can properly handle it.</p>
<h3 id="configure-webhooks-on-sd-wan-manager">Configure Webhooks on SD-WAN Manager<a hidden class="anchor" aria-hidden="true" href="#configure-webhooks-on-sd-wan-manager">#</a></h3>
<p>On 20.12, it&rsquo;s very simple to configure them, first enable the notification settings from <code>Administration &gt; Settings &gt; Alarm Notifications </code></p>
<p><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-2.png"></p>
<p>Let&rsquo;s define the rules to trigger our Webhooks. From <em><code>Monitor &gt; Logs &gt; Alarm notification</code></em> <code>&gt; Add Alarm Notification</code></p>
<p><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-4.png"></p>
<p>Things to know:</p>
<ul>
<li>You can chose to monitor site or devices.</li>
<li>Severity is crucial. To open incidents, you typically want to monitor critical and high severity incidents, to close them you need to monitor lower severities.</li>
<li>The alarms you want to generate webhooks for, in our case
<ul>
<li>BFD node down/up</li>
<li>Omp node down/up</li>
<li>Control node down/up</li>
<li>Interface down/up</li>
</ul>
</li>
<li>Notice that I am only using HTTP in my webhook URL, it is recommended to use HTTPS for higher security. The <code>8080:/webhook</code> comes from the app we build.</li>
<li>Threshold will limit the amount of notifications sent per minute to this URL. 15 is enough for me, but probably not for a production environment</li>
<li>Lastly, user and password in case your webhook app requires it. These values would be encoded and sent on the headers. Use dummy values if not required.</li>
</ul>
<h3 id="build-the-webhook-server">Build the Webhook Server<a hidden class="anchor" aria-hidden="true" href="#build-the-webhook-server">#</a></h3>
<p>I have posted the code I used on the following <a href="https://github.com/aruiz-p/sdwan-snow-integration">GitHub Repo</a>, here I will explain it in a simpler way.</p>
<p><strong>Step 1:</strong> Listen requests coming on port <code>8080</code> and destined to <code>/webhook</code> endpoint.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// Listen upcoming requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>http.HandleFunc(&#34;/webhook&#34;, handleWebhook)
</span></span><span style="display:flex;"><span>fmt.Println(&#34;Server listening on port 8080...&#34;)
</span></span><span style="display:flex;"><span>if err := http.ListenAndServe(&#34;0.0.0.0:8080&#34;, nil); err != nil {
</span></span><span style="display:flex;"><span>		fmt.Printf(&#34;Failed to start server: %v&#34;, err)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Step 2.</strong> Check if the incoming request has an active status. If yes, create an incident on Service Now.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>//Verify if issue is active and create incident
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>if data[&#34;active&#34;] == true {
</span></span><span style="display:flex;"><span>	fmt.Println(&#34;Opening Service Now incident...&#34;)
</span></span><span style="display:flex;"><span>	err := createIncident(data)
</span></span></code></pre></div><p><strong>Step 2.1</strong> To open an incident with Service Now, we need to reformat the information that will be sent there.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> createIncident(data map[string]interface{}) error {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">//</span> Retrieve information to open incident
</span></span><span style="display:flex;"><span>	issueId :<span style="color:#f92672">=</span> data[<span style="color:#e6db74">&#34;uuid&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>	ruleName :<span style="color:#f92672">=</span> data[<span style="color:#e6db74">&#34;rule_name_display&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>	title :<span style="color:#f92672">=</span> data[<span style="color:#e6db74">&#34;message&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>	severity :<span style="color:#f92672">=</span> data[<span style="color:#e6db74">&#34;severity_number&#34;</span>]<span style="color:#f92672">.</span>(float64)
</span></span><span style="display:flex;"><span>	severityStr :<span style="color:#f92672">=</span> strconv<span style="color:#f92672">.</span>FormatFloat(severity, <span style="color:#e6db74">&#39;f&#39;</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>	device :<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;. Device &#34;</span> <span style="color:#f92672">+</span> data[<span style="color:#e6db74">&#34;host_name&#34;</span>]<span style="color:#f92672">.</span>(string) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;, System-ip &#34;</span> <span style="color:#f92672">+</span> data[<span style="color:#e6db74">&#34;system_ip&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">//</span> Construct JSON payload <span style="color:#66d9ef">for</span> creating incident <span style="color:#f92672">in</span> SNOW
</span></span><span style="display:flex;"><span>	incidentData :<span style="color:#f92672">=</span> map[string]interface{}{
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;category&#34;</span>:          <span style="color:#e6db74">&#34;network&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;caller_id&#34;</span>:         <span style="color:#e6db74">&#34;vManage&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;short_description&#34;</span>: issueId,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;description&#34;</span>:       ruleName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; - &#34;</span> <span style="color:#f92672">+</span> title <span style="color:#f92672">+</span> device,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;urgency&#34;</span>:           severityStr,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;impact&#34;</span>:            severityStr,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span></code></pre></div><p>Notice that we have stored the <code>uuid</code> coming from vmanage and used it as <code>short_description</code> for Service Now.</p>
<p><strong>Step 3.a</strong> If the status is <strong>not</strong> active, we check if there are any <code>cleared_events</code> included, this will give us high precision when closing incidents.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>if _, ok := data[&#34;cleared_events&#34;]; ok {
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	clearedEvents, ok := data[&#34;cleared_events&#34;].([]interface{})
</span></span><span style="display:flex;"><span>        eventId := clearedEvents[0].(string)
</span></span><span style="display:flex;"><span>        incidentExists, incident_id, err := getIncidentWithId(eventId)
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        if incidentExists {
</span></span><span style="display:flex;"><span>		err := closeIncident(incident_id)
</span></span></code></pre></div><p>To close a case, we need to have the Service Now identifier called <em><strong>sys_id</strong></em>. To get it, we use the <code>getIncidentWithId</code> function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> getIncidentWithId(issueId string) (<span style="color:#a6e22e">bool</span>, string, error) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">//</span> Store Service Now <span style="color:#e6db74">&#34;short_description&#34;</span>
</span></span><span style="display:flex;"><span>        shortDescription, ok :<span style="color:#f92672">=</span> incidentMap[<span style="color:#e6db74">&#34;short_description&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">//</span> Compare the short_description with the issueId
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> strings<span style="color:#f92672">.</span>Contains(shortDescription, issueId) {
</span></span><span style="display:flex;"><span>	        <span style="color:#f92672">//</span> If the short_description matches the issueId, <span style="color:#66d9ef">return</span> the incident id
</span></span><span style="display:flex;"><span>		sys_id, ok :<span style="color:#f92672">=</span> incidentMap[<span style="color:#e6db74">&#34;sys_id&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>ok {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> true, sys_id, nil
</span></span></code></pre></div><p><strong>Step 3.b</strong> If the status is <strong>not</strong> active and there are no cleared events included, we are going to try and find the incident that was opened. There are three things we check:</p>
<ul>
<li><strong>Rule Name</strong> <strong>-</strong> The rule names for the events we are monitoring will have the following structure <feature>_node_<state>. For example, <code>BFD_Node_Down</code>. If we are looking at BFD_Node_Up, we will change Up for Down and look for <em>BFD_Node_Down</em> on the incidents returned from Service Now.</li>
<li><strong>System Ip</strong> <strong>-</strong> Store the <code>System-ip</code> contained on the notification and match it on the description of each incident returned.</li>
<li><strong>Time</strong> <strong>-</strong> We store the <code>opened_at</code> time and check if it less than 12 hours. This is a totally subjective measure, but my idea is that that issues that take longer than 12 hours to resolve, would have to be verified by some human.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> getIncidentWoutId(ruleName, sysIp string, openTime float64) (<span style="color:#a6e22e">bool</span>, string, error) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">//</span> IncidentMap holds the incidents from Service Now
</span></span><span style="display:flex;"><span>      description :<span style="color:#f92672">=</span> incidentMap[<span style="color:#e6db74">&#34;description&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>      snowTime :<span style="color:#f92672">=</span> incidentMap[<span style="color:#e6db74">&#34;opened_at&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>      newRuleName :<span style="color:#f92672">=</span> strings<span style="color:#f92672">.</span>Replace(ruleName, <span style="color:#e6db74">&#34;Up&#34;</span>, <span style="color:#e6db74">&#34;Down&#34;</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">//</span> Compare Rule Name, system ip <span style="color:#f92672">and</span> time
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> strings<span style="color:#f92672">.</span>Contains(description, newRuleName) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>	      strings<span style="color:#f92672">.</span>Contains(description, sysIp) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>	      diffHours <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">12</span> {
</span></span><span style="display:flex;"><span>	      sys_id, ok :<span style="color:#f92672">=</span> incidentMap[<span style="color:#e6db74">&#34;sys_id&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>              sys_id, ok :<span style="color:#f92672">=</span> incidentMap[<span style="color:#e6db74">&#34;sys_id&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>ok {
</span></span><span style="display:flex;"><span>	              <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>	      }
</span></span><span style="display:flex;"><span>	      <span style="color:#66d9ef">return</span> true, sys_id, nil
</span></span></code></pre></div><p><strong>Step 4.</strong> Close the case with the sys_id obtained through <code>getIncidentWoutId</code> function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>if incidentExists {
</span></span><span style="display:flex;"><span>	err := closeIncident(incident_id)
</span></span><span style="display:flex;"><span>	if err != nil {
</span></span><span style="display:flex;"><span>		fmt.Printf(&#34;Error closing incident: %v\n&#34;, err)
</span></span><span style="display:flex;"><span>		// Handle the error accordingly (e.g., log it, return, etc.)
</span></span><span style="display:flex;"><span>		return
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>} else {
</span></span><span style="display:flex;"><span>	fmt.Printf(&#34;Incident doesn&#39;t exist or is older than 12 hours&#34;)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="demo">Demo<a hidden class="anchor" aria-hidden="true" href="#demo">#</a></h3>
<p>We&rsquo;ll start by running the Go app. Notice I am not using VS Code to run it(Cntrl + F5), but the terminal so we can allow incoming connections.</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-3.png"></p>
<h4 id="interface-notification">Interface Notification<a hidden class="anchor" aria-hidden="true" href="#interface-notification">#</a></h4>
<p>Let&rsquo;s shut down one of the service side interfaces on the router:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10-1#config-transaction
</span></span><span style="display:flex;"><span>BR10-1(config)# interface GigabitEthernet 2
</span></span><span style="display:flex;"><span>BR10-1(config-if)# shutdown
</span></span><span style="display:flex;"><span>BR10-1(config-if)# commit
</span></span><span style="display:flex;"><span>Commit complete.
</span></span></code></pre></div><p>The server receives the notification and opens the incident. The incident number is the identifier in Service Now (sys_id)</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-5-1.png"><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-6.png"></p>
<p>We unshut the interface and the incident is closed</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-7-1.png"><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-9.png"></p>
<p>Notice this notification has the &ldquo;cleared_events&rdquo; information, so its very easy to find that incident in Service Now. Also, the severity is <code>medium</code>, that&rsquo;s why it&rsquo;s important to set the right value on the Alarm Notification configuration.</p>
<p>Notice that <em><strong>State</strong></em> is <code>Resolved</code> and <em><strong>Resolution Notes</strong></em> indicate the incident was automatically closed through Webhooks.</p>
<h4 id="control-connections-and-bfd-notifications">Control Connections and BFD Notifications<a hidden class="anchor" aria-hidden="true" href="#control-connections-and-bfd-notifications">#</a></h4>
<p>Let&rsquo;s bring down CCs and BFD sessions by shutting down the transport interface</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10-1(config)# interface GigabitEthernet 1
</span></span><span style="display:flex;"><span>BR10-1(config-if)# sh
</span></span><span style="display:flex;"><span>BR10-1(config-if)# commit
</span></span><span style="display:flex;"><span>Commit complete.
</span></span></code></pre></div><p>Notifications were received and Incidents were created</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-10.png"><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-11.png"></p>
<p>When we un-shut the interface we receive the notifications and also, we log the interface state status for interface Gig 1 and Tunnel1. This is all reflected in Service Now. These interface notifications were not delivered before because connectivity with SD-WAN Manager was lost.</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-12-1.png"><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-13.png"></p>
<h3 id="lessons-learned">Lessons Learned<a hidden class="anchor" aria-hidden="true" href="#lessons-learned">#</a></h3>
<ol>
<li>It&rsquo;s very important to monitor the right severity level, otherwise we might miss notifications to properly close the incidents.</li>
<li>SD-WAN Manager could be a bit chatty when generating alerts, the webhook threshold becomes very important and you should test to come with a number that works for your environment.</li>
<li>Service Now will come up with a <strong>priority</strong> based on the Urgency and Impact used to create the ticket.</li>
<li>Service Now could have some policies that will prevent you to close incidents if certain information is not present on the UI. Be a little bit familiar with UI policies and Data Policies.</li>
<li>Although you can manually set the <em>sys_id&quot;</em> on Service Now through APIs, I suggest to leave it alone as putting manual values could cause problems in the future and this field is supposed to be unique across your instance. Just use the auto-generated value.</li>
<li>You can use public sites like <a href="https://webhook.site">this one</a>, to easily see the content of the notifications while planning your use cases.</li>
</ol>
<h3 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h3>
<p>Webhooks are a great way to monitor our environment. Being notified exactly when an issue happens rather than relying in continuous polls, increase our ability to promptly log and react to whatever is going on. You can combine webhooks with other type of alerts, like emails or even chat (webex, slack, etc) in case you need to alert different teams. I hope this post has given you some ideas or trigger your curiosity.</p>
<p>Thanks for reading it!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:46243/">NetWithAlex</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
