<!DOCTYPE html>
<html lang="es" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Enhanced App Aware Routing | NetWithAlex</title>
<meta name="keywords" content="">
<meta name="description" content="Aprende los beneficios de EAAR y c√≥mo implementarlo en tu red">
<meta name="author" content="Alex">
<link rel="canonical" href="http://localhost:1313/mejorado-aar/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/assets/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/enhanced-aar/">
<link rel="alternate" hreflang="es" href="http://localhost:1313/mejorado-aar/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>















    
        <link rel="preconnect" href="https://plausible.io">
    
        <!-- Dev mode : We do not load plausible script to avoid bloating your stats -->

<!-- If you are using Content-Security-Policy, do not forget to add this code to your CSP : 
  script-src 'unsafe-inline' https://plausible.io
  connect-src 'unsafe-inline' https://plausible.io
  or just add the partial 'plausible_csp.html' to those 2 csp directives in your 'index.headers' file
-->



    
    <script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>
    <script>
         
         
         
    </script>

    
<meta property="og:url" content="http://localhost:1313/mejorado-aar/">
  <meta property="og:site_name" content="NetWithAlex">
  <meta property="og:title" content="Enhanced App Aware Routing">
  <meta property="og:description" content="Aprende los beneficios de EAAR y c√≥mo implementarlo en tu red">
  <meta property="og:locale" content="es">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-01-05T14:20:31+00:00">
    <meta property="article:modified_time" content="2025-01-05T14:20:31+00:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Enhanced App Aware Routing">
<meta name="twitter:description" content="Aprende los beneficios de EAAR y c√≥mo implementarlo en tu red">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/es/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Enhanced App Aware Routing",
      "item": "http://localhost:1313/mejorado-aar/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Enhanced App Aware Routing",
  "name": "Enhanced App Aware Routing",
  "description": "Aprende los beneficios de EAAR y c√≥mo implementarlo en tu red",
  "keywords": [
    
  ],
  "articleBody": "Introducci√≥n En mi anterior serie de publicaciones, explor√© Application Aware Routing (AAR) en profundidad, una tecnolog√≠a clave en SD-WAN que dirige el tr√°fico sobre los transportes con mejor rendimiento. Si bien AAR ha sido una capacidad fundamental durante a√±os, la evoluci√≥n de las redes trajo nuevas ideas para mejorar su efectividad. Esto condujo a la introducci√≥n de Enhanced Application Aware Routing (EAAR).\nLimitaciones de AAR Antes de sumergirnos en EAAR, entendamos por qu√© fue creado. ü§ì\nLa implementaci√≥n actual de AAR mide la calidad del transporte utilizando BFD, enviando probes a un intervalo definido (1s por defecto). La p√©rdida, la latencia y jitter se derivan de esos paquetes y estos valores se colocan en cubetas que van rotando para calcular una m√©trica promedio que representa la salud del t√∫nel. Este proceso generalmente toma entre 10 y 60 minutos y con algunos ajustes de configuraci√≥n es posible lograr tiempos de 2 a 10 minutos.\nPara aquellas redes que requieren una detecci√≥n m√°s r√°pida, surgen algunos desaf√≠os:\nBajar el intervalo de hello a menos de 1 segundo afecta la escala de t√∫neles del dispositivo Bajar el multiplicador de BFD y el poll interval podr√≠an conducir a falsos positivos, moviendo el tr√°fico incluso con condiciones de red transitorias. Cambio constante del tr√°fico de un lado a otro, no hay un mecanismo para determinar si un transporte es estable nuevamente despu√©s de un evento de degradaci√≥n de la red. Enhanced AAR Entonces, ¬øqu√© es EAAR y c√≥mo mejora a su predecesor? ü§î\nEn pocas palabras, estas son las ventajas:\nUtiliza inline data en lugar de BFD. En otras palabras, los paquetes de plano de datos se utilizan para medir la p√©rdida, la latencia y el jitter. Capacidad de mover el tr√°fico en segundos en lugar de minutos Amortiguaci√≥n (Dampening) implementada para prop√≥sitos de estabilidad, asegurando que los transportes sean estables antes de reenviar el tr√°fico a trav√©s de ellos. Medici√≥n m√°s precisa de p√©rdida, latencia y jitter Vamos por partes Cuando EAAR est√° habilitado, los paquetes de datos se utilizar√°n para medir la p√©rdida, la latencia y la jitter. Entendamos las diferencias clave:\nMedici√≥n de p√©rdida Los routeres SD-WAN utilizar√°n inline data junto con los n√∫meros de secuencia IPSEC para medir la p√©rdida.\nHay un mecanismo incorporado que permite a los routers determinar si la p√©rdida es local para el router\nP√©rdida local - Por lo general, debido a ca√≠das de QoS O externo al router\nP√©rdida de WAN - Cualquier p√©rdida de paquetes fuera del router Para calcular la p√©rdida local, el router determinar√° la cantidad de paquetes que gener√≥ en comparaci√≥n con la cantidad de paquetes que realmente fueron enviados. Para obtener la p√©rdida en el WAN, los routers SD-WAN vecinos informar√°n la cantidad de paquetes recibidos y utilizar√°n BFD (TLVs de Monitoreo de Ruta) para enviar esta informaci√≥n de vuelta al router original.\nHasta este punto, existe una mejora importante en c√≥mo se realiza la medici√≥n de p√©rdidas, sin embargo, esto podr√≠a mejorarse a√∫n m√°s al aprovechar mediciones per queue de QoS. Para lograr esto, necesitamos asociar una clase de SLA con una App Probe Class. Veamos un ejemplo.\nCon esta App Probe Class, el router utilizar√° (y generar√° paquetes de BFD) con DSCP 18, imitando el tr√°fico menos importante que estar√° sujeto a diferentes reglas y rutas en los routers locales y externos. Esto proporcionar√° una medici√≥n m√°s precisa de la p√©rdida de paquetes para cada tipo de tr√°fico en los transportes especificados. Si no hay inline data, BFD se usa para obtener mediciones.\nNota Si usas GRE, la medici√≥n per queue no est√° disponible.\nAqu√≠ hay un visual para comprender mejor c√≥mo se medir√°n la p√©rdida dependiendo de m√∫ltiples factores.\nEncapsulaci√≥n App Probe Class Tipo de medici√≥n T√∫neles p√∫blicos T√∫neles privados IPsec S√≠ Por SLA total p√©rdida WAN + p√©rdida local por queue p√©rdida WAN per queue + p√©rdida local por queue IPsec No Todos los SLAs total p√©rdida WAN + total p√©rdida local total p√©rdida WAN + total p√©rdida local GRE - Todos los SLAs total p√©rdida WAN + total p√©rdida local total p√©rdida WAN + total p√©rdida local Latencia Para medir la latencia, el router simplemente calcular√° el tiempo necesario para enviar y recibir paquetes entre los dispositivos de origen y de destino. Se utiliza inline data y puede llegar a la granularidad de App Probe Class.\nJitter Vale la pena mencionar que el jitter se calcula por direcci√≥n (recibir o transmitir). El jitter se calcula en el receptor e informa al remitente usando TLV BFD. Se utiliza inline data y, en caso de no haber tr√°fico de datos, se usa BFD.\nSLA Dampening Uno de los beneficios de EAAR es dirigir el tr√°fico en segundos en lugar de minutos, pero ¬øqu√© pasar√≠a si hay condiciones de red transitorias que hacen que los transportes no cumplan con el SLA cada pocos minutos? El tr√°fico cambiar√≠a constantemente entre los transportes, lo que no es un escenario deseable y la raz√≥n por la cual se introdujo el dampening.\nLa idea general es que cuando un enlace de transporte deja de cumplir con el SLA, el tr√°fico se redirige a una ruta alternativa. Una vez que el transporte vuelve a estar en cumplimiento, el dispositivo no mueve el tr√°fico de inmediato. En su lugar, inicia un temporizador para asegurarse de que el enlace permanezca estable durante un per√≠odo determinado antes de reutilizarlo.\nAl final, el dampening ayuda a evitar cambios innecesarios en el tr√°fico, lo que podr√≠a afectar negativamente el rendimiento debido a la inestabilidad del transporte.\nConfiguraci√≥n de EAAR Para habilitar EAAR tenemos tres opciones predefinidas:\nMode Poll Interval Poll Multiplier Dampening Multiplier Aggressive 10s 6 (10s-60s) 120 (20 mins) Moderate 60s 5 (60s-300s) 40 (40 mins) Conservative 300s 6 (300s-1800s) 12 (60 mins) Nota Para usar tiempos personalizados, la configuraci√≥n debe hacerse a trav√©s de plantillas CLI.\nEAAR sigue el mismo principio fundamental que AAR, utilizando buckets que van rotando para calcular la p√©rdida promedio, la latencia y la jitter. Con el modo aggressive, el tr√°fico tomar√≠a entre 10 y 60 segundos en cambiar, dependiendo de qu√© tan severo sea el deterioro.\nEl Dampening Multiplier (poll interval x Dampening Multiplier) es de 1200 segundos, lo que significa que antes de cambiar el tr√°fico a un transporte, debe ser estable durante 20 minutos.\nEn mi laboratorio, estoy usando Configuration Groups, sin embargo, esto est√° disponible a trav√©s de Templates tambi√©n.\nPuedes usar una variable, en lugar de un valor global, para que sea aplicable tambi√©n a los dispositivos que no correr√°n EAAR. En este caso, los dispositivos habilitados para EAAR har√°n fallback a AAR.\nLa siguiente configuraci√≥n se agrega a los dispositivos:\nbfd enhanced-app-route enable bfd enhanced-app-route pfr-poll-interval 10000 bfd enhanced-app-route pfr-multiplier 6 bfd sla-dampening enable bfd sla-dampening multiplier 120 Veamos c√≥mo funciona\nDemo En mi laboratorio, uso el Manager con versi√≥n 20.16.1 y mis dispositivos con 17.15.1a\nNota La versi√≥n m√≠nima requerida es 20.12/17.12\nComencemos con algunas verificaciones despu√©s de aplicar la configuraci√≥n.\nPara verificar los temporizadores y multiplicadores configurados\nBR10#show sdwan app-route params Enhanced Application-Aware routing Config: :Enabled Poll interval: :10000 Poll multiplier: :6 App route Poll interval: :120000 Poll multiplier: :5 SLA dampening Config: :Enabled Multiplier: :120 Para verificar qu√© sesiones de BFD est√°n utilizando EAAR, busca la columna Flags\nBR10#show sdwan bfd sessions alt SOURCE TLOC REMOTE TLOC DST PUBLIC DST PUBLIC SYSTEM IP SITE ID STATE COLOR COLOR SOURCE IP IP PORT ENCAP BFD-LD FLAGS UPTIME ------------------------------------------------------------------------------------------------------------------------------------------------- 1.1.1.20 200 up biz-internet biz-internet 30.1.10.2 30.1.20.2 12406 ipsec 20006 EAAR 0:00:20:31 1.1.1.20 200 up mpls mpls 30.2.10.2 30.2.20.2 12366 ipsec 20002 EAAR 0:00:20:38 1.1.1.20 200 up private1 private1 30.3.10.2 30.3.20.2 12366 ipsec 20003 EAAR 0:00:20:37 Para obtener m√°s detalles sobre un t√∫nel espec√≠fico.\nBR10#show sdwan app-route stats summary Generating output, this might take time, please wait ... app-route statistics 30.1.10.2 30.1.20.2 ipsec 12386 12406 remote-system-ip 1.1.1.20 local-color biz-internet remote-color biz-internet sla-class-index 0,1,2 fallback-sla-class-index None enhanced-app-route Enabled sla-dampening-index None app-probe-class-list None mean-loss 0.000 mean-latency 0 mean-jitter 0 TOTAL AVERAGE AVERAGE TX DATA RX DATA IPV6 TX IPV6 RX INDEX PACKETS LOSS LATENCY JITTER PKTS PKTS DATA PKTS DATA PKTS ------------------------------------------------------------------------------------------------------------- 0 0 0 0 0 0 0 0 0 1 64 0 0 0 0 0 0 0 2 0 0 0 0 0 0 0 0 3 0 0 0 0 0 0 0 0 4 0 0 0 0 0 0 0 0 5 64 0 0 0 0 0 0 0 Nota que no hay tr√°fico entre mis dispositivos, por lo que el recuento total de paquetes en cada bucket es bajo.\nLa misma informaci√≥n est√° disponible a trav√©s de la interfaz gr√°fica, utilizando la opci√≥n de Real Time \u003e App Route Statistics\nEscenario 1 - Deterioro ligero Esta es la topolog√≠a de mi laboratorio\nPara esta primera prueba, usar√© los siguientes par√°metros de SLA:\nSLA_Real-Time Loss: 3% Latency: 150ms Jitter: 100ms La pol√≠tica AAR indica que:\nUse MPLS como transporte principal Si ning√∫n color cumple con el SLA y Private1 est√° disponible, usarlo. Si Private1 no est√° disponible, se hace load balance entre todos los colores restantes. Estoy haciendo match del tr√°fico entre 172.16.10.0/24 y 172.16.20.0/24.\nBR10#show sdwan policy from-vsmart from-vsmart app-route-policy app_route_AAR vpn-list vpn_Corporate_Users sequence 1 match source-data-prefix-list BR10 destination-data-prefix-list BR20 action backup-sla-preferred-color private1 sla-class SLA_Real-Time no sla-class strict sla-class preferred-color mpls sequence 11 match source-data-prefix-list BR20 destination-data-prefix-list BR10 action backup-sla-preferred-color private1 sla-class SLA_Real-Time no sla-class strict sla-class preferred-color mpls Estado inicial sin deterioro en la red\nBR10#show sdwan app-route stats summary | i color|damp|mean local-color biz-internet remote-color biz-internet sla-dampening-index None mean-loss 0.000 mean-latency 1 mean-jitter 0 local-color mpls remote-color mpls sla-dampening-index None mean-loss 1.212 mean-latency 1 mean-jitter 0 mean-loss 1.212 mean-latency 1 mean-jitter 0 local-color private1 remote-color private1 sla-dampening-index None mean-loss 0.000 mean-latency 0 mean-jitter 0 mean-loss 0.000 mean-latency 0 mean-jitter 0 Observa que el n√∫mero de paquetes por bucket aument√≥ dram√°ticamente\nBR10#show sdwan app-route stats remote-color mpls summary Generating output, this might take time, please wait ... app-route statistics 30.2.10.2 30.2.20.2 ipsec 12366 12366 remote-system-ip 1.1.1.20 local-color mpls remote-color mpls sla-class-index 0,1 fallback-sla-class-index None enhanced-app-route Enabled sla-dampening-index None app-probe-class-list None mean-loss 1.176 mean-latency 0 mean-jitter 0 TOTAL AVERAGE AVERAGE TX DATA RX DATA IPV6 TX IPV6 RX INDEX PACKETS LOSS LATENCY JITTER PKTS PKTS DATA PKTS DATA PKTS ------------------------------------------------------------------------------------------------------------- 0 131136 1501 0 0 100084 20846 0 0 1 131072 1438 0 0 95287 19605 0 0 2 131072 1400 0 0 100985 20937 0 0 3 131072 1781 0 0 85553 18271 0 0 4 64 0 0 0 72618 15942 0 0 5 131072 1589 0 0 65198 14226 0 0 El tr√°fico est√° utilizando MPLS como transporte primario\nBR10# show sdwan policy service-path vpn 10 interface gigabitEthernet 4 source-ip 172.16.10.10 dest-ip 172.16.20.10 protocol 6 all Number of possible next hops: 1 Next Hop: IPsec Source: 30.2.10.2 12366 Destination: 30.2.20.2 12366 Local Color: mpls Remote Color: mpls Remote System IP: 1.1.1.20 Introduzco el 3% de p√©rdida de paquetes en el transporte MPLS y ver√© cu√°nto tiempo lleva cambiar el tr√°fico. Dado que ya hay alrededor del 1% de p√©rdida, el 3% deber√≠a ser suficiente para activar un cambio.\nEl transporte MPLS tiene m√°s del 3% de p√©rdida\nBR10#show sdwan app-route stats remote-color mpls summary Generating output, this might take time, please wait ... app-route statistics 30.2.10.2 30.2.20.2 ipsec 12366 12366 remote-system-ip 1.1.1.20 local-color mpls remote-color mpls sla-class-index 0 fallback-sla-class-index 1 enhanced-app-route Enabled sla-dampening-index None app-probe-class-list None mean-loss 3.125 \u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c mean-latency 0 mean-jitter 0 Despu√©s de 56 segundos, el tr√°fico cambi√≥ y cualquiera de los transportes que cumplen el SLA podr√≠a usarse\nBR10# show sdwan policy service-path vpn 10 interface gigabitEthernet 4 source-ip 172.16.10.10 dest-ip 172.16.20.10 protocol 6 all Number of possible next hops: 2 Next Hop: IPsec Source: 30.3.10.2 12366 Destination: 30.3.20.2 12366 Local Color: private1 Remote Color: private1 Remote System IP: 1.1.1.20 Next Hop: IPsec Source: 30.1.10.2 12386 Destination: 30.1.20.2 12366 Local Color: biz-internet Remote Color: biz-internet Remote System IP: 1.1.1.20 Si quito la p√©rdida, podemos ver que el mecanismo de dampening se activa. Entonces, si el transporte es estable durante 20 minutos, se volver√° a utilizar como ruta preferida.\nBR10#show sdwan app-route stats remote-color mpls summary Generating output, this might take time, please wait ... app-route statistics 30.2.10.2 30.2.20.2 ipsec 12366 12366 remote-system-ip 1.1.1.20 local-color mpls remote-color mpls sla-class-index 0 fallback-sla-class-index 1 enhanced-app-route Enabled sla-dampening-index 1 \u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c app-probe-class-list None mean-loss 0.000 mean-latency 0 mean-jitter 0 Escenario 2 - Mayor deterioro En este caso, introducir√© una p√©rdida de paquetes del 10% para el transporte de biz-internet, lo que hace que private1 sea el √∫nico transporte cumpliendo el SLA.\nDespu√©s de alrededor de 45 segundos, la p√©rdida de Biz-Internet fue de 12%\nBR10#show sdwan app-route stats local-color biz-internet summary Generating output, this might take time, please wait ... app-route statistics 30.1.10.2 30.1.20.2 ipsec 12386 12366 remote-system-ip 1.1.1.20 local-color biz-internet remote-color biz-internet sla-class-index 0 fallback-sla-class-index 1 enhanced-app-route Enabled sla-dampening-index None app-probe-class-list None mean-loss 12.500 mean-latency 0 mean-jitter 0 El tr√°fico cambi√≥ a private1 exclusivamente\nBR10#show sdwan policy service-path vpn 10 interface gigabitEthernet 4 source-ip 172.16.10.10 dest-ip 172.16.20.10 protocol 6 all Number of possible next hops: 1 Next Hop: IPsec Source: 30.3.10.2 12366 Destination: 30.3.20.2 12366 Local Color: private1 Remote Color: private1 Remote System IP: 1.1.1.20 Despu√©s de eliminar la p√©rdida de paquetes, Biz-Internet tiene el mecanismo de dampening activado\nBR10#show sdwan app-route stats local-color biz-internet summary Generating output, this might take time, please wait ... app-route statistics 30.1.10.2 30.1.20.2 ipsec 12386 12366 remote-system-ip 1.1.1.20 local-color biz-internet remote-color biz-internet sla-class-index 0 fallback-sla-class-index 1 enhanced-app-route Enabled sla-dampening-index 1 \u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c app-probe-class-list None mean-loss 1.562 mean-latency 0 mean-jitter 0 En este caso, el tiempo para cambiar el tr√°fico se redujo como consecuencia de un deterioro mayor.\nEscenario 3 - M√∫ltiples App Probe Class Para este escenario final, veamos c√≥mo obtener el mayor beneficio de EAAR.\nLa configuraci√≥n es m√°s compleja ya que involucra QoS, App Probe Class y pol√≠tica AAR.\nSe requiere QoS para clasificar y enviar tr√°fico en diferentes colas. App Probe Class para medir la p√©rdida, la latencia y el jitter en cada una de esas colas, de forma independiente. Mi configuraci√≥n de QoS tiene 3 colas y la cola 2 manejar√° el tr√°fico menos importante.\ncola 0 para el tr√°fico de control cola 1 para tr√°fico en tiempo real (marcado DSCP 46) cola 2 para tr√°fico transaccional (marcado DSCP 18) Utilizo una pol√≠tica de datos para hacer match del tr√°fico en el lado del servicio, marcarlo con el DSCP correcto y ponerla en la clase de QoS correcta. Tambi√©n cre√© un shaper en mi interfaz MPLS.\nPara demostrar las cosas, tendr√© dos transferencias de datos:\nHTTP GET (puerto 8000) Copia SCP (puerto 22) Mis SLA tienen las siguientes configuraciones:\nSLA Class Name Loss Latency Jitter SLA_Real-Time 3 % 150 ms 100 ms SLA_Transactional 5 % 45 ms 150 ms Lo primero que hay que notar es que mis dos clases de sondeo de aplicaciones se miden de manera independiente. Observa c√≥mo la p√©rdida media para Transactional-Probe_Class es 1, mientras que para Real_Time_Probe_Class es 0.\nBR10#show sdwan app-route stats local-color mpls summary Generating output, this might take time, please wait ... app-route statistics 30.2.10.2 30.2.20.2 ipsec 12366 12366 remote-system-ip 1.1.1.20 local-color mpls remote-color mpls sla-class-index 0,1,2 fallback-sla-class-index None enhanced-app-route Enabled sla-dampening-index None app-probe-class-list None mean-loss 0.000 mean-latency 1 mean-jitter 0 TOTAL AVERAGE AVERAGE TX DATA RX DATA IPV6 TX IPV6 RX INDEX PACKETS LOSS LATENCY JITTER PKTS PKTS DATA PKTS DATA PKTS ------------------------------------------------------------------------------------------------------------- 0 16384 0 0 0 35827 111807 0 0 1 49152 0 1 0 37788 118236 0 0 2 49216 0 1 0 36859 115551 0 0 3 16384 0 1 0 23894 77280 0 0 4 32768 0 1 1 33179 103759 0 0 5 32768 0 1 0 21485 71702 0 0 app-probe-class-list Real_Time_Probe_Class mean-loss 0.000 mean-latency 0 mean-jitter 0 TOTAL AVERAGE AVERAGE TX DATA RX DATA IPV6 TX IPV6 RX INDEX PACKETS LOSS LATENCY JITTER PKTS PKTS DATA PKTS DATA PKTS ------------------------------------------------------------------------------------------------------------- 0 0 0 0 0 - - - - 1 32768 0 1 0 - - - - 2 32768 0 0 0 - - - - 3 0 0 0 0 - - - - 4 32768 0 1 2 - - - - 5 0 0 0 0 - - - - app-probe-class-list Transactional-Probe_Class mean-loss 0.000 mean-latency 1 mean-jitter 0 TOTAL AVERAGE AVERAGE TX DATA RX DATA IPV6 TX IPV6 RX INDEX PACKETS LOSS LATENCY JITTER PKTS PKTS DATA PKTS DATA PKTS ------------------------------------------------------------------------------------------------------------- 0 16384 0 0 0 - - - - 1 49152 0 1 0 - - - - 2 49216 0 1 0 - - - - 3 16384 0 1 0 - - - - 4 32768 0 1 1 - - - - 5 32768 0 1 0 - - - - Ahora, he bajado mi shaper. EAAR fue r√°pido en detectar un cambio en la latencia para el SLA Transactional, ahora son 53 ms.\nBR10# show sdwan app-route stats local mpls summary Generating output, this might take time, please wait ... app-route statistics 30.2.10.2 30.2.20.2 ipsec 12386 12366 remote-system-ip 1.1.1.20 local-color mpls remote-color mpls sla-class-index 0,1,2 fallback-sla-class-index None enhanced-app-route Enabled sla-dampening-index None app-probe-class-list None mean-loss 0.000 mean-latency 53 mean-jitter 0 TOTAL AVERAGE AVERAGE TX DATA RX DATA IPV6 TX IPV6 RX INDEX PACKETS LOSS LATENCY JITTER PKTS PKTS DATA PKTS DATA PKTS ------------------------------------------------------------------------------------------------------------- 0 2048 0 54 0 4396 8513 0 0 1 1024 0 55 0 4461 8534 0 0 2 8256 0 49 0 4429 8549 0 0 3 16384 0 54 0 4411 8549 0 0 4 0 0 53 0 4440 8549 0 0 5 0 0 54 0 4443 8549 0 0 app-probe-class-list Real_Time_Probe_Class mean-loss 0.000 mean-latency 0 mean-jitter 0 TOTAL AVERAGE AVERAGE TX DATA RX DATA IPV6 TX IPV6 RX INDEX PACKETS LOSS LATENCY JITTER PKTS PKTS DATA PKTS DATA PKTS ------------------------------------------------------------------------------------------------------------- 0 0 0 0 0 - - - - 1 0 0 0 0 - - - - 2 8192 0 0 0 - - - - 3 16384 0 0 0 - - - - 4 0 0 0 0 - - - - 5 0 0 0 0 - - - - app-probe-class-list Transactional-Probe_Class mean-loss 0.000 mean-latency 53 \u003c\u003c\u003c\u003c\u003c\u003c\u003c mean-jitter 0 TOTAL AVERAGE AVERAGE TX DATA RX DATA IPV6 TX IPV6 RX INDEX PACKETS LOSS LATENCY JITTER PKTS PKTS DATA PKTS DATA PKTS ------------------------------------------------------------------------------------------------------------- 0 2048 0 54 0 - - - - 1 1024 0 55 0 - - - - 2 8256 0 49 0 - - - - 3 16384 0 54 0 - - - - 4 0 0 53 0 - - - - 5 0 0 54 0 - - - - Ahora que no se cumple mi SLA Transactional con una latencia m√°xima de 45 ms, usar√© NWPI para comprender c√≥mo se env√≠a el tr√°fico. Examinemos el tr√°fico HTTP con el puerto 80000\nObserva que, en la direcci√≥n upstream, el color local y remote es private1, lo que indica que el tr√°fico se ha alejado de MPLS y su latencia de 53 ms. Justo lo que esper√°bamos ‚úÖ\nAhora, veamos c√≥mo est√° fluyendo el tr√°fico en el puerto 22\nUna vez m√°s, observa el local y Remote Color en la direcci√≥n upstream, observa c√≥mo MPLS todav√≠a est√° en uso para este tr√°fico, ya que no hay problemas en los transportes para este tipo de tr√°fico.\nEn resumen, el tr√°fico con DSCP 46 funciona perfectamente bien en el transporte MPLS, sin embargo, el tr√°fico con DSCP 18 estaba teniendo m√°s latencia que el SLA configurado, por lo que se traslad√≥ a Private1 ya que cumple con el SLA.\nPodemos confirmar que estamos midiendo y tomando decisiones de ruteo per queue, esta es una gran diferencia ü§Ø!\nLecciones aprendidas Utilizando inline data, el n√∫mero de muestras aumenta dram√°ticamente en comparaci√≥n con el tama√±o de muestra de BFD. üìà EAAR puede redirigir el tr√°fico en segundos, en lugar de minutos. ‚è© EAAR ofrece los mayores beneficios en los transportes con QoS, como MPLS. üöÄ Incluso en los transportes sin QoS, las mediciones de inline data aumentan el tama√±o y la precisi√≥n de las muestras. ‚è≥ El temporizador de dampening es √∫til para garantizar que los transportes sean estables antes de marcarlos como v√°lidos. ‚úÖ La interoperabilidad entre dispositivos que ejecutan EAAR y dispositivos que ejecutan AAR es posible üîÑ ¬°Espero que hayas aprendido algo √∫til! Nos vemos en el siguiente üëã\n",
  "wordCount" : "3380",
  "inLanguage": "es",
  "datePublished": "2025-01-05T14:20:31Z",
  "dateModified": "2025-01-05T14:20:31Z",
  "author":{
    "@type": "Person",
    "name": "Alex"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/mejorado-aar/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "NetWithAlex",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/assets/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/es/" accesskey="h" title="NetWithAlex (Alt + H)">NetWithAlex</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="http://localhost:1313/" title="English"
                            aria-label="English">En</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/es/" title="Inicio">
                    <span>Inicio</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/es/archives/" title="Archivo">
                    <span>Archivo</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/es/category/" title="Categor√≠as">
                    <span>Categor√≠as</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/es/sobre-mi/" title="Sobre m√≠">
                    <span>Sobre m√≠</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/es/search/" title="üîç">
                    <span>üîç</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/es/">Inicio</a>&nbsp;¬ª&nbsp;<a href="http://localhost:1313/es/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Enhanced App Aware Routing
    </h1>
    <div class="post-description">
      Aprende los beneficios de EAAR y c√≥mo implementarlo en tu red
    </div>
    <div class="post-meta"><span title='2025-01-05 14:20:31 +0000 WET'>enero 5, 2025</span>&nbsp;¬∑&nbsp;16 min&nbsp;¬∑&nbsp;Alex&nbsp;|&nbsp;Traducciones:
<ul class="i18n_list">
    <li>
        <a href="http://localhost:1313/enhanced-aar/">En</a>
    </li>
</ul>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Tabla de Contenidos</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#introducci%c3%b3n" aria-label="Introducci√≥n">Introducci√≥n</a></li>
                <li>
                    <a href="#limitaciones-de-aar" aria-label="Limitaciones de AAR">Limitaciones de AAR</a></li>
                <li>
                    <a href="#enhanced-aar" aria-label="Enhanced AAR">Enhanced AAR</a><ul>
                        
                <li>
                    <a href="#vamos-por-partes" aria-label="Vamos por partes">Vamos por partes</a><ul>
                        
                <li>
                    <a href="#medici%c3%b3n-de-p%c3%a9rdida" aria-label="Medici√≥n de p√©rdida">Medici√≥n de p√©rdida</a></li>
                <li>
                    <a href="#latencia" aria-label="Latencia">Latencia</a></li>
                <li>
                    <a href="#jitter" aria-label="Jitter">Jitter</a></li></ul>
                </li>
                <li>
                    <a href="#sla-dampening" aria-label="SLA Dampening">SLA Dampening</a></li></ul>
                </li>
                <li>
                    <a href="#configuraci%c3%b3n-de-eaar" aria-label="Configuraci√≥n de EAAR">Configuraci√≥n de EAAR</a></li>
                <li>
                    <a href="#demo" aria-label="Demo">Demo</a><ul>
                        
                <li>
                    <a href="#escenario-1---deterioro-ligero" aria-label="Escenario 1 - Deterioro ligero">Escenario 1 - Deterioro ligero</a></li>
                <li>
                    <a href="#escenario-2---mayor-deterioro" aria-label="Escenario 2 - Mayor deterioro">Escenario 2 - Mayor deterioro</a></li>
                <li>
                    <a href="#escenario-3----m%c3%baltiples-app-probe-class" aria-label="Escenario 3 -  M√∫ltiples App Probe Class">Escenario 3 -  M√∫ltiples App Probe Class</a></li></ul>
                </li>
                <li>
                    <a href="#lecciones-aprendidas" aria-label="Lecciones aprendidas">Lecciones aprendidas</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="introducci√≥n">Introducci√≥n<a hidden class="anchor" aria-hidden="true" href="#introducci√≥n">#</a></h2>
<p>En mi anterior <a href="/simplificando-aar-1-3-las-bases">serie de publicaciones</a>, explor√© <strong>Application Aware Routing (AAR)</strong> en profundidad, una tecnolog√≠a clave en SD-WAN que dirige el tr√°fico sobre los transportes con mejor rendimiento. Si bien AAR ha sido una capacidad fundamental durante a√±os, la evoluci√≥n de las redes trajo nuevas ideas para mejorar su efectividad. Esto condujo a la introducci√≥n de <strong><em>Enhanced Application Aware Routing (EAAR)</em></strong>.</p>
<h2 id="limitaciones-de-aar">Limitaciones de AAR<a hidden class="anchor" aria-hidden="true" href="#limitaciones-de-aar">#</a></h2>
<p>Antes de sumergirnos en EAAR, entendamos por qu√© fue creado. ü§ì</p>
<p>La implementaci√≥n actual de AAR mide la calidad del transporte utilizando BFD, enviando probes a un intervalo definido (1s por defecto). La p√©rdida, la latencia y jitter se derivan de esos paquetes y estos valores se colocan en cubetas que van rotando para calcular una m√©trica promedio que representa la salud del t√∫nel. Este proceso generalmente toma entre 10 y 60 minutos y con algunos ajustes de configuraci√≥n es posible lograr tiempos de 2 a 10 minutos.</p>
<p>Para aquellas redes que requieren una detecci√≥n m√°s r√°pida, surgen algunos desaf√≠os:</p>
<ul>
<li>Bajar el intervalo de <em>hello</em> a menos de 1 segundo afecta la escala de t√∫neles del dispositivo</li>
<li>Bajar el multiplicador de BFD y el <em>poll interval</em> podr√≠an conducir a falsos positivos, moviendo el tr√°fico incluso con condiciones de red transitorias.</li>
<li>Cambio constante del tr√°fico de un lado a otro, no hay un mecanismo para determinar si un transporte es estable nuevamente despu√©s de un evento de degradaci√≥n de la red.</li>
</ul>
<h2 id="enhanced-aar">Enhanced AAR<a hidden class="anchor" aria-hidden="true" href="#enhanced-aar">#</a></h2>
<p><em>Entonces, ¬øqu√© es EAAR y c√≥mo mejora a su predecesor?</em> ü§î</p>
<p>En pocas palabras, estas son las ventajas:</p>
<ul>
<li>Utiliza <strong>inline data</strong> en lugar de BFD. En otras palabras, los paquetes de plano de datos se utilizan para medir la p√©rdida, la latencia y el jitter.</li>
<li>Capacidad de mover el tr√°fico en <strong>segundos</strong> en lugar de minutos</li>
<li>Amortiguaci√≥n (<em>Dampening</em>) implementada para prop√≥sitos de <strong>estabilidad</strong>, asegurando que los transportes sean estables antes de reenviar el tr√°fico a trav√©s de ellos.</li>
<li><strong>Medici√≥n m√°s precisa</strong> de p√©rdida, latencia y jitter</li>
</ul>
<h3 id="vamos-por-partes">Vamos por partes<a hidden class="anchor" aria-hidden="true" href="#vamos-por-partes">#</a></h3>
<p>Cuando EAAR est√° habilitado, los paquetes de datos se utilizar√°n para medir la p√©rdida, la latencia y la jitter. Entendamos las diferencias clave:</p>
<h4 id="medici√≥n-de-p√©rdida">Medici√≥n de p√©rdida<a hidden class="anchor" aria-hidden="true" href="#medici√≥n-de-p√©rdida">#</a></h4>
<p>Los routeres SD-WAN utilizar√°n <em>inline data</em> junto con los n√∫meros de secuencia IPSEC para medir la p√©rdida.</p>
<p>Hay un mecanismo incorporado que permite a los routers determinar si la p√©rdida es local para el router</p>
<ul>
<li><strong>P√©rdida local</strong> - Por lo general, debido a ca√≠das de QoS</li>
</ul>
<p>O externo al router</p>
<ul>
<li><strong>P√©rdida de WAN</strong> - Cualquier p√©rdida de paquetes fuera del router</li>
</ul>
<p>Para calcular la p√©rdida local, el router determinar√° la cantidad de paquetes que gener√≥ en comparaci√≥n con la cantidad de paquetes que realmente fueron enviados. Para obtener la p√©rdida en el WAN, los routers SD-WAN vecinos informar√°n la cantidad de paquetes recibidos y utilizar√°n BFD (TLVs de Monitoreo de Ruta) para enviar esta informaci√≥n de vuelta al router original.</p>
<p>Hasta este punto, existe una mejora importante en c√≥mo se realiza la medici√≥n de p√©rdidas, sin embargo, esto podr√≠a mejorarse a√∫n m√°s al aprovechar mediciones <em>per queue</em> de QoS. Para lograr esto, necesitamos asociar una clase de SLA con una <a href="https://www.cisco.com/c/en/us/td/docs/routers/sdwan/configuration/policies/ios-xe-17/policies-xebook-xe/application-aware-routing.html#concept_gjc_5pm" target="_blank" rel="nofollow noopener noreferrer">App Probe Class</a>. Veamos un ejemplo.</p>
<p><img loading="lazy" src="/wp-content/uploads/2025/02/app-probe.png"></p>
<p>Con esta App Probe Class, el router utilizar√° (y generar√° paquetes de BFD) con DSCP 18, imitando el tr√°fico menos importante que estar√° sujeto a diferentes reglas y rutas en los routers locales y externos. Esto proporcionar√° una medici√≥n m√°s precisa de la p√©rdida de paquetes para cada tipo de tr√°fico en los transportes especificados. Si no hay <em>inline data</em>, BFD se usa para obtener mediciones.</p>
<p><strong>Nota</strong> Si usas GRE, la medici√≥n <em>per queue</em> <strong>no</strong>  est√° disponible.</p>
<p>Aqu√≠ hay un visual para comprender mejor c√≥mo se medir√°n la p√©rdida dependiendo de m√∫ltiples factores.</p>
<table>
  <thead>
      <tr>
          <th>Encapsulaci√≥n</th>
          <th>App Probe Class</th>
          <th>Tipo de medici√≥n</th>
          <th>T√∫neles p√∫blicos</th>
          <th>T√∫neles privados</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>IPsec</td>
          <td>S√≠</td>
          <td>Por SLA</td>
          <td>total p√©rdida WAN + p√©rdida local por queue</td>
          <td>p√©rdida WAN per queue + p√©rdida local por queue</td>
      </tr>
      <tr>
          <td>IPsec</td>
          <td>No</td>
          <td>Todos los SLAs</td>
          <td>total p√©rdida WAN + total p√©rdida local</td>
          <td>total p√©rdida WAN + total p√©rdida local</td>
      </tr>
      <tr>
          <td>GRE</td>
          <td>-</td>
          <td>Todos los SLAs</td>
          <td>total p√©rdida WAN + total p√©rdida local</td>
          <td>total p√©rdida WAN + total p√©rdida local</td>
      </tr>
  </tbody>
</table>
<h4 id="latencia">Latencia<a hidden class="anchor" aria-hidden="true" href="#latencia">#</a></h4>
<p>Para medir la latencia, el router simplemente calcular√° el tiempo necesario para enviar y recibir paquetes entre los dispositivos de origen y de destino. Se utiliza <em>inline data</em> y puede llegar a la granularidad de App Probe Class.</p>
<h4 id="jitter">Jitter<a hidden class="anchor" aria-hidden="true" href="#jitter">#</a></h4>
<p>Vale la pena mencionar que el jitter se calcula por direcci√≥n (recibir o transmitir). El jitter se calcula en el receptor e informa al remitente usando TLV BFD. Se utiliza <em>inline data</em> y, en caso de no haber tr√°fico de datos, se usa BFD.</p>
<h3 id="sla-dampening">SLA Dampening<a hidden class="anchor" aria-hidden="true" href="#sla-dampening">#</a></h3>
<p>Uno de los beneficios de EAAR es dirigir el tr√°fico en segundos en lugar de minutos, pero ¬øqu√© pasar√≠a si hay condiciones de red transitorias que hacen que los transportes no cumplan con el SLA cada pocos minutos? El tr√°fico cambiar√≠a constantemente entre los transportes, lo que no es un escenario deseable y la raz√≥n por la cual se introdujo el <em>dampening</em>.</p>
<p>La idea general es que cuando un enlace de transporte deja de cumplir con el SLA, el tr√°fico se redirige a una ruta alternativa. Una vez que el transporte vuelve a estar en cumplimiento, el dispositivo no mueve el tr√°fico de inmediato. En su lugar, inicia un temporizador para asegurarse de que el enlace permanezca estable durante un per√≠odo determinado antes de reutilizarlo.</p>
<p>Al final, el dampening ayuda a evitar cambios innecesarios en el tr√°fico, lo que podr√≠a afectar negativamente el rendimiento debido a la inestabilidad del transporte.</p>
<h2 id="configuraci√≥n-de-eaar">Configuraci√≥n de EAAR<a hidden class="anchor" aria-hidden="true" href="#configuraci√≥n-de-eaar">#</a></h2>
<p>Para habilitar EAAR tenemos tres opciones predefinidas:</p>
<table>
  <thead>
      <tr>
          <th>Mode</th>
          <th>Poll Interval</th>
          <th>Poll Multiplier</th>
          <th>Dampening Multiplier</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Aggressive</td>
          <td>10s</td>
          <td>6 (10s-60s)</td>
          <td>120 (20 mins)</td>
      </tr>
      <tr>
          <td>Moderate</td>
          <td>60s</td>
          <td>5 (60s-300s)</td>
          <td>40  (40 mins)</td>
      </tr>
      <tr>
          <td>Conservative</td>
          <td>300s</td>
          <td>6 (300s-1800s)</td>
          <td>12  (60 mins)</td>
      </tr>
  </tbody>
</table>
<p><strong>Nota</strong> Para usar tiempos personalizados, la configuraci√≥n debe hacerse a trav√©s de plantillas CLI.</p>
<p>EAAR sigue el mismo principio fundamental que AAR, utilizando buckets que van rotando para calcular la p√©rdida promedio, la latencia y la jitter. Con el modo <em>aggressive</em>, el tr√°fico tomar√≠a entre 10 y 60 segundos en cambiar, dependiendo de qu√© tan severo sea el deterioro.</p>
<p>El <em>Dampening Multiplier</em> (<em>poll interval</em> <strong>x</strong> <em>Dampening Multiplier</em>) es de 1200 segundos, lo que significa que antes de cambiar el tr√°fico a un transporte, debe ser estable durante 20 minutos.</p>
<p>En mi laboratorio, estoy usando <em>Configuration Groups</em>, sin embargo, esto est√° <a href="https://www.cisco.com/c/en/us/td/docs/routers/sdwan/configuration/policies/ios-xe-17/policies-book-xe/m-enhanced-application-aware-routing.html#configure-enhanced-application-aware-routing-using-a-feature-template-in-cisco-sd-wan-manager" target="_blank" rel="nofollow noopener noreferrer">disponible a trav√©s de Templates</a> tambi√©n.</p>
<p><img loading="lazy" src="/wp-content/uploads/2025/02/eaar-config-groups.png"></p>
<p>Puedes usar una variable, en lugar de un valor global, para que sea aplicable tambi√©n a los dispositivos que no correr√°n EAAR. En este caso, los dispositivos habilitados para EAAR har√°n <em>fallback</em> a AAR.</p>
<p>La siguiente configuraci√≥n se agrega a los dispositivos:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>  bfd enhanced-app-route enable
</span></span><span style="display:flex;"><span>  bfd enhanced-app-route pfr-poll-interval 10000
</span></span><span style="display:flex;"><span>  bfd enhanced-app-route pfr-multiplier 6
</span></span><span style="display:flex;"><span>  bfd sla-dampening enable
</span></span><span style="display:flex;"><span>  bfd sla-dampening multiplier 120
</span></span></code></pre></div><p>Veamos c√≥mo funciona</p>
<h2 id="demo">Demo<a hidden class="anchor" aria-hidden="true" href="#demo">#</a></h2>
<p>En mi laboratorio, uso el Manager con versi√≥n 20.16.1 y mis dispositivos con 17.15.1a</p>
<p><strong>Nota</strong> La versi√≥n m√≠nima requerida es 20.12/17.12</p>
<p>Comencemos con algunas verificaciones despu√©s de aplicar la configuraci√≥n.</p>
<p>Para verificar los temporizadores y multiplicadores configurados</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10#show sdwan app-route params
</span></span><span style="display:flex;"><span>Enhanced Application-Aware routing
</span></span><span style="display:flex;"><span>    Config:                  :Enabled   
</span></span><span style="display:flex;"><span>    Poll interval:           :10000     
</span></span><span style="display:flex;"><span>    Poll multiplier:         :6         
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>App route 
</span></span><span style="display:flex;"><span>    Poll interval:           :120000    
</span></span><span style="display:flex;"><span>    Poll multiplier:         :5         
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SLA dampening  
</span></span><span style="display:flex;"><span>    Config:                  :Enabled   
</span></span><span style="display:flex;"><span>    Multiplier:              :120    
</span></span></code></pre></div><p>Para verificar qu√© sesiones de BFD est√°n utilizando EAAR, busca la columna <em>Flags</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10#show sdwan bfd sessions alt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                                  SOURCE TLOC      REMOTE TLOC                     DST PUBLIC    DST PUBLIC                                  
</span></span><span style="display:flex;"><span>SYSTEM IP   SITE ID   STATE       COLOR            COLOR            SOURCE IP      IP            PORT        ENCAP  BFD-LD    FLAGS   UPTIME    
</span></span><span style="display:flex;"><span>-------------------------------------------------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>1.1.1.20    200       up          biz-internet     biz-internet     30.1.10.2      30.1.20.2     12406       ipsec  20006     EAAR    0:00:20:31 
</span></span><span style="display:flex;"><span>1.1.1.20    200       up          mpls             mpls             30.2.10.2      30.2.20.2     12366       ipsec  20002     EAAR    0:00:20:38 
</span></span><span style="display:flex;"><span>1.1.1.20    200       up          private1         private1         30.3.10.2      30.3.20.2     12366       ipsec  20003     EAAR    0:00:20:37 
</span></span></code></pre></div><p>Para obtener m√°s detalles sobre un t√∫nel espec√≠fico.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10#show sdwan app-route stats summary 
</span></span><span style="display:flex;"><span>Generating output, this might take time, please wait ...
</span></span><span style="display:flex;"><span>app-route statistics 30.1.10.2 30.1.20.2 ipsec 12386 12406
</span></span><span style="display:flex;"><span> remote-system-ip         1.1.1.20
</span></span><span style="display:flex;"><span> local-color              biz-internet
</span></span><span style="display:flex;"><span> remote-color             biz-internet
</span></span><span style="display:flex;"><span> sla-class-index          0,1,2
</span></span><span style="display:flex;"><span> fallback-sla-class-index None
</span></span><span style="display:flex;"><span> enhanced-app-route       Enabled
</span></span><span style="display:flex;"><span> sla-dampening-index      None
</span></span><span style="display:flex;"><span> app-probe-class-list None
</span></span><span style="display:flex;"><span>  mean-loss    0.000
</span></span><span style="display:flex;"><span>  mean-latency 0
</span></span><span style="display:flex;"><span>  mean-jitter  0
</span></span><span style="display:flex;"><span>       TOTAL                       AVERAGE  AVERAGE  TX DATA       RX DATA       IPV6 TX       IPV6 RX       
</span></span><span style="display:flex;"><span>INDEX  PACKETS       LOSS          LATENCY  JITTER   PKTS          PKTS          DATA PKTS     DATA PKTS     
</span></span><span style="display:flex;"><span>-------------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>0      0             0             0        0        0             0             0             0             
</span></span><span style="display:flex;"><span>1      64            0             0        0        0             0             0             0             
</span></span><span style="display:flex;"><span>2      0             0             0        0        0             0             0             0             
</span></span><span style="display:flex;"><span>3      0             0             0        0        0             0             0             0             
</span></span><span style="display:flex;"><span>4      0             0             0        0        0             0             0             0             
</span></span><span style="display:flex;"><span>5      64            0             0        0        0             0             0             0             
</span></span></code></pre></div><p>Nota que no hay tr√°fico entre mis dispositivos, por lo que el recuento total de paquetes en cada <em>bucket</em> es bajo.</p>
<p>La misma informaci√≥n est√° disponible a trav√©s de la interfaz gr√°fica, utilizando la opci√≥n de <em>Real Time</em> &gt; <em>App Route Statistics</em></p>
<p><img loading="lazy" src="/wp-content/uploads/2025/02/eaar-1.png"></p>
<h3 id="escenario-1---deterioro-ligero">Escenario 1 - Deterioro ligero<a hidden class="anchor" aria-hidden="true" href="#escenario-1---deterioro-ligero">#</a></h3>
<p>Esta es la topolog√≠a de mi laboratorio</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/02/aar-topo2.png"></p>
<p>Para esta primera prueba, usar√© los siguientes par√°metros de SLA:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SLA_Real-Time 
</span></span><span style="display:flex;"><span>Loss: 3%
</span></span><span style="display:flex;"><span>Latency: 150ms
</span></span><span style="display:flex;"><span>Jitter: 100ms
</span></span></code></pre></div><p>La pol√≠tica AAR indica que:</p>
<ul>
<li>Use MPLS como transporte principal</li>
<li>Si ning√∫n color cumple con el SLA y Private1 est√° disponible, usarlo.</li>
<li>Si Private1 no est√° disponible, se hace <em>load balance</em> entre todos los colores restantes.</li>
</ul>
<p>Estoy haciendo match del tr√°fico entre 172.16.10.0/24 y 172.16.20.0/24.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10#show sdwan policy from-vsmart
</span></span><span style="display:flex;"><span>from-vsmart app-route-policy app_route_AAR
</span></span><span style="display:flex;"><span> vpn-list vpn_Corporate_Users
</span></span><span style="display:flex;"><span>  sequence 1
</span></span><span style="display:flex;"><span>   match
</span></span><span style="display:flex;"><span>    source-data-prefix-list      BR10
</span></span><span style="display:flex;"><span>    destination-data-prefix-list BR20
</span></span><span style="display:flex;"><span>   action
</span></span><span style="display:flex;"><span>    backup-sla-preferred-color private1
</span></span><span style="display:flex;"><span>    sla-class       SLA_Real-Time
</span></span><span style="display:flex;"><span>    no sla-class strict
</span></span><span style="display:flex;"><span>    sla-class preferred-color mpls
</span></span><span style="display:flex;"><span>  sequence 11
</span></span><span style="display:flex;"><span>   match
</span></span><span style="display:flex;"><span>    source-data-prefix-list      BR20
</span></span><span style="display:flex;"><span>    destination-data-prefix-list BR10
</span></span><span style="display:flex;"><span>   action
</span></span><span style="display:flex;"><span>    backup-sla-preferred-color private1
</span></span><span style="display:flex;"><span>    sla-class       SLA_Real-Time
</span></span><span style="display:flex;"><span>    no sla-class strict
</span></span><span style="display:flex;"><span>    sla-class preferred-color mpls
</span></span></code></pre></div><p>Estado inicial sin deterioro en la red</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10#show sdwan app-route stats summary | i color|damp|mean         
</span></span><span style="display:flex;"><span> local-color              biz-internet
</span></span><span style="display:flex;"><span> remote-color             biz-internet
</span></span><span style="display:flex;"><span> sla-dampening-index      None
</span></span><span style="display:flex;"><span>  mean-loss    0.000
</span></span><span style="display:flex;"><span>  mean-latency 1
</span></span><span style="display:flex;"><span>  mean-jitter  0
</span></span><span style="display:flex;"><span> local-color              mpls
</span></span><span style="display:flex;"><span> remote-color             mpls
</span></span><span style="display:flex;"><span> sla-dampening-index      None
</span></span><span style="display:flex;"><span>  mean-loss    1.212
</span></span><span style="display:flex;"><span>  mean-latency 1
</span></span><span style="display:flex;"><span>  mean-jitter  0
</span></span><span style="display:flex;"><span>  mean-loss    1.212
</span></span><span style="display:flex;"><span>  mean-latency 1
</span></span><span style="display:flex;"><span>  mean-jitter  0
</span></span><span style="display:flex;"><span> local-color              private1
</span></span><span style="display:flex;"><span> remote-color             private1
</span></span><span style="display:flex;"><span> sla-dampening-index      None
</span></span><span style="display:flex;"><span>  mean-loss    0.000
</span></span><span style="display:flex;"><span>  mean-latency 0
</span></span><span style="display:flex;"><span>  mean-jitter  0
</span></span><span style="display:flex;"><span>  mean-loss    0.000
</span></span><span style="display:flex;"><span>  mean-latency 0
</span></span><span style="display:flex;"><span>  mean-jitter  0
</span></span></code></pre></div><p>Observa que el n√∫mero de paquetes por bucket aument√≥ dram√°ticamente</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10#show sdwan app-route stats remote-color mpls summary  
</span></span><span style="display:flex;"><span>Generating output, this might take time, please wait ...
</span></span><span style="display:flex;"><span>app-route statistics 30.2.10.2 30.2.20.2 ipsec 12366 12366
</span></span><span style="display:flex;"><span> remote-system-ip         1.1.1.20
</span></span><span style="display:flex;"><span> local-color              mpls
</span></span><span style="display:flex;"><span> remote-color             mpls
</span></span><span style="display:flex;"><span> sla-class-index          0,1
</span></span><span style="display:flex;"><span> fallback-sla-class-index None
</span></span><span style="display:flex;"><span> enhanced-app-route       Enabled
</span></span><span style="display:flex;"><span> sla-dampening-index      None
</span></span><span style="display:flex;"><span> app-probe-class-list None
</span></span><span style="display:flex;"><span>  mean-loss    1.176
</span></span><span style="display:flex;"><span>  mean-latency 0
</span></span><span style="display:flex;"><span>  mean-jitter  0
</span></span><span style="display:flex;"><span>       TOTAL                       AVERAGE  AVERAGE  TX DATA       RX DATA       IPV6 TX       IPV6 RX       
</span></span><span style="display:flex;"><span>INDEX  PACKETS       LOSS          LATENCY  JITTER   PKTS          PKTS          DATA PKTS     DATA PKTS     
</span></span><span style="display:flex;"><span>-------------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>0      131136        1501          0        0        100084        20846         0             0             
</span></span><span style="display:flex;"><span>1      131072        1438          0        0        95287         19605         0             0             
</span></span><span style="display:flex;"><span>2      131072        1400          0        0        100985        20937         0             0             
</span></span><span style="display:flex;"><span>3      131072        1781          0        0        85553         18271         0             0             
</span></span><span style="display:flex;"><span>4      64            0             0        0        72618         15942         0             0             
</span></span><span style="display:flex;"><span>5      131072        1589          0        0        65198         14226         0             0             
</span></span><span style="display:flex;"><span>          
</span></span></code></pre></div><p>El tr√°fico est√° utilizando MPLS como transporte primario</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10# show sdwan policy service-path vpn 10 interface gigabitEthernet 4 source-ip 172.16.10.10 dest-ip 172.16.20.10 protocol 6 all       
</span></span><span style="display:flex;"><span>Number of possible next hops: 1
</span></span><span style="display:flex;"><span>Next Hop: IPsec
</span></span><span style="display:flex;"><span>  Source: 30.2.10.2 12366 Destination: 30.2.20.2 12366 Local Color: mpls Remote Color: mpls Remote System IP: 1.1.1.20
</span></span></code></pre></div><p>Introduzco el 3% de p√©rdida de paquetes en el transporte MPLS y ver√© cu√°nto tiempo lleva cambiar el tr√°fico. Dado que ya hay alrededor del 1% de p√©rdida, el 3% deber√≠a ser suficiente para activar un cambio.</p>
<p>El transporte MPLS tiene m√°s del 3% de p√©rdida</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10#show sdwan app-route stats remote-color mpls summary 
</span></span><span style="display:flex;"><span>Generating output, this might take time, please wait ...
</span></span><span style="display:flex;"><span>app-route statistics 30.2.10.2 30.2.20.2 ipsec 12366 12366
</span></span><span style="display:flex;"><span> remote-system-ip         1.1.1.20
</span></span><span style="display:flex;"><span> local-color              mpls
</span></span><span style="display:flex;"><span> remote-color             mpls
</span></span><span style="display:flex;"><span> sla-class-index          0
</span></span><span style="display:flex;"><span> fallback-sla-class-index 1
</span></span><span style="display:flex;"><span> enhanced-app-route       Enabled
</span></span><span style="display:flex;"><span> sla-dampening-index      None
</span></span><span style="display:flex;"><span> app-probe-class-list None
</span></span><span style="display:flex;"><span>  mean-loss    3.125          &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
</span></span><span style="display:flex;"><span>  mean-latency 0
</span></span><span style="display:flex;"><span>  mean-jitter  0
</span></span></code></pre></div><p>Despu√©s de 56 segundos, el tr√°fico cambi√≥ y cualquiera de los transportes que cumplen el SLA podr√≠a usarse</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10# show sdwan policy service-path vpn 10 interface gigabitEthernet 4 source-ip 172.16.10.10 dest-ip 172.16.20.10 protocol 6 all
</span></span><span style="display:flex;"><span>Number of possible next hops: 2
</span></span><span style="display:flex;"><span>Next Hop: IPsec
</span></span><span style="display:flex;"><span>  Source: 30.3.10.2 12366 Destination: 30.3.20.2 12366 Local Color: private1 Remote Color: private1 Remote System IP: 1.1.1.20
</span></span><span style="display:flex;"><span>Next Hop: IPsec
</span></span><span style="display:flex;"><span>  Source: 30.1.10.2 12386 Destination: 30.1.20.2 12366 Local Color: biz-internet Remote Color: biz-internet Remote System IP: 1.1.1.20
</span></span></code></pre></div><p>Si quito la p√©rdida, podemos ver que el mecanismo de <em>dampening</em> se activa. Entonces, si el transporte es estable durante 20 minutos, se volver√° a utilizar como ruta preferida.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10#show sdwan app-route stats remote-color mpls summary 
</span></span><span style="display:flex;"><span>Generating output, this might take time, please wait ...
</span></span><span style="display:flex;"><span>app-route statistics 30.2.10.2 30.2.20.2 ipsec 12366 12366
</span></span><span style="display:flex;"><span> remote-system-ip         1.1.1.20
</span></span><span style="display:flex;"><span> local-color              mpls
</span></span><span style="display:flex;"><span> remote-color             mpls
</span></span><span style="display:flex;"><span> sla-class-index          0
</span></span><span style="display:flex;"><span> fallback-sla-class-index 1
</span></span><span style="display:flex;"><span> enhanced-app-route       Enabled
</span></span><span style="display:flex;"><span> sla-dampening-index      1        &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
</span></span><span style="display:flex;"><span> app-probe-class-list None
</span></span><span style="display:flex;"><span>  mean-loss    0.000
</span></span><span style="display:flex;"><span>  mean-latency 0
</span></span><span style="display:flex;"><span>  mean-jitter  0
</span></span></code></pre></div><h3 id="escenario-2---mayor-deterioro">Escenario 2 - Mayor deterioro<a hidden class="anchor" aria-hidden="true" href="#escenario-2---mayor-deterioro">#</a></h3>
<p>En este caso, introducir√© una p√©rdida de paquetes del 10% para el transporte de biz-internet, lo que hace que private1 sea el √∫nico transporte cumpliendo el SLA.</p>
<p>Despu√©s de alrededor de 45 segundos, la p√©rdida de Biz-Internet fue de 12%</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10#show sdwan app-route stats local-color biz-internet summary         
</span></span><span style="display:flex;"><span>Generating output, this might take time, please wait ...
</span></span><span style="display:flex;"><span>app-route statistics 30.1.10.2 30.1.20.2 ipsec 12386 12366
</span></span><span style="display:flex;"><span> remote-system-ip         1.1.1.20
</span></span><span style="display:flex;"><span> local-color              biz-internet
</span></span><span style="display:flex;"><span> remote-color             biz-internet
</span></span><span style="display:flex;"><span> sla-class-index          0
</span></span><span style="display:flex;"><span> fallback-sla-class-index 1
</span></span><span style="display:flex;"><span> enhanced-app-route       Enabled
</span></span><span style="display:flex;"><span> sla-dampening-index      None
</span></span><span style="display:flex;"><span> app-probe-class-list None
</span></span><span style="display:flex;"><span>  mean-loss    12.500
</span></span><span style="display:flex;"><span>  mean-latency 0
</span></span><span style="display:flex;"><span>  mean-jitter  0
</span></span></code></pre></div><p>El tr√°fico cambi√≥ a private1 exclusivamente</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10#show sdwan policy service-path vpn 10 interface gigabitEthernet 4 source-ip 172.16.10.10 dest-ip 172.16.20.10 protocol 6 all
</span></span><span style="display:flex;"><span>Number of possible next hops: 1
</span></span><span style="display:flex;"><span>Next Hop: IPsec
</span></span><span style="display:flex;"><span>  Source: 30.3.10.2 12366 Destination: 30.3.20.2 12366 Local Color: private1 Remote Color: private1 Remote System IP: 1.1.1.20
</span></span></code></pre></div><p>Despu√©s de eliminar la p√©rdida de paquetes, Biz-Internet tiene el mecanismo de dampening activado</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10#show sdwan app-route stats local-color biz-internet summary 
</span></span><span style="display:flex;"><span>Generating output, this might take time, please wait ...
</span></span><span style="display:flex;"><span>app-route statistics 30.1.10.2 30.1.20.2 ipsec 12386 12366
</span></span><span style="display:flex;"><span> remote-system-ip         1.1.1.20
</span></span><span style="display:flex;"><span> local-color              biz-internet
</span></span><span style="display:flex;"><span> remote-color             biz-internet
</span></span><span style="display:flex;"><span> sla-class-index          0
</span></span><span style="display:flex;"><span> fallback-sla-class-index 1
</span></span><span style="display:flex;"><span> enhanced-app-route       Enabled
</span></span><span style="display:flex;"><span> sla-dampening-index      1         &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
</span></span><span style="display:flex;"><span> app-probe-class-list None
</span></span><span style="display:flex;"><span>  mean-loss    1.562
</span></span><span style="display:flex;"><span>  mean-latency 0
</span></span><span style="display:flex;"><span>  mean-jitter  0
</span></span></code></pre></div><p>En este caso, el tiempo para cambiar el tr√°fico se redujo como consecuencia de un deterioro mayor.</p>
<h3 id="escenario-3----m√∫ltiples-app-probe-class">Escenario 3 -  M√∫ltiples App Probe Class<a hidden class="anchor" aria-hidden="true" href="#escenario-3----m√∫ltiples-app-probe-class">#</a></h3>
<p>Para este escenario final, veamos c√≥mo obtener el mayor beneficio de EAAR.</p>
<p>La configuraci√≥n es m√°s compleja ya que involucra QoS, App Probe Class y pol√≠tica AAR.</p>
<ul>
<li>Se requiere QoS para clasificar y enviar tr√°fico en diferentes colas.</li>
<li>App Probe Class para medir la p√©rdida, la latencia y el jitter en cada una de esas colas, de forma independiente.</li>
</ul>
<p>Mi configuraci√≥n de QoS tiene 3 colas y la cola 2 manejar√° el tr√°fico menos importante.</p>
<ul>
<li>cola 0 para el tr√°fico de control</li>
<li>cola 1 para tr√°fico en tiempo real (marcado DSCP 46)</li>
<li>cola 2 para tr√°fico transaccional (marcado DSCP 18)</li>
</ul>
<p>Utilizo una pol√≠tica de datos para hacer match del tr√°fico en el lado del servicio, marcarlo con el DSCP correcto y ponerla en la clase de QoS correcta. Tambi√©n cre√© un shaper en mi interfaz MPLS.</p>
<p>Para demostrar las cosas, tendr√© dos transferencias de datos:</p>
<ul>
<li>HTTP GET (puerto 8000)</li>
<li>Copia SCP (puerto 22)</li>
</ul>
<p>Mis SLA tienen las siguientes configuraciones:</p>
<table>
  <thead>
      <tr>
          <th>SLA Class Name</th>
          <th>Loss</th>
          <th>Latency</th>
          <th>Jitter</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>SLA_Real-Time</td>
          <td>3 %</td>
          <td>150 ms</td>
          <td>100 ms</td>
      </tr>
      <tr>
          <td>SLA_Transactional</td>
          <td>5 %</td>
          <td>45 ms</td>
          <td>150 ms</td>
      </tr>
  </tbody>
</table>
<p>Lo primero que hay que notar es que mis dos clases de sondeo de aplicaciones se miden de manera independiente. Observa c√≥mo la <strong><em>p√©rdida media</em></strong> para <em>Transactional-Probe_Class</em> es <strong>1</strong>, mientras que para <em>Real_Time_Probe_Class</em> es <strong>0</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10#show sdwan app-route stats local-color mpls summary 
</span></span><span style="display:flex;"><span>Generating output, this might take time, please wait ...
</span></span><span style="display:flex;"><span>app-route statistics 30.2.10.2 30.2.20.2 ipsec 12366 12366
</span></span><span style="display:flex;"><span> remote-system-ip         1.1.1.20
</span></span><span style="display:flex;"><span> local-color              mpls
</span></span><span style="display:flex;"><span> remote-color             mpls
</span></span><span style="display:flex;"><span> sla-class-index          0,1,2
</span></span><span style="display:flex;"><span> fallback-sla-class-index None
</span></span><span style="display:flex;"><span> enhanced-app-route       Enabled
</span></span><span style="display:flex;"><span> sla-dampening-index      None
</span></span><span style="display:flex;"><span> app-probe-class-list None
</span></span><span style="display:flex;"><span>  mean-loss    0.000
</span></span><span style="display:flex;"><span>  mean-latency 1
</span></span><span style="display:flex;"><span>  mean-jitter  0
</span></span><span style="display:flex;"><span>       TOTAL                       AVERAGE  AVERAGE  TX DATA       RX DATA       IPV6 TX       IPV6 RX       
</span></span><span style="display:flex;"><span>INDEX  PACKETS       LOSS          LATENCY  JITTER   PKTS          PKTS          DATA PKTS     DATA PKTS     
</span></span><span style="display:flex;"><span>-------------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>0      16384         0             0        0        35827         111807        0             0             
</span></span><span style="display:flex;"><span>1      49152         0             1        0        37788         118236        0             0             
</span></span><span style="display:flex;"><span>2      49216         0             1        0        36859         115551        0             0             
</span></span><span style="display:flex;"><span>3      16384         0             1        0        23894         77280         0             0             
</span></span><span style="display:flex;"><span>4      32768         0             1        1        33179         103759        0             0             
</span></span><span style="display:flex;"><span>5      32768         0             1        0        21485         71702         0             0             
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> app-probe-class-list Real_Time_Probe_Class
</span></span><span style="display:flex;"><span>  mean-loss    0.000
</span></span><span style="display:flex;"><span>  mean-latency 0
</span></span><span style="display:flex;"><span>  mean-jitter  0
</span></span><span style="display:flex;"><span>       TOTAL                       AVERAGE  AVERAGE  TX DATA       RX DATA       IPV6 TX       IPV6 RX       
</span></span><span style="display:flex;"><span>INDEX  PACKETS       LOSS          LATENCY  JITTER   PKTS          PKTS          DATA PKTS     DATA PKTS     
</span></span><span style="display:flex;"><span>-------------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>0      0             0             0        0        -             -             -             -             
</span></span><span style="display:flex;"><span>1      32768         0             1        0        -             -             -             -             
</span></span><span style="display:flex;"><span>2      32768         0             0        0        -             -             -             -             
</span></span><span style="display:flex;"><span>3      0             0             0        0        -             -             -             -             
</span></span><span style="display:flex;"><span>4      32768         0             1        2        -             -             -             -             
</span></span><span style="display:flex;"><span>5      0             0             0        0        -             -             -             -             
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> app-probe-class-list Transactional-Probe_Class
</span></span><span style="display:flex;"><span>  mean-loss    0.000
</span></span><span style="display:flex;"><span>  mean-latency 1
</span></span><span style="display:flex;"><span>  mean-jitter  0
</span></span><span style="display:flex;"><span>       TOTAL                       AVERAGE  AVERAGE  TX DATA       RX DATA       IPV6 TX       IPV6 RX       
</span></span><span style="display:flex;"><span>INDEX  PACKETS       LOSS          LATENCY  JITTER   PKTS          PKTS          DATA PKTS     DATA PKTS     
</span></span><span style="display:flex;"><span>-------------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>0      16384         0             0        0        -             -             -             -             
</span></span><span style="display:flex;"><span>1      49152         0             1        0        -             -             -             -             
</span></span><span style="display:flex;"><span>2      49216         0             1        0        -             -             -             -             
</span></span><span style="display:flex;"><span>3      16384         0             1        0        -             -             -             -             
</span></span><span style="display:flex;"><span>4      32768         0             1        1        -             -             -             -             
</span></span><span style="display:flex;"><span>5      32768         0             1        0        -             -             -             -             
</span></span></code></pre></div><p>Ahora, he bajado mi shaper. EAAR fue r√°pido en detectar un cambio en la latencia para el SLA <em>Transactional</em>, ahora son 53 ms.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10# show sdwan app-route stats local mpls summary
</span></span><span style="display:flex;"><span>Generating output, this might take time, please wait ...
</span></span><span style="display:flex;"><span>app-route statistics 30.2.10.2 30.2.20.2 ipsec 12386 12366
</span></span><span style="display:flex;"><span> remote-system-ip         1.1.1.20
</span></span><span style="display:flex;"><span> local-color              mpls
</span></span><span style="display:flex;"><span> remote-color             mpls
</span></span><span style="display:flex;"><span> sla-class-index          0,1,2
</span></span><span style="display:flex;"><span> fallback-sla-class-index None
</span></span><span style="display:flex;"><span> enhanced-app-route       Enabled
</span></span><span style="display:flex;"><span> sla-dampening-index      None
</span></span><span style="display:flex;"><span> app-probe-class-list None
</span></span><span style="display:flex;"><span>  mean-loss    0.000
</span></span><span style="display:flex;"><span>  mean-latency 53
</span></span><span style="display:flex;"><span>  mean-jitter  0
</span></span><span style="display:flex;"><span>       TOTAL                       AVERAGE  AVERAGE  TX DATA       RX DATA       IPV6 TX       IPV6 RX       
</span></span><span style="display:flex;"><span>INDEX  PACKETS       LOSS          LATENCY  JITTER   PKTS          PKTS          DATA PKTS     DATA PKTS     
</span></span><span style="display:flex;"><span>-------------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>0      2048          0             54       0        4396          8513          0             0             
</span></span><span style="display:flex;"><span>1      1024          0             55       0        4461          8534          0             0             
</span></span><span style="display:flex;"><span>2      8256          0             49       0        4429          8549          0             0             
</span></span><span style="display:flex;"><span>3      16384         0             54       0        4411          8549          0             0             
</span></span><span style="display:flex;"><span>4      0             0             53       0        4440          8549          0             0             
</span></span><span style="display:flex;"><span>5      0             0             54       0        4443          8549          0             0             
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> app-probe-class-list Real_Time_Probe_Class
</span></span><span style="display:flex;"><span>  mean-loss    0.000
</span></span><span style="display:flex;"><span>  mean-latency 0
</span></span><span style="display:flex;"><span>  mean-jitter  0
</span></span><span style="display:flex;"><span>       TOTAL                       AVERAGE  AVERAGE  TX DATA       RX DATA       IPV6 TX       IPV6 RX       
</span></span><span style="display:flex;"><span>INDEX  PACKETS       LOSS          LATENCY  JITTER   PKTS          PKTS          DATA PKTS     DATA PKTS     
</span></span><span style="display:flex;"><span>-------------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>0      0             0             0        0        -             -             -             -             
</span></span><span style="display:flex;"><span>1      0             0             0        0        -             -             -             -             
</span></span><span style="display:flex;"><span>2      8192          0             0        0        -             -             -             -             
</span></span><span style="display:flex;"><span>3      16384         0             0        0        -             -             -             -             
</span></span><span style="display:flex;"><span>4      0             0             0        0        -             -             -             -             
</span></span><span style="display:flex;"><span>5      0             0             0        0        -             -             -             -             
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> app-probe-class-list Transactional-Probe_Class
</span></span><span style="display:flex;"><span>  mean-loss    0.000
</span></span><span style="display:flex;"><span>  mean-latency 53    &lt;&lt;&lt;&lt;&lt;&lt;&lt;
</span></span><span style="display:flex;"><span>  mean-jitter  0
</span></span><span style="display:flex;"><span>       TOTAL                       AVERAGE  AVERAGE  TX DATA       RX DATA       IPV6 TX       IPV6 RX       
</span></span><span style="display:flex;"><span>INDEX  PACKETS       LOSS          LATENCY  JITTER   PKTS          PKTS          DATA PKTS     DATA PKTS     
</span></span><span style="display:flex;"><span>-------------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>0      2048          0             54       0        -             -             -             -             
</span></span><span style="display:flex;"><span>1      1024          0             55       0        -             -             -             -             
</span></span><span style="display:flex;"><span>2      8256          0             49       0        -             -             -             -             
</span></span><span style="display:flex;"><span>3      16384         0             54       0        -             -             -             -             
</span></span><span style="display:flex;"><span>4      0             0             53       0        -             -             -             -             
</span></span><span style="display:flex;"><span>5      0             0             54       0        -             -             -             -             
</span></span></code></pre></div><p>Ahora que no se cumple mi SLA <em>Transactional</em> con una latencia m√°xima de 45 ms, usar√© <a href="/Network-Wide-Path-Insights-An-Introduction/">NWPI</a> para comprender c√≥mo se env√≠a el tr√°fico. Examinemos el tr√°fico HTTP con el puerto 80000</p>
<p><img loading="lazy" src="/wp-content/uploads/2025/02/eaar-nwpi-8000.png"></p>
<p>Observa que, en la direcci√≥n <em>upstream</em>, el color <em>local</em> y <em>remote</em> es <strong>private1</strong>, lo que indica que el tr√°fico se ha alejado de MPLS y su latencia de 53 ms. Justo lo que esper√°bamos ‚úÖ</p>
<p>Ahora, veamos c√≥mo est√° fluyendo el tr√°fico en el puerto 22</p>
<p><img loading="lazy" src="/wp-content/uploads/2025/02/eaar-nwpi-22.png"></p>
<p>Una vez m√°s, observa el <em>local</em> y <em>Remote Color</em> en la direcci√≥n <em>upstream</em>, observa c√≥mo <strong>MPLS</strong> todav√≠a est√° en uso para este tr√°fico, ya que no hay problemas en los transportes para este tipo de tr√°fico.</p>
<p>En resumen, el tr√°fico con DSCP 46 funciona perfectamente bien en el transporte MPLS, sin embargo, el tr√°fico con DSCP 18 estaba teniendo m√°s latencia que el SLA configurado, por lo que se traslad√≥ a Private1 ya que cumple con el SLA.</p>
<p>Podemos confirmar que estamos midiendo y tomando decisiones de ruteo <em>per queue</em>, esta es una gran diferencia ü§Ø!</p>
<h2 id="lecciones-aprendidas">Lecciones aprendidas<a hidden class="anchor" aria-hidden="true" href="#lecciones-aprendidas">#</a></h2>
<ul>
<li>Utilizando <em>inline data</em>, el n√∫mero de muestras aumenta dram√°ticamente en comparaci√≥n con el tama√±o de muestra de BFD. üìà</li>
<li>EAAR puede redirigir el tr√°fico en segundos, en lugar de minutos. ‚è©</li>
<li>EAAR ofrece los mayores beneficios en los transportes con QoS, como MPLS. üöÄ</li>
<li>Incluso en los transportes sin QoS, las mediciones de <em>inline data</em> aumentan el tama√±o y la precisi√≥n de las muestras. ‚è≥</li>
<li>El temporizador de dampening es √∫til para garantizar que los transportes sean estables antes de marcarlos como v√°lidos. ‚úÖ</li>
<li>La interoperabilidad entre dispositivos que ejecutan EAAR y dispositivos que ejecutan AAR es posible üîÑ</li>
</ul>
<p>¬°Espero que hayas aprendido algo √∫til! Nos vemos en el siguiente üëã</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer><script src="https://utteranc.es/client.js"
        repo="aruiz-p/netwithalex"
        issue-term="title"
        label="comments"
        theme="preferred-color-scheme"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/es/">NetWithAlex</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copiar';

        function copyingDone() {
            copybutton.innerHTML = '¬°copiado!';
            setTimeout(() => {
                copybutton.innerHTML = 'copiar';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
