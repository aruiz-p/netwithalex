<!DOCTYPE html>
<html lang="es" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Seguimiento de incidentes SD-WAN con ServiceNow | NetWithAlex</title>
<meta name="keywords" content="">
<meta name="description" content="Aprenda a integrar Cisco SD-WAN con ServiceNow y automatiza la gestión de incidentes">
<meta name="author" content="Alex">
<link rel="canonical" href="http://localhost:1313/rastreando-incidentes-de-sdwan-con-servicenow/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/assets/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/tracking-sd-wan-incidents-with-service-now/">
<link rel="alternate" hreflang="es" href="http://localhost:1313/rastreando-incidentes-de-sdwan-con-servicenow/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>















    
        <link rel="preconnect" href="https://plausible.io">
    
        <!-- Dev mode : We do not load plausible script to avoid bloating your stats -->

<!-- If you are using Content-Security-Policy, do not forget to add this code to your CSP : 
  script-src 'unsafe-inline' https://plausible.io
  connect-src 'unsafe-inline' https://plausible.io
  or just add the partial 'plausible_csp.html' to those 2 csp directives in your 'index.headers' file
-->



    
    <script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>
    <script>
         
         
         
    </script>

    
<meta property="og:url" content="http://localhost:1313/rastreando-incidentes-de-sdwan-con-servicenow/">
  <meta property="og:site_name" content="NetWithAlex">
  <meta property="og:title" content="Seguimiento de incidentes SD-WAN con ServiceNow">
  <meta property="og:description" content="Aprenda a integrar Cisco SD-WAN con ServiceNow y automatiza la gestión de incidentes">
  <meta property="og:locale" content="es">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-15T18:06:34+00:00">
    <meta property="article:modified_time" content="2024-03-15T18:06:34+00:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Seguimiento de incidentes SD-WAN con ServiceNow">
<meta name="twitter:description" content="Aprenda a integrar Cisco SD-WAN con ServiceNow y automatiza la gestión de incidentes">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/es/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Seguimiento de incidentes SD-WAN con ServiceNow",
      "item": "http://localhost:1313/rastreando-incidentes-de-sdwan-con-servicenow/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Seguimiento de incidentes SD-WAN con ServiceNow",
  "name": "Seguimiento de incidentes SD-WAN con ServiceNow",
  "description": "Aprenda a integrar Cisco SD-WAN con ServiceNow y automatiza la gestión de incidentes",
  "keywords": [
    
  ],
  "articleBody": "Introducción A medida que las redes evolucionan para ofrecer una mejor experiencia de usuario y se introducen nuevas tecnologías para gestionar la red, mantener todo funcionando sin problemas se ha vuelto cada vez más difícil. Una de las responsabilidades más críticas del equipo de operaciones es hacer un seguimiento de los problemas que ocurren en toda la red. Identificarlos es solo el comienzo, luego deben ser registrados y gestionados hasta su resolución. ¡Multiplica la cantidad de acciones por incidente y tendrás suficiente para mantener ocupado a tu equipo de TI todo el día!\nEn este post, te mostraré lo que necesitas saber para integrar el SD-WAN Manager con ServiceNow para la gestión de incidentes. Veremos algunos de los problemas más comunes en SD-WAN.\nConfiguración de laboratorio Estoy utilizando la versión 20.12.1 de SD-WAN Manager y tengo una instancia de desarrollador de ServiceNow. Mi servidor de Webhook funciona en Ubuntu 20.04 LTS y construí el receptor de Webhook en lenguaje Go.\nPara simplificar las cosas, tengo comunicación directa entre todos los elementos de mi laboratorio.\nWebhooks Los Webhooks son una manera en que las aplicaciones web se comunican entre sí en tiempo real. Permiten que una aplicación envíe notificaciones automáticas a otra aplicación cuando ocurre un evento específico, lo que se conoce como el modelo push. Esto facilita la integración entre diferentes sistemas y puede usarse para activar actividades automatizadas posteriores. Los Webhooks típicamente utilizan callbacks HTTP para compartir notificaciones/información.\nEn nuestro escenario, el SD-WAN Manager monitoreará eventos en BR10 y enviará solicitudes HTTP POST a nuestro servidor de Webhook cuando ocurran eventos específicos. Esto nos permitirá gestionar los incidentes en ServiceNow.\nAnatomía de una notificación webhook Comprendamos la estructura y la información que el SD-WAN Manager compartirá con nuestro servidor Webhook.\nEste es un ejemplo de la información enviada cuando alguna interfaz va abajo\n{ \"suppressed\": false, \"devices\": [ { \"system-ip\": \"1.1.10.1\" } ], \"eventname\": \"interface-state-change\", \"type\": \"interface-state-change\", \"rulename\": \"interface-state-change\", \"component\": \"VPN\", \"entry_time\": 1709277345253, \"statcycletime\": 1709277345253, \"message\": \"The interface oper-state changed to down\", \"severity\": \"Critical\", \"severity_number\": 1, \"uuid\": \"9e2f7630-d504-4cdf-b808-fc8e29a6dd47\", \"values\": [ { \"host-name\": \"BR10\", \"system-ip\": \"1.1.10.1\", \"if-name\": \"GigabitEthernet2\", \"new-state\": \"down\", \"vpn-id\": \"0\" } ], \"rule_name_display\": \"Interface_State_Change\", \"receive_time\": 1708843127894, \"values_short_display\": [ { \"host-name\": \"BR10\", \"system-ip\": \"1.1.10.1\", \"if-name\": \"GigabitEthernet2\", \"new-state\": \"down\" } ], \"system_ip\": \"1.1.10.1\", \"host_name\": \"BR10\", \"acknowledged\": false, \"active\": true } Veamos la información más importante para nosotros:\n\"active\": true - ¿Tenemos un problema? Sí, indicado por el estado activo \"message\": \"The interface oper...\" - ¿Qué está pasando? \"severity_number\": 1 - ¿Qué tan malo es? (escogí el numero y no el string a propósito) \"uuid\": \"9e2f7630-d504...d47\" - Identificador del evento usado por el SD-WAN Manager \"system_ip\": \"1.1.10.1\" - ¿Qué equipo originó la alerta? \"host_name\": \"BR10\" - Identificador de equipo más amigable para los humanos Veamos la notificación cuando la interfaz se va arriba\n{ \"suppressed\": false, \"devices\": [ { \"system-ip\": \"1.1.10.1\" } ], \"eventname\": \"interface-state-change\", \"type\": \"interface-state-change\", \"rulename\": \"interface-state-change\", \"component\": \"VPN\", \"entry_time\": 1709277482508, \"statcycletime\": 1709277482508, \"message\": \"The interface oper-state changed to up\", \"severity\": \"Medium\", \"severity_number\": 3, \"uuid\": \"5486325c-d189-4467-9b5a-16acb1f28ec9\", \"values\": [ { \"host-name\": \"BR10\", \"system-ip\": \"1.1.10.1\", \"if-name\": \"GigabitEthernet2\", \"new-state\": \"up\", \"vpn-id\": \"0\" } ], \"rule_name_display\": \"Interface_State_Change\", \"receive_time\": 1708843265147, \"values_short_display\": [ { \"host-name\": \"BR10\", \"system-ip\": \"1.1.10.1\", \"if-name\": \"GigabitEthernet2\", \"new-state\": \"up\" } ], \"system_ip\": \"1.1.10.1\", \"host_name\": \"BR10\", \"acknowledged\": false, \"cleared_events\": [ \"9e2f7630-d504-4cdf-b808-fc8e29a6dd47\" ], \"active\": false } Las dos cosas más importantes son:\n\"active\": false - ya no está activo o presente \"cleared_events\": [\"9e2f7630-d504...d47]\" - ID del evento que se resuelve Una cosa que debe saber es que no todos los eventos se comportarán de la misma manera. Algunos de ellos no tendrán una entrada de cleared_events, por lo que tendríamos que manejarlos de manera diferente si queremos cerrarlos automáticamente. Otros pueden carecer de cierta información dependiendo de lo que estemos monitoreando.\nAntes de codificar cualquier tipo de aplicación, es importante saber lo que deseas monitorear y lo que obtendrás del SD-WAN Manager para que puedas manejarlo correctamente.\nConfiguración de Webhooks en SD-WAN Manager El 20.12, es muy simple configurarlos, primero habilita la configuración de notificación desde Administration \u003e Settings \u003e Alarm Notifications\nDefinamos las reglas para activar nuestros webhooks. Desde Monitor \u003e Logs \u003e Alarm notification \u003e Add Alarm Notification\nCosas que tienes que saber:\nPuedes elegir monitorear sitios o dispositivos. La severidad es crucial. Para abrir incidentes, generalmente querrás monitorear incidentes de severidad crítica o alta, y para cerrarlos necesitarás monitorear severidades más bajas. Las alarmas para las que deseas generar webhooks, en nuestro caso: BFD nodo fuera de servicio/activo Omp nodo fuera de servicio/activo Nodo de control fuera de servicio/activo Interfaz fuera de servicio/activa Ten en cuenta que solo estoy usando HTTP en mi URL de webhook, se recomienda usar HTTPS para mayor seguridad. El 8080:/webhook proviene de la aplicación que construimos. El threshold limitará la cantidad de notificaciones enviadas por minuto a esta URL. 15 es suficiente para mí, pero probablemente no lo sea para un entorno de producción. Por último, el usuario y la contraseña en caso de que tu aplicación de webhook lo requiera. Estos valores se codificarían y se enviarían en los encabezados. Usa valores ficticios si no son necesarios. Construyendo el servidor webhook El código que uso esta publicado en el siguiente Repo de Github, aquí lo explicaré de una manera más simple.\nPaso 1: Las solicitudes se esperan en el puerto 8080 al endpoint /webhook.\n// Listen upcoming requests http.HandleFunc(\"/webhook\", handleWebhook) fmt.Println(\"Server listening on port 8080...\") if err := http.ListenAndServe(\"0.0.0.0:8080\", nil); err != nil { fmt.Printf(\"Failed to start server: %v\", err) } Paso 2. Comprobar si la solicitudes tiene un estado activo. En caso afirmativo, creo un incidente en ServiceNow.\n//Verify if issue is active and create incident if data[\"active\"] == true { fmt.Println(\"Opening Service Now incident...\") err := createIncident(data) Paso 2.1 Para abrir un incidente en ServiceNow, necesitamos reformatear la información que se enviará allí.\nfunc createIncident(data map[string]interface{}) error { // Retrieve information to open incident issueId := data[\"uuid\"].(string) ruleName := data[\"rule_name_display\"].(string) title := data[\"message\"].(string) severity := data[\"severity_number\"].(float64) severityStr := strconv.FormatFloat(severity, 'f', -1, 64) device := \". Device \" + data[\"host_name\"].(string) + \", System-ip \" + data[\"system_ip\"].(string) // Construct JSON payload for creating incident in SNOW incidentData := map[string]interface{}{ \"category\": \"network\", \"caller_id\": \"vManage\", \"short_description\": issueId, \"description\": ruleName + \" - \" + title + device, \"urgency\": severityStr, \"impact\": severityStr, } ... Observa que almaceno el uuid proveniente de vManage y lo usamos como short_description para ServiceNow.\nPaso 3.a Si el estado no es activo, verificamos si hay algún cleared_events incluido, esto nos dará una alta precisión al cerrar incidentes.\nif _, ok := data[\"cleared_events\"]; ok { ... clearedEvents, ok := data[\"cleared_events\"].([]interface{}) eventId := clearedEvents[0].(string) incidentExists, incident_id, err := getIncidentWithId(eventId) ... if incidentExists { err := closeIncident(incident_id) Para cerrar un caso, necesitamos tener el identificador de ServiceNow llamado sys_id. Para obtenerlo, usamos la función getIncidentWithId.\nfunc getIncidentWithId(issueId string) (bool, string, error) { ... // Store Service Now \"short_description\" shortDescription, ok := incidentMap[\"short_description\"].(string) // Compare the short_description with the issueId if strings.Contains(shortDescription, issueId) { // If the short_description matches the issueId, return the incident id sys_id, ok := incidentMap[\"sys_id\"].(string) if !ok { continue } return true, sys_id, nil Paso 3.b Si el estado no es activo y no hay _cleared events_ incluidos, vamos a intentar encontrar el incidente que se abrió. Hay tres cosas que verificamos:\nRule Name - Los nombres de reglas para los eventos que estamos monitoreando tendrán la siguiente estructura _node_. Por ejemplo, BFD_Node_Down. Si estamos viendo BFD_Node_Up, cambiaremos “Up” por “Down” y buscaremos BFD_Node_Down en los incidentes devueltos desde ServiceNow. System Ip - Almacene el System-IP contenido en la notificación y coincida con la descripción de cada incidente devuelto. Time - Almaceno el opened_at y verificamos si tiene menos de 12 horas. Esta es una medida totalmente subjetiva, pero mi idea es que los problemas que tardan más de 12 horas en resolverse, tendrían que ser verificados por algún humano. func getIncidentWoutId(ruleName, sysIp string, openTime float64) (bool, string, error) { ... // IncidentMap holds the incidents from Service Now description := incidentMap[\"description\"].(string) snowTime := incidentMap[\"opened_at\"].(string) newRuleName := strings.Replace(ruleName, \"Up\", \"Down\", -1) // Compare Rule Name, system ip and time if strings.Contains(description, newRuleName) \u0026\u0026 strings.Contains(description, sysIp) \u0026\u0026 diffHours \u003c 12 { sys_id, ok := incidentMap[\"sys_id\"].(string) sys_id, ok := incidentMap[\"sys_id\"].(string) if !ok { continue } return true, sys_id, nil Paso 4. Cierra el caso con el sys_id obtenido a través de la función getIncidentWoutId.\nif incidentExists { err := closeIncident(incident_id) if err != nil { fmt.Printf(\"Error closing incident: %v\\n\", err) // Handle the error accordingly (e.g., log it, return, etc.) return } } else { fmt.Printf(\"Incident doesn't exist or is older than 12 hours\") } Demo Comenzaremos ejecutando la aplicación en Go. Nota que no estoy usando VS Code para ejecutarla (Ctrl + F5), sino la terminal para permitir las conexiones entrantes.\nNotificación de interfaz Apagamos una de las interfaces de servicio en el router:\nBR10-1#config-transaction BR10-1(config)# interface GigabitEthernet 2 BR10-1(config-if)# shutdown BR10-1(config-if)# commit Commit complete. El servidor recibe la notificación y abre el incidente. El número de incidente es el identificador ServiceNow (sys_id)\nTraigo la interfaz arriba y el incidente se cierra\nObserve que esta notificación tiene la información de cleared_events, por lo que es muy fácil encontrar ese incidente en ServiceNow. Además, la severidad es ‘Medium’, por eso es importante establecer el valor correcto en la configuración de Alarm Notifications.\nObserva que State es Resolved y Resolution Notes indica que el incidente se cerró automáticamente a través de Webhooks.\nNotificaciones de BFD y Control Connections Bajemos las sesiones de control y BFD cerrando la apagando la interfaz de transporte\nBR10-1(config)# interface GigabitEthernet 1 BR10-1(config-if)# sh BR10-1(config-if)# commit Commit complete. Se reciben notificaciones y se crean incidentes\nCuando volvemos a habilitar la interfaz, recibimos las notificaciones y también registramos el estado de la interfaz para la interfaz Gig 1 y Tunnel1. Todo esto se refleja en ServiceNow. Estas notificaciones de interfaz no fueron entregadas antes porque se perdió la conectividad con el SD-WAN Manager.\nLecciones aprendidas Es muy importante monitorear el nivel de severidad correcto, de lo contrario podríamos perder notificaciones necesarias para cerrar los incidentes adecuadamente. El SD-WAN Manager puede generar muchas alertas, por lo que el umbral del webhook se vuelve muy importante. Deberías probar para encontrar el número que funcione para tu entorno. ServiceNow asignará una prioridad en función de la urgencia e impacto utilizados para crear el ticket. ServiceNow puede tener políticas que te impidan cerrar incidentes si cierta información no está presente en la interfaz. Familiarízate un poco con las políticas en la interfaz gráfica y Data Policies. Aunque puedes establecer manualmente el “sys_id” en ServiceNow mediante APIs, sugiero dejarlo como está, ya que poner valores manuales podría causar problemas en el futuro, y este campo debe ser único en tu instancia. Te recomiendo usar el valor generado automáticamente. Puedes usar sitios públicos como este para ver fácilmente el contenido de las notificaciones mientras planificas tus casos de uso. Conclusión Los webhooks son una excelente manera de monitorear nuestro entorno. Al ser notificado exactamente cuándo ocurre un problema en lugar de confiar en encuestas continuas, aumente nuestra capacidad de iniciar sesión y reaccionar rápidamente a lo que esté sucediendo. Puede combinar webhooks con otro tipo de alertas, como correos electrónicos o incluso chat (webex, holgura, etc.) en caso de que necesite alertar a diferentes equipos. Espero que esta publicación te haya dado algunas ideas o active tu curiosidad.\n¡Gracias por leerme!\n",
  "wordCount" : "1882",
  "inLanguage": "es",
  "datePublished": "2024-03-15T18:06:34Z",
  "dateModified": "2024-03-15T18:06:34Z",
  "author":{
    "@type": "Person",
    "name": "Alex"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/rastreando-incidentes-de-sdwan-con-servicenow/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "NetWithAlex",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/assets/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/es/" accesskey="h" title="NetWithAlex (Alt + H)">NetWithAlex</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="http://localhost:1313/" title="English"
                            aria-label="English">En</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/es/" title="Inicio">
                    <span>Inicio</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/es/archives/" title="Archivo">
                    <span>Archivo</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/es/category/" title="Categorías">
                    <span>Categorías</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/es/sobre-mi/" title="Sobre mí">
                    <span>Sobre mí</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/es/search/" title="🔍">
                    <span>🔍</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/es/">Inicio</a>&nbsp;»&nbsp;<a href="http://localhost:1313/es/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Seguimiento de incidentes SD-WAN con ServiceNow
    </h1>
    <div class="post-description">
      Aprenda a integrar Cisco SD-WAN con ServiceNow y automatiza la gestión de incidentes
    </div>
    <div class="post-meta"><span title='2024-03-15 18:06:34 +0000 WET'>marzo 15, 2024</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;Alex&nbsp;|&nbsp;Traducciones:
<ul class="i18n_list">
    <li>
        <a href="http://localhost:1313/tracking-sd-wan-incidents-with-service-now/">En</a>
    </li>
</ul>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Tabla de Contenidos</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#introducci%c3%b3n" aria-label="Introducción">Introducción</a></li>
                <li>
                    <a href="#configuraci%c3%b3n-de-laboratorio" aria-label="Configuración de laboratorio">Configuración de laboratorio</a></li>
                <li>
                    <a href="#webhooks" aria-label="Webhooks">Webhooks</a><ul>
                        
                <li>
                    <a href="#anatom%c3%ada-de-una-notificaci%c3%b3n-webhook" aria-label="Anatomía de una notificación webhook">Anatomía de una notificación webhook</a></li></ul>
                </li>
                <li>
                    <a href="#configuraci%c3%b3n-de-webhooks-en-sd-wan-manager" aria-label="Configuración de Webhooks en SD-WAN Manager">Configuración de Webhooks en SD-WAN Manager</a></li>
                <li>
                    <a href="#construyendo-el-servidor-webhook" aria-label="Construyendo el servidor webhook">Construyendo el servidor webhook</a></li>
                <li>
                    <a href="#demo" aria-label="Demo">Demo</a><ul>
                        
                <li>
                    <a href="#notificaci%c3%b3n-de-interfaz" aria-label="Notificación de interfaz">Notificación de interfaz</a></li>
                <li>
                    <a href="#notificaciones-de-bfd-y-control-connections" aria-label="Notificaciones de BFD y Control Connections">Notificaciones de BFD y Control Connections</a></li></ul>
                </li>
                <li>
                    <a href="#lecciones-aprendidas" aria-label="Lecciones aprendidas">Lecciones aprendidas</a></li>
                <li>
                    <a href="#conclusi%c3%b3n" aria-label="Conclusión">Conclusión</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h3 id="introducción">Introducción<a hidden class="anchor" aria-hidden="true" href="#introducción">#</a></h3>
<p>A medida que las redes evolucionan para ofrecer una mejor experiencia de usuario y se introducen nuevas tecnologías para gestionar la red, mantener todo funcionando sin problemas se ha vuelto cada vez más difícil. Una de las responsabilidades más críticas del equipo de operaciones es hacer un seguimiento de los problemas que ocurren en toda la red. Identificarlos es solo el comienzo, luego deben ser registrados y gestionados hasta su resolución. ¡Multiplica la cantidad de acciones por incidente y tendrás suficiente para mantener ocupado a tu equipo de TI todo el día!</p>
<p>En este post, te mostraré lo que necesitas saber para integrar el SD-WAN Manager con ServiceNow para la gestión de incidentes. Veremos algunos de los problemas más comunes en SD-WAN.</p>
<h3 id="configuración-de-laboratorio">Configuración de laboratorio<a hidden class="anchor" aria-hidden="true" href="#configuración-de-laboratorio">#</a></h3>
<p>Estoy utilizando la versión 20.12.1 de SD-WAN Manager y tengo una instancia de desarrollador de ServiceNow. Mi servidor de Webhook funciona en Ubuntu 20.04 LTS y construí el receptor de Webhook en lenguaje Go.</p>
<p>Para simplificar las cosas, tengo comunicación directa entre todos los elementos de mi laboratorio.</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/03/snow-1.png"></p>
<h3 id="webhooks">Webhooks<a hidden class="anchor" aria-hidden="true" href="#webhooks">#</a></h3>
<p>Los <em>Webhooks</em> son una manera en que las aplicaciones web se comunican entre sí en tiempo real. Permiten que una aplicación envíe notificaciones automáticas a otra aplicación cuando ocurre un evento específico, lo que se conoce como el <code>modelo push</code>. Esto facilita la integración entre diferentes sistemas y puede usarse para activar actividades automatizadas posteriores. Los Webhooks típicamente utilizan callbacks HTTP para compartir notificaciones/información.</p>
<p>En nuestro escenario, el SD-WAN Manager monitoreará eventos en BR10 y enviará solicitudes HTTP POST a nuestro servidor de Webhook cuando ocurran eventos específicos. Esto nos permitirá gestionar los incidentes en ServiceNow.</p>
<h4 id="anatomía-de-una-notificación-webhook">Anatomía de una notificación webhook<a hidden class="anchor" aria-hidden="true" href="#anatomía-de-una-notificación-webhook">#</a></h4>
<p>Comprendamos la estructura y la información que el SD-WAN Manager compartirá con nuestro servidor Webhook.</p>
<p>Este es un ejemplo de la información enviada cuando alguna interfaz va <strong>abajo</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;suppressed&#34;: false,
</span></span><span style="display:flex;"><span>  &#34;devices&#34;: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      &#34;system-ip&#34;: &#34;1.1.10.1&#34;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  &#34;eventname&#34;: &#34;interface-state-change&#34;,
</span></span><span style="display:flex;"><span>  &#34;type&#34;: &#34;interface-state-change&#34;,
</span></span><span style="display:flex;"><span>  &#34;rulename&#34;: &#34;interface-state-change&#34;,
</span></span><span style="display:flex;"><span>  &#34;component&#34;: &#34;VPN&#34;,
</span></span><span style="display:flex;"><span>  &#34;entry_time&#34;: 1709277345253,
</span></span><span style="display:flex;"><span>  &#34;statcycletime&#34;: 1709277345253,
</span></span><span style="display:flex;"><span>  &#34;message&#34;: &#34;The interface oper-state changed to down&#34;,
</span></span><span style="display:flex;"><span>  &#34;severity&#34;: &#34;Critical&#34;,
</span></span><span style="display:flex;"><span>  &#34;severity_number&#34;: 1,
</span></span><span style="display:flex;"><span>  &#34;uuid&#34;: &#34;9e2f7630-d504-4cdf-b808-fc8e29a6dd47&#34;,
</span></span><span style="display:flex;"><span>  &#34;values&#34;: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      &#34;host-name&#34;: &#34;BR10&#34;,
</span></span><span style="display:flex;"><span>      &#34;system-ip&#34;: &#34;1.1.10.1&#34;,
</span></span><span style="display:flex;"><span>      &#34;if-name&#34;: &#34;GigabitEthernet2&#34;,
</span></span><span style="display:flex;"><span>      &#34;new-state&#34;: &#34;down&#34;,
</span></span><span style="display:flex;"><span>      &#34;vpn-id&#34;: &#34;0&#34;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  &#34;rule_name_display&#34;: &#34;Interface_State_Change&#34;,
</span></span><span style="display:flex;"><span>  &#34;receive_time&#34;: 1708843127894,
</span></span><span style="display:flex;"><span>  &#34;values_short_display&#34;: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      &#34;host-name&#34;: &#34;BR10&#34;,
</span></span><span style="display:flex;"><span>      &#34;system-ip&#34;: &#34;1.1.10.1&#34;,
</span></span><span style="display:flex;"><span>      &#34;if-name&#34;: &#34;GigabitEthernet2&#34;,
</span></span><span style="display:flex;"><span>      &#34;new-state&#34;: &#34;down&#34;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  &#34;system_ip&#34;: &#34;1.1.10.1&#34;,
</span></span><span style="display:flex;"><span>  &#34;host_name&#34;: &#34;BR10&#34;,
</span></span><span style="display:flex;"><span>  &#34;acknowledged&#34;: false,
</span></span><span style="display:flex;"><span>  &#34;active&#34;: true
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Veamos la información más importante para nosotros:</p>
<ul>
<li><code>&quot;active&quot;: true</code> <strong>-</strong> ¿Tenemos un problema? Sí, indicado por el estado activo</li>
<li><code>&quot;message&quot;: &quot;The interface oper...&quot;</code> <strong>-</strong> ¿Qué está pasando?</li>
<li><code>&quot;severity_number&quot;: 1 </code> <strong>-</strong> ¿Qué tan malo es? (escogí el numero y no el string a propósito)</li>
<li><code>&quot;uuid&quot;: &quot;9e2f7630-d504...d47&quot;</code> <strong>-</strong> Identificador del evento usado por el SD-WAN Manager</li>
<li><code>&quot;system_ip&quot;: &quot;1.1.10.1&quot;</code> <strong>-</strong> ¿Qué equipo originó la alerta?</li>
<li><code>&quot;host_name&quot;: &quot;BR10&quot;</code> <strong>-</strong> Identificador de equipo más amigable para los humanos</li>
</ul>
<p>Veamos la notificación cuando la interfaz se va <strong>arriba</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;suppressed&#34;: false,
</span></span><span style="display:flex;"><span>  &#34;devices&#34;: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      &#34;system-ip&#34;: &#34;1.1.10.1&#34;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  &#34;eventname&#34;: &#34;interface-state-change&#34;,
</span></span><span style="display:flex;"><span>  &#34;type&#34;: &#34;interface-state-change&#34;,
</span></span><span style="display:flex;"><span>  &#34;rulename&#34;: &#34;interface-state-change&#34;,
</span></span><span style="display:flex;"><span>  &#34;component&#34;: &#34;VPN&#34;,
</span></span><span style="display:flex;"><span>  &#34;entry_time&#34;: 1709277482508,
</span></span><span style="display:flex;"><span>  &#34;statcycletime&#34;: 1709277482508,
</span></span><span style="display:flex;"><span>  &#34;message&#34;: &#34;The interface oper-state changed to up&#34;,
</span></span><span style="display:flex;"><span>  &#34;severity&#34;: &#34;Medium&#34;,
</span></span><span style="display:flex;"><span>  &#34;severity_number&#34;: 3,
</span></span><span style="display:flex;"><span>  &#34;uuid&#34;: &#34;5486325c-d189-4467-9b5a-16acb1f28ec9&#34;,
</span></span><span style="display:flex;"><span>  &#34;values&#34;: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      &#34;host-name&#34;: &#34;BR10&#34;,
</span></span><span style="display:flex;"><span>      &#34;system-ip&#34;: &#34;1.1.10.1&#34;,
</span></span><span style="display:flex;"><span>      &#34;if-name&#34;: &#34;GigabitEthernet2&#34;,
</span></span><span style="display:flex;"><span>      &#34;new-state&#34;: &#34;up&#34;,
</span></span><span style="display:flex;"><span>      &#34;vpn-id&#34;: &#34;0&#34;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  &#34;rule_name_display&#34;: &#34;Interface_State_Change&#34;,
</span></span><span style="display:flex;"><span>  &#34;receive_time&#34;: 1708843265147,
</span></span><span style="display:flex;"><span>  &#34;values_short_display&#34;: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      &#34;host-name&#34;: &#34;BR10&#34;,
</span></span><span style="display:flex;"><span>      &#34;system-ip&#34;: &#34;1.1.10.1&#34;,
</span></span><span style="display:flex;"><span>      &#34;if-name&#34;: &#34;GigabitEthernet2&#34;,
</span></span><span style="display:flex;"><span>      &#34;new-state&#34;: &#34;up&#34;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  &#34;system_ip&#34;: &#34;1.1.10.1&#34;,
</span></span><span style="display:flex;"><span>  &#34;host_name&#34;: &#34;BR10&#34;,
</span></span><span style="display:flex;"><span>  &#34;acknowledged&#34;: false,
</span></span><span style="display:flex;"><span>  &#34;cleared_events&#34;: [
</span></span><span style="display:flex;"><span>    &#34;9e2f7630-d504-4cdf-b808-fc8e29a6dd47&#34;
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  &#34;active&#34;: false
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Las dos cosas más importantes son:</p>
<ul>
<li><code>&quot;active&quot;: false</code> <strong>-</strong>  ya no está activo o presente</li>
<li><code>&quot;cleared_events&quot;: [&quot;9e2f7630-d504...d47]&quot;</code> <strong>-</strong> ID del evento que se resuelve</li>
</ul>
<p>Una cosa que debe saber es que no todos los eventos se comportarán de la misma manera. Algunos de ellos no tendrán una entrada de <code>cleared_events</code>, por lo que tendríamos que manejarlos de manera diferente si queremos cerrarlos automáticamente. Otros pueden carecer de cierta información dependiendo de lo que estemos monitoreando.</p>
<p>Antes de codificar cualquier tipo de aplicación, es importante saber lo que deseas monitorear y lo que obtendrás del SD-WAN Manager para que puedas manejarlo correctamente.</p>
<h3 id="configuración-de-webhooks-en-sd-wan-manager">Configuración de Webhooks en SD-WAN Manager<a hidden class="anchor" aria-hidden="true" href="#configuración-de-webhooks-en-sd-wan-manager">#</a></h3>
<p>El 20.12, es muy simple configurarlos, primero habilita la configuración de notificación desde <em><code>Administration &gt; Settings &gt; Alarm Notifications</code></em></p>
<p><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-2.png"></p>
<p>Definamos las reglas para activar nuestros webhooks. Desde <em><code>Monitor &gt; Logs &gt; Alarm notification &gt; Add Alarm Notification</code></em></p>
<p><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-4.png"></p>
<p>Cosas que tienes que saber:</p>
<ul>
<li>Puedes elegir monitorear sitios o dispositivos.</li>
<li>La severidad es crucial. Para abrir incidentes, generalmente querrás monitorear incidentes de severidad crítica o alta, y para cerrarlos necesitarás monitorear severidades más bajas.</li>
<li>Las alarmas para las que deseas generar webhooks, en nuestro caso:
<ul>
<li>BFD nodo fuera de servicio/activo</li>
<li>Omp nodo fuera de servicio/activo</li>
<li>Nodo de control fuera de servicio/activo</li>
<li>Interfaz fuera de servicio/activa</li>
</ul>
</li>
<li>Ten en cuenta que solo estoy usando HTTP en mi URL de webhook, se recomienda usar HTTPS para mayor seguridad. El <code>8080:/webhook</code> proviene de la aplicación que construimos.</li>
<li>El <em>threshold</em> limitará la cantidad de notificaciones enviadas por minuto a esta URL. 15 es suficiente para mí, pero probablemente no lo sea para un entorno de producción.
Por último, el usuario y la contraseña en caso de que tu aplicación de webhook lo requiera. Estos valores se codificarían y se enviarían en los encabezados. Usa valores ficticios si no son necesarios.</li>
</ul>
<h3 id="construyendo-el-servidor-webhook">Construyendo el servidor webhook<a hidden class="anchor" aria-hidden="true" href="#construyendo-el-servidor-webhook">#</a></h3>
<p>El código que uso esta publicado en el siguiente <a href="https://github.com/aruiz-p/sdwan-snow-integraci%c3%b3n" target="_blank" rel="nofollow noopener noreferrer">Repo de Github</a>, aquí lo explicaré de una manera más simple.</p>
<p><strong>Paso 1:</strong> Las solicitudes se esperan en el puerto <code>8080</code> al endpoint <code>/webhook</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// Listen upcoming requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>http.HandleFunc(&#34;/webhook&#34;, handleWebhook)
</span></span><span style="display:flex;"><span>fmt.Println(&#34;Server listening on port 8080...&#34;)
</span></span><span style="display:flex;"><span>if err := http.ListenAndServe(&#34;0.0.0.0:8080&#34;, nil); err != nil {
</span></span><span style="display:flex;"><span>		fmt.Printf(&#34;Failed to start server: %v&#34;, err)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Paso 2.</strong> Comprobar si la solicitudes tiene un estado activo. En caso afirmativo, creo un incidente en ServiceNow.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>//Verify if issue is active and create incident
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>if data[&#34;active&#34;] == true {
</span></span><span style="display:flex;"><span>	fmt.Println(&#34;Opening Service Now incident...&#34;)
</span></span><span style="display:flex;"><span>	err := createIncident(data)
</span></span></code></pre></div><p><strong>Paso 2.1</strong> Para abrir un incidente en ServiceNow, necesitamos reformatear la información que se enviará allí.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> createIncident(data map[string]interface{}) error {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">//</span> Retrieve information to open incident
</span></span><span style="display:flex;"><span>	issueId :<span style="color:#f92672">=</span> data[<span style="color:#e6db74">&#34;uuid&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>	ruleName :<span style="color:#f92672">=</span> data[<span style="color:#e6db74">&#34;rule_name_display&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>	title :<span style="color:#f92672">=</span> data[<span style="color:#e6db74">&#34;message&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>	severity :<span style="color:#f92672">=</span> data[<span style="color:#e6db74">&#34;severity_number&#34;</span>]<span style="color:#f92672">.</span>(float64)
</span></span><span style="display:flex;"><span>	severityStr :<span style="color:#f92672">=</span> strconv<span style="color:#f92672">.</span>FormatFloat(severity, <span style="color:#e6db74">&#39;f&#39;</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>	device :<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;. Device &#34;</span> <span style="color:#f92672">+</span> data[<span style="color:#e6db74">&#34;host_name&#34;</span>]<span style="color:#f92672">.</span>(string) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;, System-ip &#34;</span> <span style="color:#f92672">+</span> data[<span style="color:#e6db74">&#34;system_ip&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">//</span> Construct JSON payload <span style="color:#66d9ef">for</span> creating incident <span style="color:#f92672">in</span> SNOW
</span></span><span style="display:flex;"><span>	incidentData :<span style="color:#f92672">=</span> map[string]interface{}{
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;category&#34;</span>:          <span style="color:#e6db74">&#34;network&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;caller_id&#34;</span>:         <span style="color:#e6db74">&#34;vManage&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;short_description&#34;</span>: issueId,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;description&#34;</span>:       ruleName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; - &#34;</span> <span style="color:#f92672">+</span> title <span style="color:#f92672">+</span> device,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;urgency&#34;</span>:           severityStr,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;impact&#34;</span>:            severityStr,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span></code></pre></div><p>Observa que almaceno el <code>uuid</code> proveniente de vManage y lo usamos como <code>short_description</code> para ServiceNow.</p>
<p><strong>Paso 3.a</strong> Si el estado <strong>no es</strong> activo, verificamos si hay algún <code>cleared_events</code> incluido, esto nos dará una alta precisión al cerrar incidentes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>if _, ok := data[&#34;cleared_events&#34;]; ok {
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	clearedEvents, ok := data[&#34;cleared_events&#34;].([]interface{})
</span></span><span style="display:flex;"><span>        eventId := clearedEvents[0].(string)
</span></span><span style="display:flex;"><span>        incidentExists, incident_id, err := getIncidentWithId(eventId)
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        if incidentExists {
</span></span><span style="display:flex;"><span>		err := closeIncident(incident_id)
</span></span></code></pre></div><p>Para cerrar un caso, necesitamos tener el identificador de ServiceNow llamado <em><strong>sys_id</strong></em>. Para obtenerlo, usamos la función <code>getIncidentWithId</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> getIncidentWithId(issueId string) (<span style="color:#a6e22e">bool</span>, string, error) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">//</span> Store Service Now <span style="color:#e6db74">&#34;short_description&#34;</span>
</span></span><span style="display:flex;"><span>        shortDescription, ok :<span style="color:#f92672">=</span> incidentMap[<span style="color:#e6db74">&#34;short_description&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">//</span> Compare the short_description with the issueId
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> strings<span style="color:#f92672">.</span>Contains(shortDescription, issueId) {
</span></span><span style="display:flex;"><span>	        <span style="color:#f92672">//</span> If the short_description matches the issueId, <span style="color:#66d9ef">return</span> the incident id
</span></span><span style="display:flex;"><span>		sys_id, ok :<span style="color:#f92672">=</span> incidentMap[<span style="color:#e6db74">&#34;sys_id&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>ok {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> true, sys_id, nil
</span></span></code></pre></div><p><strong>Paso 3.b</strong> Si el estado <strong>no es</strong> activo y no hay <code>_cleared events_</code> incluidos, vamos a intentar encontrar el incidente que se abrió. Hay tres cosas que verificamos:</p>
<ul>
<li><strong>Rule Name</strong> <strong>-</strong> Los nombres de reglas para los eventos que estamos monitoreando tendrán la siguiente estructura <feature>_node_<state>. Por ejemplo, <code>BFD_Node_Down</code>. Si estamos viendo BFD_Node_Up, cambiaremos &ldquo;Up&rdquo; por &ldquo;Down&rdquo; y buscaremos <em>BFD_Node_Down</em> en los incidentes devueltos desde ServiceNow.</li>
<li><strong>System Ip</strong> <strong>-</strong> Almacene el <code>System-IP</code> contenido en la notificación y coincida con la descripción de cada incidente devuelto.</li>
<li><strong>Time</strong> <strong>-</strong> Almaceno el <code>opened_at</code> y verificamos si tiene menos de 12 horas. Esta es una medida totalmente subjetiva, pero mi idea es que los problemas que tardan más de 12 horas en resolverse, tendrían que ser verificados por algún humano.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> getIncidentWoutId(ruleName, sysIp string, openTime float64) (<span style="color:#a6e22e">bool</span>, string, error) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">//</span> IncidentMap holds the incidents from Service Now
</span></span><span style="display:flex;"><span>      description :<span style="color:#f92672">=</span> incidentMap[<span style="color:#e6db74">&#34;description&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>      snowTime :<span style="color:#f92672">=</span> incidentMap[<span style="color:#e6db74">&#34;opened_at&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>      newRuleName :<span style="color:#f92672">=</span> strings<span style="color:#f92672">.</span>Replace(ruleName, <span style="color:#e6db74">&#34;Up&#34;</span>, <span style="color:#e6db74">&#34;Down&#34;</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">//</span> Compare Rule Name, system ip <span style="color:#f92672">and</span> time
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> strings<span style="color:#f92672">.</span>Contains(description, newRuleName) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>	      strings<span style="color:#f92672">.</span>Contains(description, sysIp) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>	      diffHours <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">12</span> {
</span></span><span style="display:flex;"><span>	      sys_id, ok :<span style="color:#f92672">=</span> incidentMap[<span style="color:#e6db74">&#34;sys_id&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>              sys_id, ok :<span style="color:#f92672">=</span> incidentMap[<span style="color:#e6db74">&#34;sys_id&#34;</span>]<span style="color:#f92672">.</span>(string)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>ok {
</span></span><span style="display:flex;"><span>	              <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>	      }
</span></span><span style="display:flex;"><span>	      <span style="color:#66d9ef">return</span> true, sys_id, nil
</span></span></code></pre></div><p><strong>Paso 4.</strong> Cierra el caso con el sys_id obtenido a través de la función <code>getIncidentWoutId</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>if incidentExists {
</span></span><span style="display:flex;"><span>	err := closeIncident(incident_id)
</span></span><span style="display:flex;"><span>	if err != nil {
</span></span><span style="display:flex;"><span>		fmt.Printf(&#34;Error closing incident: %v\n&#34;, err)
</span></span><span style="display:flex;"><span>		// Handle the error accordingly (e.g., log it, return, etc.)
</span></span><span style="display:flex;"><span>		return
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>} else {
</span></span><span style="display:flex;"><span>	fmt.Printf(&#34;Incident doesn&#39;t exist or is older than 12 hours&#34;)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="demo">Demo<a hidden class="anchor" aria-hidden="true" href="#demo">#</a></h3>
<p>Comenzaremos ejecutando la aplicación en Go. Nota que no estoy usando VS Code para ejecutarla (Ctrl + F5), sino la terminal para permitir las conexiones entrantes.</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-3.png"></p>
<h4 id="notificación-de-interfaz">Notificación de interfaz<a hidden class="anchor" aria-hidden="true" href="#notificación-de-interfaz">#</a></h4>
<p>Apagamos una de las interfaces de servicio en el router:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10-1#config-transaction
</span></span><span style="display:flex;"><span>BR10-1(config)# interface GigabitEthernet 2
</span></span><span style="display:flex;"><span>BR10-1(config-if)# shutdown
</span></span><span style="display:flex;"><span>BR10-1(config-if)# commit
</span></span><span style="display:flex;"><span>Commit complete.
</span></span></code></pre></div><p>El servidor recibe la notificación y abre el incidente. El número de incidente es el identificador ServiceNow (sys_id)</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-5-1.png"></p>
<p><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-6.png"></p>
<p>Traigo la interfaz arriba y el incidente se cierra</p>
<p><img loading="lazy" src="/WP-Content/uploads/2024/03/Webhook-7-1.png"></p>
<p><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-9.png"></p>
<p>Observe que esta notificación tiene la información de <code>cleared_events</code>, por lo que es muy fácil encontrar ese incidente en ServiceNow. Además, la severidad es &lsquo;Medium&rsquo;, por eso es importante establecer el valor correcto en la configuración de <em>Alarm Notifications</em>.</p>
<p>Observa que <em><strong>State</strong></em> es <code>Resolved</code> y <em><strong>Resolution Notes</strong></em> indica que el incidente se cerró automáticamente a través de Webhooks.</p>
<h4 id="notificaciones-de-bfd-y-control-connections">Notificaciones de BFD y Control Connections<a hidden class="anchor" aria-hidden="true" href="#notificaciones-de-bfd-y-control-connections">#</a></h4>
<p>Bajemos las sesiones de control y BFD cerrando la apagando la interfaz de transporte</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BR10-1(config)# interface GigabitEthernet 1
</span></span><span style="display:flex;"><span>BR10-1(config-if)# sh
</span></span><span style="display:flex;"><span>BR10-1(config-if)# commit
</span></span><span style="display:flex;"><span>Commit complete.
</span></span></code></pre></div><p>Se reciben notificaciones y se crean incidentes</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/03/Webhook-10.png"></p>
<p><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-11.png"></p>
<p>Cuando volvemos a habilitar la interfaz, recibimos las notificaciones y también registramos el estado de la interfaz para la interfaz Gig 1 y Tunnel1. Todo esto se refleja en ServiceNow. Estas notificaciones de interfaz no fueron entregadas antes porque se perdió la conectividad con el SD-WAN Manager.</p>
<p><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-12-1.png"></p>
<p><img loading="lazy" src="/wp-content/uploads/2024/03/webhook-1.png"></p>
<h3 id="lecciones-aprendidas">Lecciones aprendidas<a hidden class="anchor" aria-hidden="true" href="#lecciones-aprendidas">#</a></h3>
<ol>
<li>Es muy importante monitorear el nivel de severidad correcto, de lo contrario podríamos perder notificaciones necesarias para cerrar los incidentes adecuadamente.</li>
<li>El SD-WAN Manager puede generar muchas alertas, por lo que el umbral del webhook se vuelve muy importante. Deberías probar para encontrar el número que funcione para tu entorno.</li>
<li>ServiceNow asignará una <strong>prioridad</strong> en función de la urgencia e impacto utilizados para crear el ticket.</li>
<li>ServiceNow puede tener políticas que te impidan cerrar incidentes si cierta información no está presente en la interfaz. Familiarízate un poco con las políticas en la interfaz gráfica y Data Policies.</li>
<li>Aunque puedes establecer manualmente el <em>&ldquo;sys_id&rdquo;</em> en ServiceNow mediante APIs, sugiero dejarlo como está, ya que poner valores manuales podría causar problemas en el futuro, y este campo debe ser único en tu instancia. Te recomiendo usar el valor generado automáticamente.</li>
<li>Puedes usar sitios públicos <a href="https://webhook.site" target="_blank" rel="nofollow noopener noreferrer">como este</a> para ver fácilmente el contenido de las notificaciones mientras planificas tus casos de uso.</li>
</ol>
<h3 id="conclusión">Conclusión<a hidden class="anchor" aria-hidden="true" href="#conclusión">#</a></h3>
<p>Los webhooks son una excelente manera de monitorear nuestro entorno. Al ser notificado exactamente cuándo ocurre un problema en lugar de confiar en encuestas continuas, aumente nuestra capacidad de iniciar sesión y reaccionar rápidamente a lo que esté sucediendo. Puede combinar webhooks con otro tipo de alertas, como correos electrónicos o incluso chat (webex, holgura, etc.) en caso de que necesite alertar a diferentes equipos. Espero que esta publicación te haya dado algunas ideas o active tu curiosidad.</p>
<p>¡Gracias por leerme!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer><script src="https://utteranc.es/client.js"
        repo="aruiz-p/netwithalex"
        issue-term="title"
        label="comments"
        theme="preferred-color-scheme"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/es/">NetWithAlex</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copiar';

        function copyingDone() {
            copybutton.innerHTML = '¡copiado!';
            setTimeout(() => {
                copybutton.innerHTML = 'copiar';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
